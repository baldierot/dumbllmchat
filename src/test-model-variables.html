<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Model Variable Tests</title>
    <style>
        body { font-family: monospace; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        .pending { color: orange; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <h1 class="text-2xl font-bold mb-4">Model Variable Tests</h1>
    <div id="test-results" class="space-y-2"></div>

    <script type="module">
        import { WorkflowParser } from './js/workflow-parser.js';
        import { WorkflowEngine } from './js/workflow-engine.js';

        // --- MOCK API ---
        class MockChatAPI {
            getModels() {
                return [{ nickname: 'flash' }, { nickname: 'pro' }];
            }
            constructor() { this.calls = []; }
            async generateFromModel(model, messages, flags) {
                this.calls.push({ model, messages, flags });
            }
        }

        // --- TEST RUNNER ---
        const resultsContainer = document.getElementById('test-results');
        async function runTest(name, testFn) {
            const div = document.createElement('div');
            div.innerHTML = `<span class="pending">⌛</span> ${name}`;
            resultsContainer.appendChild(div);
            try {
                await testFn();
                div.innerHTML = `<span class="pass">✅</span> ${name}`;
            } catch (error) {
                console.error(`Test Failed: ${name}`, error);
                div.innerHTML = `<span class="fail">❌</span> ${name} - ${error.message}`;
            }
        }
        function assert(condition, message) {
            if (!condition) throw new Error(message || "Assertion failed");
        }

        // --- TESTS ---
        async function runAllTests() {
            await runTest("Parser: Correctly identifies a modelVariable", () => {
                const parser = new WorkflowParser();
                const script = "#step1 #PRO_MODEL: do stuff";
                const nodes = parser.parse(script);
                const node = nodes[0];
                assert(node.model === null, "Node.model should be null");
                assert(node.modelVariable === 'PRO_MODEL', "node.modelVariable was not set correctly");
            });

            await runTest("Engine: Executes workflow using a model variable", async () => {
                const api = new MockChatAPI();
                const engine = new WorkflowEngine(api);
                const script = `
#MY_MODEL = pro
#step1 #MY_MODEL: Hello
                `;

                await engine.execute(script, "");

                assert(api.calls.length === 1, "API should have been called once");
                assert(api.calls[0].model === 'pro', "The wrong model was used. Expected 'pro', got " + api.calls[0].model);
            });
            
            await runTest("Engine: Upfront validation catches undefined model variable", async () => {
                const api = new MockChatAPI();
                const engine = new WorkflowEngine(api);
                const script = `
#MY_MODEL = some_undefined_model
#step1 #MY_MODEL: Hello
                `;

                let didThrow = false;
                try {
                    await engine.execute(script, "");
                } catch(e) {
                    didThrow = e.message.includes("models are not defined: some_undefined_model");
                }
                assert(didThrow, "Engine did not throw an error for an undefined model variable.");
            });
        }

        runAllTests();
    </script>
</body>
</html>
