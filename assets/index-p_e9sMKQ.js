(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(a){if(a.ep)return;a.ep=!0;const l=n(a);fetch(a.href,l)}})();const Ie="dumbllmchat_db",Ee=2,E="messages",A="conversations";let Z;function L(){return new Promise((h,e)=>{if(Z)return h(Z);const n=indexedDB.open(Ie,Ee);n.onerror=o=>{e("Error opening IndexedDB")},n.onsuccess=o=>{Z=o.target.result,h(Z)},n.onupgradeneeded=o=>{const a=o.target.result;if(a.objectStoreNames.contains(A)||a.createObjectStore(A,{keyPath:"id",autoIncrement:!0}),!a.objectStoreNames.contains(E))a.createObjectStore(E,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const c=o.target.transaction.objectStore(E);c.indexNames.contains("conversationId")||c.createIndex("conversationId","conversationId",{unique:!1})}}})}async function xe(){const h=await L();return new Promise((e,n)=>{const l=h.transaction([A],"readonly").objectStore(A).getAll();l.onerror=c=>{n("Error getting conversations from IndexedDB")},l.onsuccess=c=>{e(c.target.result)}})}async function ue(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([A],"readwrite").objectStore(A).add(h);c.onerror=d=>{o("Error adding conversation to IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function Me(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([A],"readwrite").objectStore(A).put(h);c.onerror=d=>{o("Error updating conversation in IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function ke(h){const e=await L();return new Promise((n,o)=>{const a=e.transaction([A,E],"readwrite"),l=a.objectStore(A),c=a.objectStore(E);l.delete(h);const u=c.index("conversationId").openCursor(IDBKeyRange.only(h));u.onsuccess=p=>{const m=p.target.result;m&&(m.delete(),m.continue())},a.oncomplete=()=>{n()},a.onerror=p=>{o("Error deleting conversation from IndexedDB")}})}async function Se(h){const e=await L();return new Promise((n,o)=>{const d=e.transaction([E],"readonly").objectStore(E).index("conversationId").getAll(h);d.onerror=u=>{o("Error getting messages from IndexedDB")},d.onsuccess=u=>{n(u.target.result)}})}async function me(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([E],"readwrite").objectStore(E).add(h);c.onerror=d=>{o("Error adding message to IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function Ae(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([E],"readwrite").objectStore(E).put(h);c.onerror=d=>{o("Error updating message in IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function Pe(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([E],"readwrite").objectStore(E).delete(h);c.onerror=d=>{o("Error removing message from IndexedDB")},c.onsuccess=d=>{n()}})}async function Be(h){const e=await L();return new Promise((n,o)=>{const a=e.transaction([E],"readwrite"),d=a.objectStore(E).index("conversationId").openCursor(IDBKeyRange.only(h));d.onsuccess=u=>{const p=u.target.result;p&&(p.delete(),p.continue())},a.oncomplete=()=>{n()},a.onerror=u=>{o("Error clearing messages from IndexedDB")}})}async function Le(h){const{messages:e,...n}=h;delete n.id;const o=await ue(n);for(const a of e)delete a.id,a.conversationId=o,await me(a)}window.db={getConversations:xe,addConversation:ue,updateConversation:Me,deleteConversation:ke,getMessages:Se,addMessage:me,updateMessage:Ae,removeMessage:Pe,clearMessages:Be,importConversation:Le};function se(h){if(!h)return"";let e=h.trim();for(;e.endsWith("/");)e=e.slice(0,-1);return e?e+"/":""}class Ne{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.init()}async init(){await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(e){const n=await window.db.addConversation(e),o={...e,id:n};return this.conversations.push(o),o}async updateConversation(e){await window.db.updateConversation(e);const n=this.conversations.findIndex(o=>o.id===e.id);n!==-1&&(this.conversations[n]=e)}async deleteConversation(e){await window.db.deleteConversation(e),this.conversations=this.conversations.filter(n=>n.id!==e),this.currentConversationId===e&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(e){this.currentConversationId=e,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const e=localStorage.getItem("llm_models");return e?JSON.parse(e):[{modelName:"gemini-2.5-flash-lite",nickname:"flash-lite",apiKey:"",temperature:.7,maxOutputTokens:65536,proxy:"",system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576},{modelName:"gemini-2.5-pro",nickname:"pro",apiKey:"",temperature:.7,maxOutputTokens:65536,proxy:"",system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576}]}async fetchModelInfo(e){const{modelName:n,apiKey:o,proxy:a}=e,c=`${se(a)}https://generativelanguage.googleapis.com/v1beta/models/${n}`;try{const d=await fetch(c,{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":o,"ngrok-skip-browser-warning":"true"}});if(!d.ok)return{...e,maxTokens:0};const u=await d.json();return{...e,maxTokens:u.inputTokenLimit}}catch{return{...e,maxTokens:0}}}async fetchAndSetModels(){const e=this.getModels(),n=await Promise.all(e.map(o=>this.fetchModelInfo(o)));this.models=n}async saveModels(e){const n=e.map(o=>{const{maxTokens:a,...l}=o;return l});localStorage.setItem("llm_models",JSON.stringify(n)),await this.fetchAndSetModels()}addModel(e){this.models.push(e),this.saveModels(this.models)}updateModel(e,n){this.models[e]=n,this.saveModels(this.models)}removeModel(e){this.models.splice(e,1),this.saveModels(this.models)}getCurrentModel(){return this.models[this.currentModelIndex]}cycleModel(){return this.currentModelIndex=(this.currentModelIndex+1)%this.models.length,this.saveCurrentModelIndex(),this.getCurrentModel()}getCurrentModelIndex(){const e=localStorage.getItem("current_model_index");return e?parseInt(e,10):0}saveCurrentModelIndex(){localStorage.setItem("current_model_index",this.currentModelIndex)}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(e){return this.messages.find(n=>n.id===e)}async addMessage(e){if(!this.currentConversationId){const l=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=l.id,this.saveCurrentConversationId()}const n={...e,conversationId:this.currentConversationId},o=await window.db.addMessage(n),a={...n,id:o};return this.messages.push(a),a}async updateMessage(e,n,o){const a=await this.getMessage(e);return a.content=n,o&&(a.files=o),await window.db.updateMessage(a),a}async removeMessage(e){await window.db.removeMessage(e),this.messages=this.messages.filter(n=>n.id!==e)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async countTokens(e){const n=this.getCurrentModel(),{modelName:o,apiKey:a,proxy:l}=n,d=`${se(l)}https://generativelanguage.googleapis.com/v1beta/models/${o}:countTokens`,p={contents:e.map(m=>{const b=[{text:m.content}];return m.files&&m.files.forEach(C=>{b.push({inline_data:{mime_type:C.type,data:C.data.split(",")[1]}})}),{role:m.sender==="User"?"user":"model",parts:b}})};try{const m=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":a,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(p)});if(!m.ok){const C=await m.json().catch(()=>({}));throw new Error(`API Error: ${m.status} ${m.statusText} - ${C.error?.message||"Unknown error"}`)}return(await m.json()).totalTokens}catch(m){return console.error("Token count failed:",m),0}}async _generateContent(e){const n=this.getCurrentModel(),{modelName:o,apiKey:a,temperature:l,system_prompt:c,useGoogleSearch:d,useUrlContext:u,maxOutputTokens:p,prependSystemPrompt:m,thinkingBudget:b,proxy:C}=n;let M;const k=`${se(C)}https://generativelanguage.googleapis.com/v1beta/models/${o}:generateContent`,D=e.map(v=>{const x=[{text:v.content}];return v.files&&v.files.forEach(T=>{x.push({inline_data:{mime_type:T.type,data:T.data.split(",")[1]}})}),{role:v.sender==="User"?"user":"model",parts:x}});if(m){const v=D[D.length-1];v.role==="user"&&(v.parts[0].text=`${c}

${v.parts[0].text}`)}M={contents:D,generationConfig:{temperature:l,topK:1,topP:1,maxOutputTokens:p||2048,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]},m||(M.systemInstruction={role:"user",parts:[{text:c}]});const P=[];d&&P.push({google_search:{}}),u&&P.push({url_context:{}}),P.length>0&&(M.tools=P),b&&(M.generationConfig.thinkingConfig={thinkingBudget:b});try{const v=await fetch(k,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":a,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(M)});if(!v.ok){const $=await v.json().catch(()=>({}));throw new Error(`API Error: ${v.status} ${v.statusText} - ${$.error?.message||"Unknown error"}`)}const T=(await v.json()).candidates[0].content;return T&&T.parts?T.parts.map($=>$.text).join(""):"[The model sent an empty response.]"}catch(v){return console.error("API call failed:",v),`An error occurred: ${v.message}`}}async sendMessage(e){const o={sender:"Assistant",content:await this._generateContent(e)};return await this.addMessage(o)}async compressConversation(e,n){const o=this.conversations.find(u=>u.id===e);if(!o)throw new Error("Conversation not found");const a=await window.db.getMessages(e),l=Math.ceil(a.length/4),c=`[Compressed] ${o.name}`,d=await this.addConversation({name:c,timestamp:Date.now()});for(let u=0;u<a.length;u+=4){const p=u/4+1;n&&n(p,l);const C=`You are a Specialized Context Preservation and Compression Engine. Your primary goal is to losslessly (or near-losslessly) compress the provided multi-turn conversation history into a single, highly dense, and concise textual block. This block must function as a perfect summary and contextual anchor for a subsequent LLM to pick up the conversation as if it had access to the full original transcript.

Here is the conversation snippet:

${a.slice(u,u+4).map(k=>`${k.sender}: ${k.content}`).join(`
`)}`,N={sender:"Assistant",content:await this._generateContent([{sender:"User",content:C}]),conversationId:d.id};await window.db.addMessage(N)}return d}}window.chatAPI=new Ne;class Te{constructor(e){this.chatContainer=e}appendMessage(e){const n=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,o=this.createMessageElement(e);this.chatContainer.appendChild(o),n&&o.scrollIntoView({behavior:"smooth"})}renderMessages(e){this.clear(),e.forEach(n=>{const o=this.createMessageElement(n);this.chatContainer.appendChild(o)})}removeMessage(e){const n=this.chatContainer.querySelector(`[data-id='${e}']`);n&&n.remove()}editMessage(e){const n=this.chatContainer.querySelector(`[data-id='${e.id}']`);if(n){const o=this.createMessageElement(e);n.replaceWith(o)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(e){const n=document.createElement("div");let o="bg-gray-300 dark:bg-gray-700",a="self-start";e.sender==="User"?(o="bg-blue-500 text-white",a="self-end"):e.sender==="Error"&&(o="bg-red-500 text-white"),n.className=`p-3 rounded-lg ${o} w-full ${a} message`,n.dataset.id=e.id;const l=document.createElement("div");if(l.className="message-content",l.innerHTML=marked.parse(e.content,{breaks:!0}),n.appendChild(l),e.files&&e.files.length>0){const c=document.createElement("div");c.className="flex flex-wrap gap-2 mt-2",e.files.forEach(d=>{const u=document.createElement("div");u.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const p=document.createElement("span");p.className="mr-2 text-gray-800 dark:text-gray-200",p.style.wordBreak="break-all",p.textContent=d.name,u.appendChild(p);const m=document.createElement("button");m.textContent="â¬‡ï¸",m.className="download-file-btn",m.addEventListener("click",()=>{const b=document.createElement("a");b.href=d.data,b.download=d.name,b.click()}),u.appendChild(m),c.appendChild(u)}),n.appendChild(c)}return n.querySelectorAll("pre").forEach(c=>{const d=c.querySelector("code"),u=d.className.split("-")[1]||"",p=document.createElement("div");p.className="code-block-container";const m=document.createElement("div");m.className="code-block-header";const b=document.createElement("span");b.textContent=u,m.appendChild(b);const C=document.createElement("button");C.textContent="Copy",C.className="copy-code-btn",m.appendChild(C),p.appendChild(m),p.appendChild(c.cloneNode(!0)),c.replaceWith(p),hljs.highlightElement(p.querySelector("pre code")),C.addEventListener("click",M=>{M.stopPropagation();const N=d.innerText;navigator.clipboard.writeText(N).then(()=>{C.textContent="Copied!",setTimeout(()=>{C.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),e.sender!=="Error"&&n.addEventListener("click",c=>{const d=new CustomEvent("message-selected",{detail:{messageElement:n,x:c.clientX,y:c.clientY}});this.chatContainer.dispatchEvent(d)}),n}}window.ChatView=Te;document.addEventListener("DOMContentLoaded",()=>{const h=document.getElementById("cycle-model-btn"),e=document.getElementById("model-nickname"),n=document.getElementById("token-count-display"),o=document.getElementById("settings-btn"),a=document.getElementById("history-btn"),l=document.getElementById("chat-container"),c=document.getElementById("resize-handle"),d=document.getElementById("message-input"),u=document.getElementById("send-btn"),p=document.getElementById("settings-modal"),m=document.getElementById("llm-configs-container"),b=document.getElementById("add-model-btn"),C=document.getElementById("save-settings-btn"),M=document.getElementById("close-settings-btn"),N=document.getElementById("history-modal"),k=document.getElementById("conversations-container"),D=document.getElementById("add-conversation-btn"),P=document.getElementById("rename-conversation-btn"),v=document.getElementById("delete-conversation-btn"),x=document.getElementById("compress-conversation-btn"),T=document.getElementById("import-conversation-btn"),$=document.getElementById("export-conversation-btn"),G=document.getElementById("load-conversation-btn"),ge=document.getElementById("close-history-btn"),he=document.getElementById("clear-chat-btn"),pe=document.getElementById("import-settings-btn"),we=document.getElementById("export-settings-btn");document.getElementById("copy-chat-btn");const K=document.querySelector("footer"),ye=document.getElementById("attach-file-btn"),ee=document.getElementById("attached-files-container"),F=document.getElementById("cancel-edit-btn");let S=[],z=null,V=null,f=null,ve=K.offsetHeight;const I=new window.ChatView(l);l.addEventListener("message-selected",t=>{const{messageElement:r,x:s,y:i}=t.detail;V&&j(),V=r,fe(r,s,i)}),document.addEventListener("click",t=>{if(!document.querySelector(".message-controls"))return;const s=t.target.closest("[data-id]"),i=t.target.closest(".message-controls");!s&&!i&&j()});const fe=async(t,r,s)=>{const i=document.createElement("div");i.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const g=parseInt(t.dataset.id),y=document.createElement("button");y.textContent="âœï¸",y.addEventListener("click",async()=>{const q=await window.chatAPI.getMessage(g);d.value=q.content,S=q.files||[],z=g,U(),F.classList.remove("hidden"),u.textContent="ðŸ’¾",j(),d.focus()});const w=document.createElement("button");w.textContent="ðŸ—‘ï¸",w.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await window.chatAPI.removeMessage(g),I.removeMessage(g)),j()});const _=document.createElement("button");_.textContent="ðŸ“‹",_.addEventListener("click",()=>{navigator.clipboard.writeText(t.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),j()});const O=document.createElement("button");O.textContent="ðŸ”„ï¸",O.addEventListener("click",async()=>{const q=await window.chatAPI.getMessages(),ne=q.findIndex(Y=>Y.id===g),Ce=q[ne];let H;Ce.sender==="User"?H=q.slice(0,ne+1):H=q.slice(0,ne),await window.chatAPI.clearMessages();for(const Y of H)await window.chatAPI.addMessage(Y);const be=l.scrollTop;I.renderMessages(H),l.scrollTop=be;const de=H[H.length-1];if(de&&de.sender==="User"){j(),u.disabled=!0;const Y={sender:"Assistant",content:"...",id:-1};I.appendMessage(Y);const le=await window.chatAPI.sendMessage(H);I.removeMessage(-1),le&&I.appendMessage(le),u.disabled=!1,d.focus(),B()}}),i.appendChild(y),i.appendChild(w),i.appendChild(_),i.appendChild(O),i.style.visibility="hidden",document.body.appendChild(i);const W=i.getBoundingClientRect(),ie=window.innerWidth,ce=window.innerHeight;let X=r,Q=s;r+W.width>ie&&(X=ie-W.width-5),s+W.height>ce&&(Q=ce-W.height-5),X<0&&(X=5),Q<0&&(Q=5),i.style.left=`${X}px`,i.style.top=`${Q}px`,i.style.visibility="visible"},j=()=>{const t=document.querySelector(".message-controls");t&&t.remove(),V&&(V=null)},B=async()=>{const t=await window.chatAPI.getMessages(),r=await window.chatAPI.countTokens(t),s=window.chatAPI.getCurrentModel();n.textContent=`${r}/${s.maxTokens}`},R=async()=>{const t=await window.chatAPI.getConversations();t.reverse(),k.innerHTML="",f=null,P.disabled=!0,v.disabled=!0,G.disabled=!0,$.disabled=!0,x.disabled=!0;for(const s of t){const i=document.createElement("li");i.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",i.dataset.id=s.id;const g=document.createElement("span");g.className="truncate";let y=s.name;if(!y){const w=await window.db.getMessages(s.id);w.length>0?y=w[0].content.split(`
`)[0]:y="New Conversation"}g.textContent=y,i.appendChild(g),i.addEventListener("click",()=>{if(f!==null){const w=k.querySelector(`[data-id='${f}']`);w&&w.classList.remove("selected")}i.classList.add("selected"),f=s.id,P.disabled=!1,v.disabled=!1,G.disabled=!1,$.disabled=!1,x.disabled=!1,i.scrollIntoView({block:"nearest"})}),k.appendChild(i)}const r=k.querySelector(`[data-id='${window.chatAPI.currentConversationId}']`);r&&(r.classList.add("selected"),f=window.chatAPI.currentConversationId,P.disabled=!1,v.disabled=!1,G.disabled=!1,$.disabled=!1,x.disabled=!1,setTimeout(()=>{r.scrollIntoView({block:"nearest"})},0))};a.addEventListener("click",async()=>{await R(),N.classList.remove("hidden")}),ge.addEventListener("click",()=>{N.classList.add("hidden")}),D.addEventListener("click",async()=>{const t=await window.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await window.chatAPI.switchConversation(t.id),I.clear(),await R(),B()}),G.addEventListener("click",async()=>{if(f!==null){await window.chatAPI.switchConversation(f);const t=await window.chatAPI.getMessages();I.renderMessages(t),N.classList.add("hidden"),B();const r=I.chatContainer.lastElementChild;r&&r.scrollIntoView({behavior:"smooth"})}}),P.addEventListener("click",async()=>{if(f!==null){const t=window.chatAPI.conversations.find(s=>s.id===f),r=prompt("Enter new conversation name:",t.name);if(r&&r.trim()!==""){t.name=r,await window.chatAPI.updateConversation(t);const s=f;await R();const i=k.querySelector(`[data-id='${s}']`);i&&setTimeout(()=>{i.click(),i.scrollIntoView({block:"nearest"})},0)}}}),v.addEventListener("click",async()=>{if(f!==null&&confirm("Are you sure you want to delete this conversation?")){let t=await window.chatAPI.getConversations();t.reverse();const r=t.findIndex(g=>g.id===f);await window.chatAPI.deleteConversation(f);let s=await window.chatAPI.getConversations();if(s.reverse(),s.length>0){let g=r;g>=s.length&&(g=s.length-1),await window.chatAPI.switchConversation(s[g].id)}else await window.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const i=await window.chatAPI.getMessages();I.renderMessages(i),await R(),B()}}),x.addEventListener("click",async()=>{if(f!==null&&confirm("Are you sure you want to compress this conversation?")){x.disabled=!0,x.textContent="ðŸ“¦...";const t=(r,s)=>{x.textContent=`ðŸ“¦ ${r}/${s}`};try{await window.chatAPI.compressConversation(f,t),await R()}catch(r){alert("Error compressing conversation: "+r.message)}finally{x.disabled=!1,x.textContent="ðŸ“¦"}}}),$.addEventListener("click",async()=>{if(f!==null){const t=window.chatAPI.conversations.find(_=>_.id===f),r=await window.db.getMessages(f),s={...t,messages:r};let i=t.name;!i&&r.length>0&&(i=r[0].content.split(`
`)[0]);const g=i.replace(/[^a-z0-9]/gi,"_").toLowerCase(),y="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s,null,2)),w=document.createElement("a");w.setAttribute("href",y),w.setAttribute("download",`${g}.json`),document.body.appendChild(w),w.click(),w.remove()}}),T.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async r=>{const s=r.target.files[0],i=new FileReader;i.onload=async g=>{try{const y=g.target.result,w=JSON.parse(y);await window.db.importConversation(w),await R(),alert("Conversation imported successfully!")}catch(y){alert("Error importing conversation: "+y.message)}},i.readAsText(s)},t.click()});const J=()=>{m.innerHTML="",window.chatAPI.getModels().forEach((t,r)=>{const s=document.createElement("div");s.className="mb-4 p-4 border border-black rounded-lg dark:border-black",s.innerHTML=`
                                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">${t.nickname}</h3>
                    <button type="button" class="remove-model-btn text-xl" data-index="${r}">âž–</button>
                </div>
                <input type="text" value="${t.proxy||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Proxy URL">
                <input type="text" value="${t.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
                <input type="text" value="${t.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
                <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${t.system_prompt}</textarea>
                                <input type="text" value="${t.apiKey||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
                <input type="number" step="0.1" value="${t.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
                <input type="number" value="${t.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">

                <input type="number" value="${t.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Thinking Budget (tokens)">
                <div class="google-search-container">
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="google-search-checkbox-${r}" class="mr-2" ${t.useGoogleSearch?"checked":""}>
                        <label for="google-search-checkbox-${r}">Enable Google Search</label>
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="prepend-system-prompt-checkbox-${r}" class="mr-2" ${t.prependSystemPrompt?"checked":""}>
                        <label for="prepend-system-prompt-checkbox-${r}">Prepend System Prompt</label>
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="url-context-checkbox-${r}" class="mr-2" ${t.useUrlContext?"checked":""}>
                        <label for="url-context-checkbox-${r}">Enable URL Context</label>
                    </div>
                </div>
            `,m.appendChild(s)}),document.querySelectorAll(".remove-model-btn").forEach(t=>{t.addEventListener("click",r=>{const s=r.target.dataset.index;window.chatAPI.removeModel(s),J()})})};h.addEventListener("click",()=>{const t=window.chatAPI.cycleModel();e.textContent=t.nickname,B()}),o.addEventListener("click",()=>{J(),p.classList.remove("hidden")}),M.addEventListener("click",()=>{p.classList.add("hidden")}),b.addEventListener("click",()=>{window.chatAPI.addModel({modelName:"gemini-2.5-flash-lite",apiKey:"",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192,proxy:""}),J()}),C.addEventListener("click",async t=>{t.preventDefault();const r=Array.from(m.children).map(s=>({modelName:s.querySelector('input[placeholder="Model Name"]').value,nickname:s.querySelector('input[placeholder="Nickname"]').value,apiKey:s.querySelector('input[placeholder="API Key"]').value,temperature:parseFloat(s.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(s.querySelector('input[placeholder="Max Output Tokens"]').value,10),proxy:s.querySelector('input[placeholder="Proxy URL"]').value,system_prompt:s.querySelector("textarea").value,useGoogleSearch:s.querySelector('input[id^="google-search-checkbox-"]').checked,useUrlContext:s.querySelector('input[id^="url-context-checkbox-"]').checked,prependSystemPrompt:s.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked,thinkingBudget:parseInt(s.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)}));await window.chatAPI.saveModels(r),p.classList.add("hidden"),e.textContent=window.chatAPI.getCurrentModel().nickname,B()});const U=()=>{ee.innerHTML="",S.forEach((g,y)=>{const w=document.createElement("div");w.className="attached-file-item";const _=document.createElement("span");_.textContent=g.name,w.appendChild(_);const O=document.createElement("button");O.className="remove-file-btn",O.textContent="âŒ",O.addEventListener("click",()=>{S.splice(y,1),U()}),w.appendChild(O),ee.appendChild(w)});const i=K.querySelector(".flex-grow").scrollHeight-d.offsetHeight+90;K.offsetHeight<i&&(K.style.height=`${i}px`)};ye.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.addEventListener("change",r=>{const s=r.target.files;for(let i=0;i<s.length;i++){const g=s[i],y=new FileReader;y.onload=w=>{S.push({name:g.name,type:g.type,data:w.target.result}),U()},y.readAsDataURL(g)}}),t.click()}),u.addEventListener("click",async()=>{const t=d.value.trim();if(t||S.length>0)if(z!==null){const r=await window.chatAPI.updateMessage(z,t,S);I.editMessage(r),z=null,F.classList.add("hidden"),u.textContent="â–¶ï¸",d.value="",S=[],U()}else{const r={sender:"User",content:t,files:S},s=await window.chatAPI.addMessage(r);I.appendMessage(s),d.value="",S=[],U(),u.disabled=!0;const i={sender:"Assistant",content:"...",id:-1};I.appendMessage(i);const g=await window.chatAPI.sendMessage(await window.chatAPI.getMessages());I.removeMessage(-1),g&&I.appendMessage(g),u.disabled=!1,B()}}),F.addEventListener("click",()=>{d.value="",S=[],z=null,U(),F.classList.add("hidden"),u.textContent="â–¶ï¸"}),d.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&(t.preventDefault(),u.click())});let te=!1;const oe=t=>{te=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},ae=t=>{if(te){const r=t.clientY||t.touches&&t.touches[0].clientY;if(r===void 0)return;let s=window.innerHeight-r;const i=ve+ee.offsetHeight,g=500;s<i&&(s=i),s>g&&(s=g),K.style.height=`${s}px`}},re=()=>{te=!1,document.body.style.userSelect="",document.body.style.cursor=""};c.addEventListener("mousedown",oe),document.addEventListener("mousemove",ae),document.addEventListener("mouseup",re),c.addEventListener("touchstart",oe,{passive:!0}),document.addEventListener("touchmove",ae),document.addEventListener("touchend",re),he.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await window.chatAPI.clearMessages(),I.clear(),B())}),we.addEventListener("click",()=>{const t=window.chatAPI.getModels(),r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t,null,2)),s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(s),s.click(),s.remove()}),pe.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=r=>{const s=r.target.files[0],i=new FileReader;i.onload=g=>{try{const y=g.target.result,w=JSON.parse(y);window.chatAPI.saveModels(w),J(),e.textContent=window.chatAPI.getCurrentModel().nickname,alert("Settings imported successfully!")}catch(y){alert("Error importing settings: "+y.message)}},i.readAsText(s)},t.click()}),(async()=>{await window.chatAPI.init();const t=window.chatAPI.getCurrentModel();t?e.textContent=t.nickname:(e.textContent="No Model",u.disabled=!0);const r=await window.chatAPI.getMessages();I.renderMessages(r),B()})()});
