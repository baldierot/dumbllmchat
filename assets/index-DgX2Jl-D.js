(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const r of d.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function s(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function n(o){if(o.ep)return;o.ep=!0;const d=s(o);fetch(o.href,d)}})();const se="dumbllmchat_db",re=4,x="messages",L="conversations",$="workflows",P="apiKeyGroups";let V;function k(){return new Promise((e,t)=>{if(V)return e(V);const s=indexedDB.open(se,re);s.onerror=n=>{t("Error opening IndexedDB")},s.onsuccess=n=>{V=n.target.result,e(V)},s.onupgradeneeded=n=>{const o=n.target.result;if(o.objectStoreNames.contains(L)||o.createObjectStore(L,{keyPath:"id",autoIncrement:!0}),!o.objectStoreNames.contains(x))o.createObjectStore(x,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const r=n.target.transaction.objectStore(x);r.indexNames.contains("conversationId")||r.createIndex("conversationId","conversationId",{unique:!1})}o.objectStoreNames.contains($)||o.createObjectStore($,{keyPath:"id"}),o.objectStoreNames.contains(P)||o.createObjectStore(P,{keyPath:"id",autoIncrement:!0})}})}async function ae(){const e=await k();return new Promise((t,s)=>{const d=e.transaction([L],"readonly").objectStore(L).getAll();d.onerror=r=>{s("Error getting conversations from IndexedDB")},d.onsuccess=r=>{t(r.target.result)}})}async function Q(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([L],"readwrite").objectStore(L).add(e);r.onerror=c=>{n("Error adding conversation to IndexedDB")},r.onsuccess=c=>{s(c.target.result)}})}async function ie(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([L],"readwrite").objectStore(L).put(e);r.onerror=c=>{n("Error updating conversation in IndexedDB")},r.onsuccess=c=>{s(c.target.result)}})}async function ce(e){const t=await k();return new Promise((s,n)=>{const o=t.transaction([L,x],"readwrite"),d=o.objectStore(L),r=o.objectStore(x);d.delete(e);const g=r.index("conversationId").openCursor(IDBKeyRange.only(e));g.onsuccess=a=>{const l=a.target.result;l&&(l.delete(),l.continue())},o.oncomplete=()=>{s()},o.onerror=a=>{n("Error deleting conversation from IndexedDB")}})}async function le(e){const t=await k();return new Promise((s,n)=>{const c=t.transaction([x],"readonly").objectStore(x).index("conversationId").getAll(e);c.onerror=g=>{n("Error getting messages from IndexedDB")},c.onsuccess=g=>{s(g.target.result)}})}async function Z(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([x],"readwrite").objectStore(x).add(e);r.onerror=c=>{n("Error adding message to IndexedDB")},r.onsuccess=c=>{s(c.target.result)}})}async function de(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([x],"readwrite").objectStore(x).put(e);r.onerror=c=>{n("Error updating message in IndexedDB")},r.onsuccess=c=>{s(c.target.result)}})}async function ue(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([x],"readwrite").objectStore(x).delete(e);r.onerror=c=>{n("Error removing message from IndexedDB")},r.onsuccess=c=>{s()}})}async function me(e){const t=await k();return new Promise((s,n)=>{const o=t.transaction([x],"readwrite"),c=o.objectStore(x).index("conversationId").openCursor(IDBKeyRange.only(e));c.onsuccess=g=>{const a=g.target.result;a&&(a.delete(),a.continue())},o.oncomplete=()=>{s()},o.onerror=g=>{n("Error clearing messages from IndexedDB")}})}async function ge(e){const{messages:t,...s}=e;delete s.id;const n=await Q(s);for(const o of t)delete o.id,o.conversationId=n,await Z(o)}async function he(){const e=await k();return new Promise((t,s)=>{const d=e.transaction([$],"readonly").objectStore($).getAll();d.onerror=r=>s(`Error getting workflows: ${r.target.error}`),d.onsuccess=r=>t(r.target.result)})}async function we(e){const t=await k();return new Promise((s,n)=>{e.id||(e.id=`workflow_${Date.now()}_${Math.random().toString(36).substring(2,9)}`);const r=t.transaction([$],"readwrite").objectStore($).add(e);r.onerror=c=>n(`Error adding workflow: ${c.target.error}`),r.onsuccess=c=>s(e.id)})}async function fe(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([$],"readwrite").objectStore($).put(e);r.onerror=c=>n(`Error updating workflow: ${c.target.error}`),r.onsuccess=c=>s(c.target.result)})}async function pe(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([$],"readwrite").objectStore($).delete(e);r.onerror=c=>n(`Error deleting workflow: ${c.target.error}`),r.onsuccess=()=>s()})}async function ye(){const e=await k();return new Promise((t,s)=>{const d=e.transaction([P],"readonly").objectStore(P).getAll();d.onerror=r=>s(`Error getting API key groups: ${r.target.error}`),d.onsuccess=r=>t(r.target.result)})}async function ve(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([P],"readwrite").objectStore(P).add(e);r.onerror=c=>n(`Error adding API key group: ${c.target.error}`),r.onsuccess=c=>s(c.target.result)})}async function be(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([P],"readwrite").objectStore(P).put(e);r.onerror=c=>n(`Error updating API key group: ${c.target.error}`),r.onsuccess=c=>s(c.target.result)})}async function Ie(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([P],"readwrite").objectStore(P).delete(e);r.onerror=c=>n(`Error deleting API key group: ${c.target.error}`),r.onsuccess=()=>s()})}async function ke(e){const t=await k();return new Promise((s,n)=>{const r=t.transaction([P],"readonly").objectStore(P).get(e);r.onerror=c=>n(`Error getting API key group: ${c.target.error}`),r.onsuccess=c=>s(c.target.result)})}window.db={getConversations:ae,addConversation:Q,updateConversation:ie,deleteConversation:ce,getMessages:le,addMessage:Z,updateMessage:de,removeMessage:ue,clearMessages:me,importConversation:ge,getWorkflows:he,addWorkflow:we,updateWorkflow:fe,deleteWorkflow:pe,getApiKeyGroups:ye,addApiKeyGroup:ve,updateApiKeyGroup:be,deleteApiKeyGroup:Ie,getApiKeyGroup:ke};function Y(e){if(!e)return"";let t=e.trim();for(;t.endsWith("/");)t=t.slice(0,-1);return t?t+"/":""}class Ce{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.currentWorkflowId=null,this.proxy="",this.workflowRequestDelay=0,this.sequentialWorkflowRequests=!0,this.apiRetryDelay=200,this.init()}async init(){const t=this.getGlobalSettings();this.proxy=t.proxy||"",this.workflowRequestDelay=t.workflowRequestDelay||0,this.sequentialWorkflowRequests=t.sequentialWorkflowRequests??!0,this.apiRetryDelay=t.apiRetryDelay??200,await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),this.currentWorkflowId=localStorage.getItem("current_workflow_id"),this.currentModelIndex=this.getCurrentModelIndex(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(t){const s=await window.db.addConversation(t),n={...t,id:s};return this.conversations.push(n),n}async updateConversation(t){await window.db.updateConversation(t);const s=this.conversations.findIndex(n=>n.id===t.id);s!==-1&&(this.conversations[s]=t)}async deleteConversation(t){await window.db.deleteConversation(t),this.conversations=this.conversations.filter(s=>s.id!==t),this.currentConversationId===t&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(t){this.currentConversationId=t,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const t=localStorage.getItem("llm_models");return t?JSON.parse(t):[]}async fetchModelInfo(t){return{...t,maxTokens:t.maxOutputTokens||8192}}async fetchAndSetModels(){const t=this.getModels(),s=await Promise.all(t.map(n=>this.fetchModelInfo(n)));this.models=s}async saveModels(t){const s=t.map(n=>{const{maxTokens:o,...d}=n;return d});localStorage.setItem("llm_models",JSON.stringify(s)),await this.fetchAndSetModels()}getGlobalSettings(){const t=localStorage.getItem("global_settings");return t?JSON.parse(t):{proxy:"",workflowRequestDelay:0,sequentialWorkflowRequests:!0,apiRetryDelay:200}}saveGlobalSettings(t){localStorage.setItem("global_settings",JSON.stringify(t)),this.proxy=t.proxy||"",this.workflowRequestDelay=t.workflowRequestDelay||0,this.sequentialWorkflowRequests=t.sequentialWorkflowRequests??!0,this.apiRetryDelay=t.apiRetryDelay??200}addModel(t){this.models.push(t),this.saveModels(this.models)}updateModel(t,s){this.models[t]=s,this.saveModels(this.models)}removeModel(t){this.models.splice(t,1),this.saveModels(this.models)}getCurrentModel(){return this.currentWorkflowId==="direct"&&this.models.length>0?this.models[0]:this.models[this.currentModelIndex]}setCurrentWorkflow(t){this.currentWorkflowId=t,localStorage.setItem("current_workflow_id",t),localStorage.removeItem("current_model_index")}setCurrentModelIndex(t){this.currentModelIndex=t,this.currentWorkflowId=null,localStorage.setItem("current_model_index",t),localStorage.removeItem("current_workflow_id")}getCurrentModelIndex(){const t=localStorage.getItem("current_model_index");return t?parseInt(t,10):0}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(t){return this.messages.find(s=>s.id===t)}async addMessage(t){if(!this.currentConversationId){const d=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=d.id,this.saveCurrentConversationId()}const s={...t,conversationId:this.currentConversationId},n=await window.db.addMessage(s),o={...s,id:n};return this.messages.push(o),o}async updateMessage(t,s,n){const o=await this.getMessage(t);return o.content=s,n&&(o.files=n),await window.db.updateMessage(o),o}async removeMessage(t){await window.db.removeMessage(t),this.messages=this.messages.filter(s=>s.id!==t)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async executeRequestWithCycling(t,s,n){if(!t.apiKeyGroupId)throw new Error(`Model "${t.nickname}" has no API key group assigned.`);const o=await window.db.getApiKeyGroup(t.apiKeyGroupId),d=(o?.keys||[]).filter(a=>a);if(d.length===0)throw new Error(`API key group "${o?.name||"Unknown"}" is empty or does not exist.`);let r=null,c=null,g=0;for(;;){const a=d[g];if(g=(g+1)%d.length,n?.aborted)throw new DOMException("Aborted by user","AbortError");if(c&&Date.now()-c>6e4)throw new Error(`API requests failed for 60 seconds. Last error: ${r.message}`);try{const{endpoint:l,headers:u,body:m}=s(t,a),h=await fetch(l,{method:"POST",headers:u,body:JSON.stringify(m),signal:n});if(!h.ok){const f=await h.json().catch(()=>({}));throw h.status===403||h.status===404?new Error(`Unrecoverable API Error: ${h.status} ${h.statusText} - ${f.error?.message||"Unknown error"}`):new Error(`API Error: ${h.status} ${h.statusText} - ${f.error?.message||"Unknown error"}`)}return await h.json()}catch(l){if(l.message.startsWith("Unrecoverable"))throw l;r=l,c=Date.now(),console.warn(`API request with key ending in ...${a.slice(-4)} failed:`,l.message),await new Promise(u=>setTimeout(u,this.apiRetryDelay))}}}_buildApiRequest(t,s,n,o=[]){const{type:d,modelName:r,temperature:c,system_prompt:g,maxOutputTokens:a,prependSystemPrompt:l,thinkingBudget:u,endpoint:m}=t,h=Y(this.proxy);let f,y,b={"Content-Type":"application/json"};if(this.proxy&&(b["ngrok-skip-browser-warning"]="true"),d==="gemini"){f=`${h}https://generativelanguage.googleapis.com/v1beta/models/${r}:generateContent`,b["x-goog-api-key"]=s;let E=n.map(w=>{const S=[{text:w.content}];return w.files&&w.files.forEach(R=>{S.push({inline_data:{mime_type:R.type,data:R.data.split(",")[1]}})}),{role:w.sender==="User"?"user":"model",parts:S}});if(l&&g){const w=E[E.length-1];w.role==="user"&&(w.parts[0].text=`${g}

${w.parts[0].text}`)}y={contents:E,generationConfig:{temperature:c,topK:1,topP:1,maxOutputTokens:a||8192,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]},!l&&g&&(y.systemInstruction={role:"user",parts:[{text:g}]}),o.length>0&&(y.tools=o),u&&(y.generationConfig.thinkingConfig={thinkingBudget:u})}else if(d==="openai"){f=h+(m||"https://api.openai.com/v1/chat/completions"),b.Authorization=`Bearer ${s}`;const E=n.map(w=>({role:w.sender==="User"?"user":"assistant",content:w.content}));g&&E.unshift({role:"system",content:g}),y={model:r,messages:E,temperature:c,max_tokens:a||2048},t.reasoningEffort&&(y.include_reasoning=!0,y.reasoning_effort=t.reasoningEffort)}else throw new Error(`Unsupported model type: ${d}`);return{endpoint:f,headers:b,body:y}}async _generateContent(t,s){const n=this.getCurrentModel(),o=[];n.useGoogleSearch&&o.push({google_search:{}}),n.useUrlContext&&o.push({url_context:{}});const d=(c,g)=>this._buildApiRequest(c,g,t,o),r=await this.executeRequestWithCycling(n,d,s);if(n.type==="gemini"){if(!r.candidates||r.candidates.length===0){const g=r.promptFeedback?.blockReason;return g?`[The model blocked the response. Reason: ${g}]`:"[The model sent an empty response.]"}const c=r.candidates[0].content;return c?.parts?c.parts.map(g=>g.text).join(""):"[The model sent an empty response.]"}else if(n.type==="openai")return r.choices?.[0]?.message?.content||"[The model sent an empty response.]";return"[An unknown error occurred]"}async sendMessage(t){const n={sender:"Assistant",content:await this._generateContent(t)};return await this.addMessage(n)}async generateFromModel(t,s,n=[],o){const d=this.models.find(a=>a.nickname.toLowerCase()===t.toLowerCase());if(!d)throw new Error(`Model with nickname "${t}" not found.`);const r=[];n.includes("google")&&r.push({google_search:{}}),n.includes("urlcontext")&&r.push({url_context:{}});const c=(a,l)=>this._buildApiRequest(a,l,s,r),g=await this.executeRequestWithCycling(d,c,o);if(d.type==="gemini"){if(!g.candidates||g.candidates.length===0){const l=g.promptFeedback?.blockReason;return l?`[The model blocked the response. Reason: ${l}]`:"[The model sent an empty response.]"}const a=g.candidates[0].content;return a?.parts?a.parts.map(l=>l.text).join(""):"[The model sent an empty response.]"}else if(d.type==="openai")return g.choices?.[0]?.message?.content||"[The model sent an empty response.]";return"[An unknown error occurred]"}async countTokens(t){const s=this.getCurrentModel();if(s.type==="openai"){const o=t.map(d=>d.content).join(" ");return Math.ceil(o.length/4)}const n=(o,d)=>{const{modelName:r}=o,g=`${Y(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${r}:countTokens`,a={"Content-Type":"application/json","x-goog-api-key":d};this.proxy&&(a["ngrok-skip-browser-warning"]="true");const l={contents:t.map(u=>({role:u.sender==="User"?"user":"model",parts:[{text:u.content}]}))};return{endpoint:g,headers:a,body:l}};try{return(await this.executeRequestWithCycling(s,n)).totalTokens}catch(o){return console.error("Token count failed:",o),0}}async compressConversation(t,s,n){if(n?.aborted)return;const o=this.conversations.find(l=>l.id===t);if(!o)throw new Error("Conversation not found");const d=await window.db.getMessages(t);if(d.length===0)throw new Error("Cannot compress an empty conversation.");const r=Math.ceil(d.length/8),c=`[Compressed] ${o.name}`,g=await this.addConversation({name:c,timestamp:Date.now()}),a=async()=>{await this.deleteConversation(g.id),n.removeEventListener("abort",a)};n?.addEventListener("abort",a);for(let l=0;l<d.length;l+=8){if(n?.aborted)throw new DOMException("Aborted by user","AbortError");s&&s(l/8+1,r);const h=`... [your compression prompt] ...

${d.slice(l,l+8).map(y=>`${y.sender}: ${y.content}`).join(`
`)}`,f=await this._generateContent([{sender:"User",content:h}],n);if(!f||f.trim()===""||f.includes("empty response"))throw new Error("Compression failed for a chunk.");await window.db.addMessage({sender:"Assistant",content:f,conversationId:g.id})}return n?.removeEventListener("abort",a),g}}window.chatAPI=new Ce;class Ee{constructor(t){this.chatContainer=t}appendMessage(t){const s=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,n=this.createMessageElement(t);this.chatContainer.appendChild(n),s&&n.scrollIntoView({behavior:"smooth"})}renderMessages(t){this.clear(),t.forEach(s=>{const n=this.createMessageElement(s);this.chatContainer.appendChild(n)})}removeMessage(t){const s=this.chatContainer.querySelector(`[data-id='${t}']`);s&&s.remove()}editMessage(t){const s=this.chatContainer.querySelector(`[data-id='${t.id}']`);if(s){const n=this.createMessageElement(t);s.replaceWith(n)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(t){const s=document.createElement("div");let n="bg-gray-300 dark:bg-gray-700",o="self-start";t.sender==="User"?(n="bg-blue-500 text-white",o="self-end"):t.sender==="Error"&&(n="bg-red-500 text-white"),s.className=`p-3 rounded-lg ${n} w-full ${o} message`,s.dataset.id=t.id;const d=document.createElement("div");if(d.className="message-content",d.innerHTML=marked.parse(t.content,{breaks:!0}),s.appendChild(d),t.files&&t.files.length>0){const r=document.createElement("div");r.className="flex flex-wrap gap-2 mt-2",t.files.forEach(c=>{const g=document.createElement("div");g.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const a=document.createElement("span");a.className="mr-2 text-gray-800 dark:text-gray-200",a.style.wordBreak="break-all",a.textContent=c.name,g.appendChild(a);const l=document.createElement("button");l.textContent="â¬‡ï¸",l.className="download-file-btn",l.addEventListener("click",()=>{const u=document.createElement("a");u.href=c.data,u.download=c.name,u.click()}),g.appendChild(l),r.appendChild(g)}),s.appendChild(r)}return s.querySelectorAll("pre").forEach(r=>{const c=r.querySelector("code"),g=c.className.split("-")[1]||"",a=document.createElement("div");a.className="code-block-container";const l=document.createElement("div");l.className="code-block-header";const u=document.createElement("span");u.textContent=g,l.appendChild(u);const m=document.createElement("button");m.textContent="Copy",m.className="copy-code-btn",l.appendChild(m),a.appendChild(l),a.appendChild(r.cloneNode(!0)),r.replaceWith(a),hljs.highlightElement(a.querySelector("pre code")),m.addEventListener("click",h=>{h.stopPropagation();const f=c.innerText;navigator.clipboard.writeText(f).then(()=>{m.textContent="Copied!",setTimeout(()=>{m.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),t.sender!=="Error"&&s.addEventListener("click",r=>{const c=new CustomEvent("message-selected",{detail:{messageElement:s,x:r.clientX,y:r.clientY}});this.chatContainer.dispatchEvent(c)}),s}}window.ChatView=Ee;const i={modelSelector:document.getElementById("model-selector"),tokenCountDisplay:document.getElementById("token-count-display"),settingsBtn:document.getElementById("settings-btn"),historyBtn:document.getElementById("history-btn"),chatContainer:document.getElementById("chat-container"),resizeHandle:document.getElementById("resize-handle"),messageInput:document.getElementById("message-input"),sendBtn:document.getElementById("send-btn"),settingsModal:document.getElementById("settings-modal"),llmConfigsContainer:document.getElementById("llm-configs-container"),addModelBtn:document.getElementById("add-model-btn"),closeSettingsBtn:document.getElementById("close-settings-btn"),historyModal:document.getElementById("history-modal"),conversationsContainer:document.getElementById("conversations-container"),addConversationBtn:document.getElementById("add-conversation-btn"),renameConversationBtn:document.getElementById("rename-conversation-btn"),deleteConversationBtn:document.getElementById("delete-conversation-btn"),compressConversationBtn:document.getElementById("compress-conversation-btn"),importConversationBtn:document.getElementById("import-conversation-btn"),exportConversationBtn:document.getElementById("export-conversation-btn"),loadConversationBtn:document.getElementById("load-conversation-btn"),closeHistoryBtn:document.getElementById("close-history-btn"),clearChatBtn:document.getElementById("clear-chat-btn"),importSettingsBtn:document.getElementById("import-settings-btn"),exportSettingsBtn:document.getElementById("export-settings-btn"),copyChatBtn:document.getElementById("copy-chat-btn"),footer:document.querySelector("footer"),attachFileBtn:document.getElementById("attach-file-btn"),attachedFilesContainer:document.getElementById("attached-files-container"),cancelEditBtn:document.getElementById("cancel-edit-btn"),proxyUrl:document.getElementById("proxy-url"),sequentialWorkflowRequests:document.getElementById("sequential-workflow-requests"),workflowRequestDelay:document.getElementById("workflow-request-delay"),apiRetryDelay:document.getElementById("api-retry-delay"),settingsTabs:document.getElementById("settings-tabs"),tabGlobal:document.getElementById("tab-global"),tabModels:document.getElementById("tab-models"),tabWorkflows:document.getElementById("tab-workflows"),workflowsList:document.getElementById("workflows-list"),addWorkflowBtn:document.getElementById("add-workflow-btn"),workflowEditorOverlay:document.getElementById("workflow-editor-overlay"),workflowNameInput:document.getElementById("workflow-name-input"),workflowScriptInput:document.getElementById("workflow-script-input"),workflowEditorCancelBtn:document.getElementById("workflow-editor-cancel-btn")};class xe{parse(t){const s=t.split(`
`),n=[],o=[];for(let r=0;r<s.length;r++){const c=s[r];if(c.trim()===""||c.trim().startsWith("//"))continue;const g=c.match(/^(\s*)/),a=g?g[1]:"",l=this.calculateIndentLevel(a);let u=this.parseLine(c.trim(),l);if(u){if(u.prompt.trim()==='"""'){let m="";for(r++;r<s.length;){const h=s[r];if(h.trim().endsWith('"""')){m+=h.trim().slice(0,-3);break}m+=h+`
`,r++}u.prompt=m.trim()}for(u.id=u.id||`node_${Date.now()}_${r}`,u.children=u.children||[],u.explicitDependencies=u.explicitDependencies||[],u.flags=u.flags||[];o.length>0&&o[o.length-1].indentLevel>=u.indentLevel;)o.pop();o.length>0&&o[o.length-1].children.push(u.id),o.push(u),n.push(u)}}const d=new Map(n.map(r=>[r.id,r]));return n.forEach(r=>{const c=/\{\{#(\w+)\}\}/g;let g;if(r.prompt)for(;(g=c.exec(r.prompt))!==null;)d.has(g[1])&&r.explicitDependencies.push(g[1])}),n.forEach(r=>{if(!r.children||r.children.length===0)return;const c=new Set;for(const g of r.children){const a=d.get(g);a&&a.explicitDependencies.includes(r.id)&&c.add(g)}c.size>0&&(r.children=r.children.filter(g=>!c.has(g)))}),n}calculateIndentLevel(t){const s=t.replace(/\t/g,"  ").length;return Math.floor(s/2)}parseLine(t,s){const n=t.match(/^(#[\w-]+)\s*=\s*(.*)/);if(n){const[,f,y]=n;return{id:f.substring(1),type:"static",prompt:y.trim(),indentLevel:s,flags:[]}}const o=t.indexOf(":");if(o===-1)return null;const d=t.substring(0,o).trim(),r=t.substring(o+1).trim(),c=d.split(/\s+/).filter(Boolean);let g=null,a=null,l=null,u=[],m=0;if(c[m]?.startsWith("#")&&(g=c[m].substring(1),m++),m<c.length&&!c[m].startsWith("+")){const f=c[m];f.startsWith("#")?l=f.substring(1):a=f,m++}for(;m<c.length;)c[m].startsWith("+")&&u.push(c[m].substring(1)),m++;return!g&&!a&&!l?null:{id:g,model:a,modelVariable:l,type:a||l?"llm":"static",prompt:r,indentLevel:s,flags:u}}}const A={PENDING:"PENDING",RUNNING:"RUNNING",COMPLETED:"COMPLETED",FAILED:"FAILED"};function J(e){return new Promise(t=>setTimeout(t,e))}class ee{constructor(t){this.chatAPI=t,this.parser=new xe}async execute(t,s,n=()=>{}){let o=t;const d=/^```[^\n]*\n([\s\S]*?)(?:\n```\s*)?$/,r=t.match(d);r&&r[1]&&(o=r[1]);const c=this.parser.parse(o);if(!c||c.length===0)return"";const g=this.chatAPI.getModels().map(w=>w.nickname.toLowerCase()),a=new Map(c.filter(w=>w.type==="static").map(w=>[w.id,w.prompt])),l=new Set;c.filter(w=>w.type==="llm").forEach(w=>{if(w.model)l.add(w.model.toLowerCase());else if(w.modelVariable){const S=a.get(w.modelVariable);S&&l.add(S.toLowerCase())}});const u=[...l].filter(w=>!g.includes(w));if(u.length>0)throw new Error(`Workflow aborted: The following models are not defined: ${u.join(", ")}`);new Map(c.map(w=>[w.id,w]));const m=new Map(c.map(w=>[w.id,A.PENDING])),h=new Map;let f=!0,y=-1,b=0;for(;f;){const w=c.filter(v=>{if(m.get(v.id)!==A.PENDING)return!1;const p=v.children||[],C=v.explicitDependencies||[];return[...new Set([...p,...C])].every(M=>m.get(M)===A.COMPLETED)});if(w.length===0)if(Array.from(m.values()).some(p=>p===A.PENDING||p===A.RUNNING)){if(w.length===y?b++:b=0,b>5)throw new Error("Deadlock detected: No runnable nodes found, but some nodes are still pending.")}else{f=!1;continue}y=w.length;const S=w.filter(v=>v.type==="llm"),B=w.filter(v=>v.type==="static").map(async v=>{m.set(v.id,A.RUNNING),n(`Resolving: ${v.id}`);try{let p=v.prompt.replace(/\{\{INPUT\}\}/g,s);v.explicitDependencies&&v.explicitDependencies.forEach(C=>{const I=new RegExp(`\\{\\{#${C}\\}}`,"g");p=p.replace(I,h.get(C)||"")}),h.set(v.id,p),m.set(v.id,A.COMPLETED),n(`Completed: ${v.id}`)}catch(p){throw m.set(v.id,A.FAILED),n(`Failed: ${v.id} - ${p.message}`),new Error(`Error resolving static node ${v.id}: ${p.message}`)}});if(await Promise.all(B),this.chatAPI.sequentialWorkflowRequests)for(let v=0;v<S.length;v++){this.chatAPI.workflowRequestDelay>0&&v>0&&(n(`Waiting for ${this.chatAPI.workflowRequestDelay} seconds...`),await J(this.chatAPI.workflowRequestDelay*1e3));const p=S[v];m.set(p.id,A.RUNNING);try{let C=p.model;if(p.modelVariable&&(C=h.get(p.modelVariable),!C))throw new Error(`Could not resolve model variable "${p.modelVariable}"`);n(`Running: ${p.id} (${C})`);let I=p.prompt.replace(/\{\{INPUT\}\}/g,s);const M=new Set;p.explicitDependencies&&p.explicitDependencies.forEach(q=>{const T=new RegExp(`\\{\\{#${q}\\}}`,"g");I=I.replace(T,h.get(q)),M.add(q)});const W=(p.children||[]).filter(q=>!M.has(q)).map(q=>h.get(q)).join(`

`);W&&(I=`${W}

${I}`);let N=[];p.flags&&p.flags.includes("history")?(N=await this.chatAPI.getMessages()||[],N.push({sender:"User",content:I})):N=[{sender:"User",content:I}];const z=await this.chatAPI.generateFromModel(C,N,p.flags);h.set(p.id,z),m.set(p.id,A.COMPLETED),n(`Completed: ${p.id}`)}catch(C){throw m.set(p.id,A.FAILED),n(`Failed: ${p.id} - ${C.message}`),new Error(`Error executing node ${p.id}: ${C.message}`)}}else{const v=S.map(async(p,C)=>{this.chatAPI.workflowRequestDelay>0&&(n(`Waiting for ${this.chatAPI.workflowRequestDelay}s before ${p.id}...`),await J(this.chatAPI.workflowRequestDelay*1e3)),m.set(p.id,A.RUNNING);try{let I=p.model;if(p.modelVariable&&(I=h.get(p.modelVariable),!I))throw new Error(`Could not resolve model variable "${p.modelVariable}"`);n(`Running: ${p.id} (${I})`);let M=p.prompt.replace(/\{\{INPUT\}\}/g,s);const W=new Set;p.explicitDependencies&&p.explicitDependencies.forEach(T=>{const oe=new RegExp(`\\{\\{#${T}\\}}`,"g");M=M.replace(oe,h.get(T)),W.add(T)});const N=(p.children||[]).filter(T=>!W.has(T)).map(T=>h.get(T)).join(`

`);N&&(M=`${N}

${M}`);let j=[];p.flags&&p.flags.includes("history")?(j=await this.chatAPI.getMessages()||[],j.push({sender:"User",content:M})):j=[{sender:"User",content:M}];const q=await this.chatAPI.generateFromModel(I,j,p.flags);h.set(p.id,q),m.set(p.id,A.COMPLETED),n(`Completed: ${p.id}`)}catch(I){throw m.set(p.id,A.FAILED),n(`Failed: ${p.id} - ${I.message}`),new Error(`Error executing node ${p.id}: ${I.message}`)}});await Promise.all(v)}await new Promise(v=>setTimeout(v,50))}return c.filter(w=>w.indentLevel===0&&w.type==="llm").map(w=>h.get(w.id)).join(`

`)}}function Me(e,t,s,n){const o=document.createElement("div");o.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const d=parseInt(e.dataset.id),r=document.createElement("button");r.textContent="âœï¸",r.addEventListener("click",async()=>{const y=await n.chatAPI.getMessage(d);i.messageInput.value=y.content,n.attachedFiles=y.files||[],n.editingMessageId=d,G(n),i.cancelEditBtn.classList.remove("hidden"),i.sendBtn.textContent="ðŸ’¾",O(),i.messageInput.focus()});const c=document.createElement("button");c.textContent="ðŸ—‘ï¸",c.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await n.chatAPI.removeMessage(d),n.chatView.removeMessage(d)),O()});const g=document.createElement("button");g.textContent="ðŸ“‹",g.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),O()});const a=document.createElement("button");a.textContent="ðŸ”„ï¸",a.addEventListener("click",async()=>{const y=await n.chatAPI.getMessages(),b=y.findIndex(B=>B.id===d),E=y[b];let w;E.sender==="User"?w=y.slice(0,b+1):w=y.slice(0,b),await n.chatAPI.clearMessages();for(const B of w)await n.chatAPI.addMessage(B);const S=i.chatContainer.scrollTop;n.chatView.renderMessages(w),i.chatContainer.scrollTop=S;const R=w[w.length-1];if(R&&R.sender==="User"){O(),i.sendBtn.disabled=!0;const B="temp-"+Date.now();n.chatView.appendMessage({sender:"Assistant",content:"...",id:B},!0);try{if(n.chatAPI.currentWorkflowId){const v=new ee(n.chatAPI),p=M=>ne(B,M);let C;if(n.chatAPI.currentWorkflowId==="direct")C=await v.execute(R.content,"",p);else{const W=(await window.db.getWorkflows()).find(N=>N.id===n.chatAPI.currentWorkflowId);if(!W)throw new Error("Selected workflow not found.");C=await v.execute(W.script,R.content,p)}n.chatView.removeMessage(B);const I=await n.chatAPI.addMessage({sender:"Assistant",content:C});n.chatView.appendMessage(I)}else{const v=await n.chatAPI.sendMessage(w);n.chatView.removeMessage(B),v&&n.chatView.appendMessage(v)}}catch(v){n.chatView.removeMessage(B);const p={sender:"Error",content:v.message,id:Date.now()};n.chatView.appendMessage(p)}finally{i.sendBtn.disabled=!1,n.chatAPI.currentWorkflowId||D(n.chatAPI)}}}),o.appendChild(r),o.appendChild(c),o.appendChild(g),o.appendChild(a),o.style.visibility="hidden",document.body.appendChild(o);const l=o.getBoundingClientRect(),u=window.innerWidth,m=window.innerHeight;let h=t,f=s;t+l.width>u&&(h=u-l.width-5),s+l.height>m&&(f=m-l.height-5),h<0&&(h=5),f<0&&(f=5),o.style.left=`${h}px`,o.style.top=`${f}px`,o.style.visibility="visible"}function O(){const e=document.querySelector(".message-controls");e&&e.remove()}async function D(e){const t=await e.getMessages(),s=await e.countTokens(t),n=e.getCurrentModel();i.tokenCountDisplay.textContent=`${s}/${n.maxTokens}`}async function _(e){const t=await e.chatAPI.getConversations();t.reverse(),i.conversationsContainer.innerHTML="",e.selectedConversationId=null,i.renameConversationBtn.disabled=!0,i.deleteConversationBtn.disabled=!0,i.loadConversationBtn.disabled=!0,i.exportConversationBtn.disabled=!0,i.compressConversationBtn.disabled=!0;for(const n of t){const o=document.createElement("li");o.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",o.dataset.id=n.id;const d=document.createElement("span");d.className="truncate";let r=n.name;if(!r){const c=await window.db.getMessages(n.id);c.length>0?r=c[0].content.split(`
`)[0]:r="New Conversation"}d.textContent=r,o.appendChild(d),o.addEventListener("click",()=>{if(e.selectedConversationId!==null){const c=i.conversationsContainer.querySelector(`[data-id='${e.selectedConversationId}']`);c&&c.classList.remove("selected")}o.classList.add("selected"),e.selectedConversationId=n.id,i.renameConversationBtn.disabled=!1,i.deleteConversationBtn.disabled=!1,i.loadConversationBtn.disabled=!1,i.exportConversationBtn.disabled=!1,i.compressConversationBtn.disabled=!1,o.scrollIntoView({block:"nearest"})}),i.conversationsContainer.appendChild(o)}const s=i.conversationsContainer.querySelector(`[data-id='${e.chatAPI.currentConversationId}']`);s&&(s.classList.add("selected"),e.selectedConversationId=e.chatAPI.currentConversationId,i.renameConversationBtn.disabled=!1,i.deleteConversationBtn.disabled=!1,i.loadConversationBtn.disabled=!1,i.exportConversationBtn.disabled=!1,i.compressConversationBtn.disabled=!1,setTimeout(()=>{s.scrollIntoView({block:"nearest"})},0))}async function H(e){const s=(await window.db.getApiKeyGroups()).map(n=>`<option value="${n.id}">${n.name}</option>`).join("");i.llmConfigsContainer.innerHTML="",e.getModels().forEach((n,o)=>{const d=document.createElement("div");d.className="mb-4 p-2 border border-black rounded-lg dark:border-black";const r=`
            <select class="api-key-group-selector w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-index="${o}">
                <option value="" disabled ${n.apiKeyGroupId?"":"selected"}>Select Key Group...</option>
                ${s}
            </select>
        `;d.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">${n.nickname}</h3>
                <button type="button" class="remove-model-btn text-xl" data-index="${o}">âž–</button>
            </div>
            <select class="model-type-selector w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-index="${o}">
                <option value="gemini" ${n.type==="gemini"?"selected":""}>Gemini</option>
                <option value="openai" ${n.type==="openai"?"selected":""}>OpenAI Compatible</option>
            </select>
            <input type="text" value="${n.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
            <input type="text" value="${n.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
            <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${n.system_prompt}</textarea>
            
            ${r}

            <div class="openai-config ${n.type==="openai"?"":"hidden"}">
                <input type="text" value="${n.endpoint||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600 openai-endpoint" placeholder="API Endpoint (e.g., https://api.groq.com/openai/v1/chat/completions)">
                <input type="text" value="${n.reasoningEffort||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600 openai-reasoning-effort" placeholder="Reasoning Effort (e.g., none, default, low, medium, high)">
            </div>
            <input type="number" step="0.1" value="${n.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
            <input type="number" value="${n.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">
            <input type="number" value="${n.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600 ${n.type==="openai"?"hidden":""}" placeholder="Thinking Budget (tokens)">
            <div class="google-search-container ${n.type==="openai"?"hidden":""}">
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="google-search-checkbox-${o}" class="mr-2" ${n.useGoogleSearch?"checked":""}>
                    <label for="google-search-checkbox-${o}">Enable Google Search</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="prepend-system-prompt-checkbox-${o}" class="mr-2" ${n.prependSystemPrompt?"checked":""}>
                    <label for="prepend-system-prompt-checkbox-${o}">Prepend System Prompt</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="url-context-checkbox-${o}" class="mr-2" ${n.useUrlContext?"checked":""}>
                    <label for="url-context-checkbox-${o}">Enable URL Context</label>
                </div>
            </div>
        `,i.llmConfigsContainer.appendChild(d);const c=d.querySelector(".api-key-group-selector");n.apiKeyGroupId&&(c.value=n.apiKeyGroupId)}),document.querySelectorAll(".remove-model-btn").forEach(n=>{n.addEventListener("click",o=>{const d=o.target.dataset.index;e.removeModel(d),H(e)})}),document.querySelectorAll(".model-type-selector").forEach(n=>{n.addEventListener("change",o=>{o.target.dataset.index;const d=n.closest(".mb-4"),r=d.querySelector(".openai-config"),c=d.querySelector('input[placeholder="Thinking Budget (tokens)"]'),g=d.querySelector(".google-search-container");o.target.value==="openai"?(r.classList.remove("hidden"),c.classList.add("hidden"),g.classList.add("hidden")):(r.classList.add("hidden"),c.classList.remove("hidden"),g.classList.remove("hidden"))})})}function Ae(e){const t=e.getGlobalSettings();i.proxyUrl.value=t.proxy||"",i.sequentialWorkflowRequests.checked=t.sequentialWorkflowRequests??!0,i.workflowRequestDelay.value=t.workflowRequestDelay||0,i.apiRetryDelay.value=t.apiRetryDelay??200}function G(e){i.attachedFilesContainer.innerHTML="",e.attachedFiles.forEach((d,r)=>{const c=document.createElement("div");c.className="attached-file-item";const g=document.createElement("span");g.textContent=d.name,c.appendChild(g);const a=document.createElement("button");a.className="remove-file-btn",a.textContent="âŒ",a.addEventListener("click",()=>{e.attachedFiles.splice(r,1),G(e)}),c.appendChild(a),i.attachedFilesContainer.appendChild(c)});const o=i.footer.querySelector(".flex-grow").scrollHeight-i.messageInput.offsetHeight+90;i.footer.offsetHeight<o&&(i.footer.style.height=`${o}px`)}function X(e){i.tabGlobal.classList.add("hidden"),i.tabModels.classList.add("hidden"),i.tabWorkflows.classList.add("hidden"),document.getElementById("tab-api-keys").classList.add("hidden"),i.settingsTabs.querySelectorAll("button").forEach(n=>{n.classList.remove("border-blue-500","text-blue-500"),n.classList.add("text-gray-500")});const t=i.settingsTabs.querySelector(`[data-tab="${e}"]`),s=document.getElementById(`tab-${e}`);t&&s&&(s.classList.remove("hidden"),t.classList.add("border-blue-500","text-blue-500"),t.classList.remove("text-gray-500")),e==="api-keys"&&U(),e==="models"&&H(window.chatAPI)}async function U(){const e=await window.db.getApiKeyGroups(),t=document.getElementById("api-key-groups-container");t.innerHTML="",e.forEach(s=>{const n=document.createElement("div");n.className="mb-4 p-2 border rounded-lg dark:border-gray-600",n.dataset.groupId=s.id,n.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <input type="text" value="${s.name}" class="group-name-input text-lg font-semibold bg-transparent border-b dark:border-gray-500 focus:outline-none focus:border-blue-500">
                <button type="button" class="remove-api-key-group-btn text-xl">âž–</button>
            </div>
            <div class="api-keys-list space-y-2">
                ${(s.keys||[]).map(o=>`
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${o}" class="api-key-input w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
                        <button type="button" class="remove-api-key-btn text-xl">âž–</button>
                    </div>
                `).join("")}
            </div>
            <button type="button" class="add-api-key-to-group-btn mt-2 text-sm p-2 bg-blue-500 text-white rounded-lg">Add Key</button>
        `,t.appendChild(n)})}async function K(e){const t=await window.db.getWorkflows();if(i.workflowsList.innerHTML="",!t||t.length===0){i.workflowsList.innerHTML='<p class="text-gray-500">No workflows created yet.</p>';return}t.forEach(s=>{const n=document.createElement("div");n.className="flex justify-between items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700";const o=document.createElement("span");o.textContent=s.name,n.appendChild(o);const d=document.createElement("div"),r=document.createElement("button");r.textContent="âœï¸",r.className="mr-2",r.onclick=()=>te(e,s);const c=document.createElement("button");c.textContent="ðŸ—‘ï¸",c.onclick=async()=>{confirm(`Are you sure you want to delete workflow "${s.name}"?`)&&(await window.db.deleteWorkflow(s.id),K(e))},d.appendChild(r),d.appendChild(c),n.appendChild(d),i.workflowsList.appendChild(n)})}function te(e,t=null){t?(e.editingWorkflowId=t.id,i.workflowNameInput.value=t.name,i.workflowScriptInput.value=t.script):(e.editingWorkflowId=null,i.workflowNameInput.value="",i.workflowScriptInput.value=""),i.workflowEditorOverlay.classList.remove("hidden")}async function F(e){const t=e.getModels(),s=await window.db.getWorkflows();i.modelSelector.innerHTML="";const n=document.createElement("optgroup");n.label="Workflow Mode";const o=document.createElement("option");o.value="direct_workflow",o.textContent="Workflow Mode",n.appendChild(o);const d=document.createElement("optgroup");d.label="Models",t.forEach((c,g)=>{const a=document.createElement("option");a.value=`model_${g}`,a.textContent=c.nickname,d.appendChild(a)});const r=document.createElement("optgroup");r.label="Workflows",s.forEach(c=>{const g=document.createElement("option");g.value=`workflow_${c.id}`,g.textContent=c.name,r.appendChild(g)}),i.modelSelector.appendChild(n),i.modelSelector.appendChild(d),i.modelSelector.appendChild(r),e.currentWorkflowId?i.modelSelector.value=`workflow_${e.currentWorkflowId}`:i.modelSelector.value=`model_${e.currentModelIndex}`}function ne(e,t){const s=i.chatContainer.querySelector(`[data-id="${e}"]`);if(s){const n=s.querySelector(".message-content");n&&(n.textContent=t)}}function Se(e){i.chatContainer.addEventListener("message-selected",a=>{const{messageElement:l,x:u,y:m}=a.detail;e.selectedMessage&&O(),e.selectedMessage=l,Me(l,u,m,e)}),document.addEventListener("click",a=>{if(!document.querySelector(".message-controls"))return;const u=a.target.closest("[data-id]"),m=a.target.closest(".message-controls");!u&&!m&&O()}),i.historyBtn.addEventListener("click",async()=>{await _(e),i.historyModal.classList.remove("hidden")}),i.closeHistoryBtn.addEventListener("click",()=>{i.historyModal.classList.add("hidden")}),i.addConversationBtn.addEventListener("click",async()=>{const a=await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await e.chatAPI.switchConversation(a.id),e.chatView.clear(),await _(e),D(e.chatAPI)}),i.loadConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){await e.chatAPI.switchConversation(e.selectedConversationId);const a=await e.chatAPI.getMessages();e.chatView.renderMessages(a),i.historyModal.classList.add("hidden"),D(e.chatAPI);const l=e.chatView.chatContainer.lastElementChild;l&&l.scrollIntoView({behavior:"smooth"})}}),i.renameConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const a=e.chatAPI.conversations.find(u=>u.id===e.selectedConversationId),l=prompt("Enter new conversation name:",a.name);if(l&&l.trim()!==""){a.name=l,await e.chatAPI.updateConversation(a);const u=e.selectedConversationId;await _(e);const m=i.conversationsContainer.querySelector(`[data-id='${u}']`);m&&setTimeout(()=>{m.click(),m.scrollIntoView({block:"nearest"})},0)}}}),i.deleteConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null&&confirm("Are you sure you want to delete this conversation?")){let a=await e.chatAPI.getConversations();a.reverse();const l=a.findIndex(h=>h.id===e.selectedConversationId);await e.chatAPI.deleteConversation(e.selectedConversationId);let u=await e.chatAPI.getConversations();if(u.reverse(),u.length>0){let h=l;h>=u.length&&(h=u.length-1),await e.chatAPI.switchConversation(u[h].id)}else await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const m=await e.chatAPI.getMessages();e.chatView.renderMessages(m),await _(e),D(e.chatAPI)}}),i.compressConversationBtn.addEventListener("click",async()=>{if(e.compressionController){e.compressionController.abort(),e.compressionController=null,i.compressConversationBtn.textContent="ðŸ“¦";return}if(e.selectedConversationId!==null){const a=e.chatAPI.getCurrentModel();if(confirm(`Are you sure you want to compress this conversation using ${a.modelName} (${a.nickname})?`)){e.compressionController=new AbortController;const l=e.compressionController.signal;i.compressConversationBtn.textContent="ðŸ“¦...";const u=(m,h)=>{i.compressConversationBtn.textContent=`ðŸ“¦ ${m}/${h}`};try{await e.chatAPI.compressConversation(e.selectedConversationId,u,l),await _(e)}catch(m){m.name!=="AbortError"?alert("Error compressing conversation: "+m.message):(alert("Compression cancelled."),await _(e))}finally{e.compressionController=null,i.compressConversationBtn.textContent="ðŸ“¦"}}}}),i.exportConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const a=e.chatAPI.conversations.find(b=>b.id===e.selectedConversationId),l=await window.db.getMessages(e.selectedConversationId),u={...a,messages:l};let m=a.name;!m&&l.length>0&&(m=l[0].content.split(`
`)[0]);const h=m.replace(/[^a-z0-9]/gi,"_").toLowerCase(),f="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(u,null,2)),y=document.createElement("a");y.setAttribute("href",f),y.setAttribute("download",`${h}.json`),document.body.appendChild(y),y.click(),y.remove()}}),i.importConversationBtn.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.accept=".json",a.onchange=async l=>{const u=l.target.files[0],m=new FileReader;m.onload=async h=>{try{const f=h.target.result,y=JSON.parse(f);await window.db.importConversation(y),await _(e),alert("Conversation imported successfully!")}catch(f){alert("Error importing conversation: "+f.message)}},m.readAsText(u)},a.click()}),i.modelSelector.addEventListener("change",a=>{const l=a.target.value;if(l.startsWith("model_")){const u=parseInt(l.split("_")[1]);e.chatAPI.setCurrentModelIndex(u),D(e.chatAPI),i.messageInput.classList.remove("whitespace-pre")}else if(l.startsWith("workflow_")){const u=l.substring(9);e.chatAPI.setCurrentWorkflow(u),i.tokenCountDisplay.textContent="Workflow",i.messageInput.classList.remove("whitespace-pre")}else l==="direct_workflow"&&(e.chatAPI.setCurrentWorkflow("direct"),i.tokenCountDisplay.textContent="Workflow Mode",i.messageInput.classList.add("whitespace-pre"))}),i.settingsBtn.addEventListener("click",async()=>{Ae(e.chatAPI),H(e.chatAPI),await K(e),X("global"),i.settingsModal.classList.remove("hidden")}),i.settingsTabs.addEventListener("click",a=>{const l=a.target.closest("button");l&&l.dataset.tab&&X(l.dataset.tab)}),i.closeSettingsBtn.addEventListener("click",()=>{i.settingsModal.classList.add("hidden")}),i.addModelBtn.addEventListener("click",()=>{e.chatAPI.addModel({type:"gemini",modelName:"gemini-2.5-flash-lite",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192,useGoogleSearch:!1,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576,reasoningEffort:null}),H(e.chatAPI)}),document.getElementById("add-api-key-group-btn").addEventListener("click",async()=>{await window.db.addApiKeyGroup({name:"New Key Group",keys:[]}),await U()});let t;const s=async a=>{if(!a)return;const l=parseInt(a.dataset.groupId,10),u=a.querySelector(".group-name-input").value,m=Array.from(a.querySelectorAll(".api-key-input")).map(h=>h.value.trim());await window.db.updateApiKeyGroup({id:l,name:u,keys:m})};i.settingsModal.addEventListener("click",async a=>{const l=a.target.closest("[data-group-id]");if(a.target.classList.contains("remove-api-key-group-btn")){const u=parseInt(l.dataset.groupId,10);confirm("Are you sure you want to delete this API key group?")&&(await window.db.deleteApiKeyGroup(u),await U())}if(a.target.classList.contains("add-api-key-to-group-btn")){const u=document.createElement("div");u.className="flex items-center space-x-2",u.innerHTML=`
                <input type="text" class="api-key-input w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
                <button type="button" class="remove-api-key-btn text-xl">âž–</button>
            `,l.querySelector(".api-keys-list").appendChild(u),u.querySelector("input").focus()}a.target.classList.contains("remove-api-key-btn")&&(a.target.closest(".flex.items-center.space-x-2").remove(),await s(l))}),i.settingsModal.addEventListener("input",async a=>{const l=a.target.closest("[data-group-id]");a.target.classList.contains("group-name-input")&&await s(l),a.target.classList.contains("api-key-input")&&(clearTimeout(t),t=setTimeout(()=>{s(l)},500))});const n=async a=>{const l=i.proxyUrl.value.trim(),u=parseFloat(i.workflowRequestDelay.value),m=i.sequentialWorkflowRequests.checked,h=parseInt(i.apiRetryDelay.value,10);a.saveGlobalSettings({proxy:l,workflowRequestDelay:u,sequentialWorkflowRequests:m,apiRetryDelay:h})},o=async a=>{const l=Array.from(i.llmConfigsContainer.children).map(u=>{const m=u.querySelector(".model-type-selector").value,h=u.querySelector(".api-key-group-selector").value,f={type:m,apiKeyGroupId:h?parseInt(h,10):null,modelName:u.querySelector('input[placeholder="Model Name"]').value,nickname:u.querySelector('input[placeholder="Nickname"]').value,temperature:parseFloat(u.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(u.querySelector('input[placeholder="Max Output Tokens"]').value,10),system_prompt:u.querySelector("textarea").value,prependSystemPrompt:u.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked};return m==="gemini"?(f.useGoogleSearch=u.querySelector('input[id^="google-search-checkbox-"]').checked,f.useUrlContext=u.querySelector('input[id^="url-context-checkbox-"]').checked,f.thinkingBudget=parseInt(u.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)):m==="openai"&&(f.endpoint=u.querySelector(".openai-endpoint").value,f.reasoningEffort=u.querySelector(".openai-reasoning-effort").value.trim(),f.reasoningEffort===""&&(f.reasoningEffort=null)),f});await a.saveModels(l),await F(a)};i.tabGlobal.addEventListener("change",()=>n(e.chatAPI)),i.llmConfigsContainer.addEventListener("change",()=>o(e.chatAPI)),i.addWorkflowBtn.addEventListener("click",async()=>{const l={id:await window.db.addWorkflow({name:"New Workflow",script:`#
`}),name:"New Workflow",script:`#
`};await K(e),te(e,l)}),i.workflowEditorCancelBtn.addEventListener("click",()=>{i.workflowEditorOverlay.classList.add("hidden")}),i.workflowEditorOverlay.addEventListener("input",async()=>{if(e.editingWorkflowId){const a=i.workflowNameInput.value.trim(),l=i.workflowScriptInput.value,u={id:e.editingWorkflowId,name:a,script:l};await window.db.updateWorkflow(u),await K(e),await F(e.chatAPI)}}),i.attachFileBtn.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.multiple=!0,a.addEventListener("change",l=>{const u=l.target.files;for(let m=0;m<u.length;m++){const h=u[m],f=new FileReader;f.onload=y=>{e.attachedFiles.push({name:h.name,type:h.type,data:y.target.result}),G(e)},f.readAsDataURL(h)}}),a.click()}),i.sendBtn.addEventListener("click",async()=>{const a=i.messageInput.value.trim();if(!a&&e.attachedFiles.length===0)return;if(e.editingMessageId!==null){const m=await e.chatAPI.updateMessage(e.editingMessageId,a,e.attachedFiles);e.chatView.editMessage(m),e.editingMessageId=null,i.cancelEditBtn.classList.add("hidden"),i.sendBtn.textContent="â–¶ï¸",i.messageInput.value="",e.attachedFiles=[],G(e);return}const l={sender:"User",content:a,files:e.attachedFiles},u=await e.chatAPI.addMessage(l);if(e.chatView.appendMessage(u),i.messageInput.value="",e.attachedFiles=[],G(e),i.sendBtn.disabled=!0,e.chatAPI.currentWorkflowId){const m="temp-"+Date.now();e.chatView.appendMessage({sender:"Assistant",content:"Starting workflow...",id:m},!0);try{const h=new ee(e.chatAPI),f=E=>ne(m,E);let y;if(e.chatAPI.currentWorkflowId==="direct")y=await h.execute(a,"",f);else{const w=(await window.db.getWorkflows()).find(S=>S.id===e.chatAPI.currentWorkflowId);if(!w)throw new Error("Selected workflow not found.");y=await h.execute(w.script,a,f)}e.chatView.removeMessage(m);const b=await e.chatAPI.addMessage({sender:"Assistant",content:y});e.chatView.appendMessage(b)}catch(h){e.chatView.removeMessage(m);const f={sender:"Error",content:h.message,id:Date.now()};e.chatView.appendMessage(f)}finally{i.sendBtn.disabled=!1}}else{const m={sender:"Assistant",content:"...",id:-1};e.chatView.appendMessage(m);try{const h=await e.chatAPI.sendMessage(await e.chatAPI.getMessages());e.chatView.removeMessage(-1),h&&e.chatView.appendMessage(h)}catch(h){e.chatView.removeMessage(-1);const f={sender:"Error",content:`An error occurred: ${h.message}`,id:Date.now()};e.chatView.appendMessage(f)}finally{i.sendBtn.disabled=!1,D(e.chatAPI)}}}),i.cancelEditBtn.addEventListener("click",()=>{i.messageInput.value="",e.attachedFiles=[],e.editingMessageId=null,G(e),i.cancelEditBtn.classList.add("hidden"),i.sendBtn.textContent="â–¶ï¸"}),i.messageInput.addEventListener("keydown",a=>{a.ctrlKey&&a.key==="Enter"&&(a.preventDefault(),i.sendBtn.click())});let d=!1;const r=a=>{d=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},c=a=>{if(d){const l=a.clientY||a.touches&&a.touches[0].clientY;if(l===void 0)return;let u=window.innerHeight-l;const m=e.initialFooterHeight+i.attachedFilesContainer.offsetHeight,h=500;u<m&&(u=m),u>h&&(u=h),i.footer.style.height=`${u}px`}},g=()=>{d=!1,document.body.style.userSelect="",document.body.style.cursor=""};i.resizeHandle.addEventListener("mousedown",r),document.addEventListener("mousemove",c),document.addEventListener("mouseup",g),i.resizeHandle.addEventListener("touchstart",r,{passive:!0}),document.addEventListener("touchmove",c),document.addEventListener("touchend",g),i.clearChatBtn.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await e.chatAPI.clearMessages(),e.chatView.clear(),D(e.chatAPI))}),i.exportSettingsBtn.addEventListener("click",async()=>{const a=e.chatAPI.getModels(),l=await window.db.getWorkflows(),u=await window.db.getApiKeyGroups(),h="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({models:a,workflows:l,apiKeyGroups:u},null,2)),f=document.createElement("a");f.setAttribute("href",h),f.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(f),f.click(),f.remove()}),i.importSettingsBtn.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.accept=".json",a.onchange=async l=>{const u=l.target.files[0],m=new FileReader;m.onload=async h=>{try{const f=h.target.result,y=JSON.parse(f);if(y.apiKeyGroups){const E=await window.db.getApiKeyGroups();for(const w of E)await window.db.deleteApiKeyGroup(w.id);for(const w of y.apiKeyGroups)delete w.id,await window.db.addApiKeyGroup(w)}let b=[];if(Array.isArray(y)?b=y:y.models&&(b=y.models),b.length>0&&await e.chatAPI.saveModels(b),y.workflows){const E=await window.db.getWorkflows();for(const w of E)await window.db.deleteWorkflow(w.id);for(const w of y.workflows)delete w.id,await window.db.addWorkflow(w)}await H(e.chatAPI),await F(e.chatAPI),await K(e),await U(),alert("Settings imported successfully!")}catch(f){console.error("Error importing settings:",f),alert("Error importing settings: "+f.message)}},m.readAsText(u)},a.click()})}document.addEventListener("DOMContentLoaded",async()=>{const e={attachedFiles:[],editingMessageId:null,selectedMessage:null,selectedConversationId:null,initialFooterHeight:i.footer.offsetHeight,compressionController:null,chatView:new window.ChatView(i.chatContainer),chatAPI:window.chatAPI};Se(e),await e.chatAPI.init(),e.chatAPI.getCurrentModel()||(i.sendBtn.disabled=!0),await F(e.chatAPI),e.chatAPI.currentWorkflowId?e.chatAPI.currentWorkflowId==="direct"?(i.modelSelector.value="direct_workflow",i.messageInput.classList.add("whitespace-pre"),i.tokenCountDisplay.textContent="Workflow Mode"):(i.modelSelector.value=`workflow_${e.chatAPI.currentWorkflowId}`,i.tokenCountDisplay.textContent="Workflow"):(i.modelSelector.value=`model_${e.chatAPI.currentModelIndex}`,D(e.chatAPI));const s=await e.chatAPI.getMessages();e.chatView.renderMessages(s),e.chatAPI.currentWorkflowId||D(e.chatAPI),G(e)});
