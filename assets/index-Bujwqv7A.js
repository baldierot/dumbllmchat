(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();const K="dumbllmchat_db",q=2,v="messages",p="conversations";let L;function M(){return new Promise((e,t)=>{if(L)return e(L);const n=indexedDB.open(K,q);n.onerror=s=>{t("Error opening IndexedDB")},n.onsuccess=s=>{L=s.target.result,e(L)},n.onupgradeneeded=s=>{const i=s.target.result;if(i.objectStoreNames.contains(p)||i.createObjectStore(p,{keyPath:"id",autoIncrement:!0}),!i.objectStoreNames.contains(v))i.createObjectStore(v,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const a=s.target.transaction.objectStore(v);a.indexNames.contains("conversationId")||a.createIndex("conversationId","conversationId",{unique:!1})}}})}async function H(){const e=await M();return new Promise((t,n)=>{const o=e.transaction([p],"readonly").objectStore(p).getAll();o.onerror=a=>{n("Error getting conversations from IndexedDB")},o.onsuccess=a=>{t(a.target.result)}})}async function O(e){const t=await M();return new Promise((n,s)=>{const a=t.transaction([p],"readwrite").objectStore(p).add(e);a.onerror=c=>{s("Error adding conversation to IndexedDB")},a.onsuccess=c=>{n(c.target.result)}})}async function j(e){const t=await M();return new Promise((n,s)=>{const a=t.transaction([p],"readwrite").objectStore(p).put(e);a.onerror=c=>{s("Error updating conversation in IndexedDB")},a.onsuccess=c=>{n(c.target.result)}})}async function D(e){const t=await M();return new Promise((n,s)=>{const i=t.transaction([p,v],"readwrite"),o=i.objectStore(p),a=i.objectStore(v);o.delete(e);const l=a.index("conversationId").openCursor(IDBKeyRange.only(e));l.onsuccess=d=>{const m=d.target.result;m&&(m.delete(),m.continue())},i.oncomplete=()=>{n()},i.onerror=d=>{s("Error deleting conversation from IndexedDB")}})}async function V(e){const t=await M();return new Promise((n,s)=>{const c=t.transaction([v],"readonly").objectStore(v).index("conversationId").getAll(e);c.onerror=l=>{s("Error getting messages from IndexedDB")},c.onsuccess=l=>{n(l.target.result)}})}async function $(e){const t=await M();return new Promise((n,s)=>{const a=t.transaction([v],"readwrite").objectStore(v).add(e);a.onerror=c=>{s("Error adding message to IndexedDB")},a.onsuccess=c=>{n(c.target.result)}})}async function R(e){const t=await M();return new Promise((n,s)=>{const a=t.transaction([v],"readwrite").objectStore(v).put(e);a.onerror=c=>{s("Error updating message in IndexedDB")},a.onsuccess=c=>{n(c.target.result)}})}async function F(e){const t=await M();return new Promise((n,s)=>{const a=t.transaction([v],"readwrite").objectStore(v).delete(e);a.onerror=c=>{s("Error removing message from IndexedDB")},a.onsuccess=c=>{n()}})}async function U(e){const t=await M();return new Promise((n,s)=>{const i=t.transaction([v],"readwrite"),c=i.objectStore(v).index("conversationId").openCursor(IDBKeyRange.only(e));c.onsuccess=l=>{const d=l.target.result;d&&(d.delete(),d.continue())},i.oncomplete=()=>{n()},i.onerror=l=>{s("Error clearing messages from IndexedDB")}})}async function z(e){const{messages:t,...n}=e;delete n.id;const s=await O(n);for(const i of t)delete i.id,i.conversationId=s,await $(i)}window.db={getConversations:H,addConversation:O,updateConversation:j,deleteConversation:D,getMessages:V,addMessage:$,updateMessage:R,removeMessage:F,clearMessages:U,importConversation:z};function T(e){if(!e)return"";let t=e.trim();for(;t.endsWith("/");)t=t.slice(0,-1);return t?t+"/":""}class G{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.apiKeys=[],this.proxy="",this.invalidKeys=new Map,this.init()}async init(){const t=this.getGlobalSettings();this.apiKeys=t.apiKeys||[],this.proxy=t.proxy||"",await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(t){const n=await window.db.addConversation(t),s={...t,id:n};return this.conversations.push(s),s}async updateConversation(t){await window.db.updateConversation(t);const n=this.conversations.findIndex(s=>s.id===t.id);n!==-1&&(this.conversations[n]=t)}async deleteConversation(t){await window.db.deleteConversation(t),this.conversations=this.conversations.filter(n=>n.id!==t),this.currentConversationId===t&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(t){this.currentConversationId=t,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const t=localStorage.getItem("llm_models");return t?JSON.parse(t):[{modelName:"gemini-2.5-flash-lite",nickname:"flash-lite",temperature:.7,maxOutputTokens:65536,system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576},{modelName:"gemini-2.5-pro",nickname:"pro",temperature:.7,maxOutputTokens:65536,system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576}]}async fetchModelInfo(t){const{modelName:n}=t,s=this.getApiKey();if(!s)return{...t,maxTokens:0};const o=`${T(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${n}`;try{const a=await fetch(o,{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":s,"ngrok-skip-browser-warning":"true"}});if(!a.ok)return{...t,maxTokens:0};const c=await a.json();return{...t,maxTokens:c.inputTokenLimit}}catch{return{...t,maxTokens:0}}}async fetchAndSetModels(){const t=this.getModels(),n=await Promise.all(t.map(s=>this.fetchModelInfo(s)));this.models=n}async saveModels(t){const n=t.map(s=>{const{maxTokens:i,apiKey:o,proxy:a,...c}=s;return c});localStorage.setItem("llm_models",JSON.stringify(n)),await this.fetchAndSetModels()}getGlobalSettings(){const t=localStorage.getItem("global_settings");return t?JSON.parse(t):{apiKeys:[],proxy:""}}saveGlobalSettings(t){localStorage.setItem("global_settings",JSON.stringify(t)),this.apiKeys=t.apiKeys||[],this.proxy=t.proxy||""}getApiKey(){const t=new Date().toISOString().slice(0,10);let n=this.apiKeys.filter(s=>{const i=this.invalidKeys.get(s);return!i||i!==t});return n.length===0&&(this.invalidKeys.clear(),n=this.apiKeys),n.length===0?null:n[0]}addModel(t){const{apiKey:n,proxy:s,...i}=t;this.models.push(i),this.saveModels(this.models)}updateModel(t,n){this.models[t]=n,this.saveModels(this.models)}removeModel(t){this.models.splice(t,1),this.saveModels(this.models)}getCurrentModel(){return this.models[this.currentModelIndex]}cycleModel(){return this.currentModelIndex=(this.currentModelIndex+1)%this.models.length,this.saveCurrentModelIndex(),this.getCurrentModel()}getCurrentModelIndex(){const t=localStorage.getItem("current_model_index");return t?parseInt(t,10):0}saveCurrentModelIndex(){localStorage.setItem("current_model_index",this.currentModelIndex)}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(t){return this.messages.find(n=>n.id===t)}async addMessage(t){if(!this.currentConversationId){const o=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=o.id,this.saveCurrentConversationId()}const n={...t,conversationId:this.currentConversationId},s=await window.db.addMessage(n),i={...n,id:s};return this.messages.push(i),i}async updateMessage(t,n,s){const i=await this.getMessage(t);return i.content=n,s&&(i.files=s),await window.db.updateMessage(i),i}async removeMessage(t){await window.db.removeMessage(t),this.messages=this.messages.filter(n=>n.id!==t)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async countTokens(t){const n=this.getCurrentModel(),{modelName:s}=n,i=this.getApiKey();if(!i)throw new Error("No valid API key available.");const a=`${T(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${s}:countTokens`,l={contents:t.map(d=>{const m=[{text:d.content}];return d.files&&d.files.forEach(h=>{m.push({inline_data:{mime_type:h.type,data:h.data.split(",")[1]}})}),{role:d.sender==="User"?"user":"model",parts:m}})};try{const d=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":i,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(l)});if(!d.ok){const h=await d.json().catch(()=>({})),g=new Date().toISOString().slice(0,10);throw this.invalidKeys.set(i,g),new Error(`API Error: ${d.status} ${d.statusText} - ${h.error?.message||"Unknown error"}`)}return(await d.json()).totalTokens}catch(d){console.error("Token count failed:",d);const m=new Date().toISOString().slice(0,10);return this.invalidKeys.set(i,m),0}}async _generateContent(t,n){const s=this.getCurrentModel(),{modelName:i,temperature:o,system_prompt:a,useGoogleSearch:c,useUrlContext:l,maxOutputTokens:d,prependSystemPrompt:m,thinkingBudget:h}=s,g=this.getApiKey();if(!g)throw new Error("No valid API key available.");let f;const C=`${T(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${i}:generateContent`,y=t.map(u=>{const w=[{text:u.content}];return u.files&&u.files.forEach(I=>{w.push({inline_data:{mime_type:I.type,data:I.data.split(",")[1]}})}),{role:u.sender==="User"?"user":"model",parts:w}});if(m){const u=y[y.length-1];u.role==="user"&&(u.parts[0].text=`${a}

${u.parts[0].text}`)}f={contents:y,generationConfig:{temperature:o,topK:1,topP:1,maxOutputTokens:d||2048,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]},m||(f.systemInstruction={role:"user",parts:[{text:a}]});const k=[];c&&k.push({google_search:{}}),l&&k.push({url_context:{}}),k.length>0&&(f.tools=k),h&&(f.generationConfig.thinkingConfig={thinkingBudget:h});try{const u=await fetch(C,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":g,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(f),signal:n});if(!u.ok){const E=await u.json().catch(()=>({})),P=new Date().toISOString().slice(0,10);throw this.invalidKeys.set(g,P),new Error(`API Error: ${u.status} ${u.statusText} - ${E.error?.message||"Unknown error"}`)}const w=await u.json();if(!w.candidates||w.candidates.length===0)return"[The model sent an empty response.]";const I=w.candidates[0].content;return I&&I.parts?I.parts.map(E=>E.text).join(""):"[The model sent an empty response.]"}catch(u){if(u.name!=="AbortError"){const w=new Date().toISOString().slice(0,10);this.invalidKeys.set(g,w)}throw u}}async sendMessage(t){const s={sender:"Assistant",content:await this._generateContent(t)};return await this.addMessage(s)}async compressConversation(t,n,s){if(s?.aborted)return;const i=this.conversations.find(m=>m.id===t);if(!i)throw new Error("Conversation not found");const o=await window.db.getMessages(t);if(o.length===0)throw new Error("Cannot compress an empty conversation.");const a=Math.ceil(o.length/8),c=`[Compressed] ${i.name}`,l=await this.addConversation({name:c,timestamp:Date.now()}),d=async()=>{await this.deleteConversation(l.id),s.removeEventListener("abort",d)};s?.addEventListener("abort",d);for(let m=0;m<o.length;m+=8){if(s?.aborted)throw new DOMException("Aborted by user","AbortError");const h=m/8+1;n&&n(h,a);const b=`You are a Specialized Context Preservation and Compression Engine. Your primary goal is to losslessly (or near-losslessly) compress the provided multi-turn conversation history into a single, highly dense, and concise textual block. This block must function as a perfect summary and contextual anchor for a subsequent LLM to pick up the conversation as if it had access to the full original transcript.

Your output should only contain the compressed message, with no additional commentary or explanations.

Preserve the original writing style of the conversation as much as possible in the compressed output.

If the conversation is a narrative piece, do not mention the "Assistant" or "User" roles. Otherwise, you should include them.

Here is the conversation snippet:

${o.slice(m,m+8).map(u=>`${u.sender}: ${u.content}`).join(`
`)}`,C=3;let y="";for(let u=0;u<C;u++){if(s?.aborted)throw new DOMException("Aborted by user","AbortError");if(y=await this._generateContent([{sender:"User",content:b}],s),y.trim()!==""&&y!=="[The model sent an empty response.]")break;u<C-1&&await new Promise(w=>setTimeout(w,1e3))}if(y.trim()===""||y==="[The model sent an empty response.]")throw new Error(`Compression failed for a chunk after ${C} retries.`);const k={sender:"Assistant",content:y,conversationId:l.id};await window.db.addMessage(k)}return s?.removeEventListener("abort",d),l}}window.chatAPI=new G;class Y{constructor(t){this.chatContainer=t}appendMessage(t){const n=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,s=this.createMessageElement(t);this.chatContainer.appendChild(s),n&&s.scrollIntoView({behavior:"smooth"})}renderMessages(t){this.clear(),t.forEach(n=>{const s=this.createMessageElement(n);this.chatContainer.appendChild(s)})}removeMessage(t){const n=this.chatContainer.querySelector(`[data-id='${t}']`);n&&n.remove()}editMessage(t){const n=this.chatContainer.querySelector(`[data-id='${t.id}']`);if(n){const s=this.createMessageElement(t);n.replaceWith(s)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(t){const n=document.createElement("div");let s="bg-gray-300 dark:bg-gray-700",i="self-start";t.sender==="User"?(s="bg-blue-500 text-white",i="self-end"):t.sender==="Error"&&(s="bg-red-500 text-white"),n.className=`p-3 rounded-lg ${s} w-full ${i} message`,n.dataset.id=t.id;const o=document.createElement("div");if(o.className="message-content",o.innerHTML=marked.parse(t.content,{breaks:!0}),n.appendChild(o),t.files&&t.files.length>0){const a=document.createElement("div");a.className="flex flex-wrap gap-2 mt-2",t.files.forEach(c=>{const l=document.createElement("div");l.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const d=document.createElement("span");d.className="mr-2 text-gray-800 dark:text-gray-200",d.style.wordBreak="break-all",d.textContent=c.name,l.appendChild(d);const m=document.createElement("button");m.textContent="â¬‡ï¸",m.className="download-file-btn",m.addEventListener("click",()=>{const h=document.createElement("a");h.href=c.data,h.download=c.name,h.click()}),l.appendChild(m),a.appendChild(l)}),n.appendChild(a)}return n.querySelectorAll("pre").forEach(a=>{const c=a.querySelector("code"),l=c.className.split("-")[1]||"",d=document.createElement("div");d.className="code-block-container";const m=document.createElement("div");m.className="code-block-header";const h=document.createElement("span");h.textContent=l,m.appendChild(h);const g=document.createElement("button");g.textContent="Copy",g.className="copy-code-btn",m.appendChild(g),d.appendChild(m),d.appendChild(a.cloneNode(!0)),a.replaceWith(d),hljs.highlightElement(d.querySelector("pre code")),g.addEventListener("click",f=>{f.stopPropagation();const b=c.innerText;navigator.clipboard.writeText(b).then(()=>{g.textContent="Copied!",setTimeout(()=>{g.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),t.sender!=="Error"&&n.addEventListener("click",a=>{const c=new CustomEvent("message-selected",{detail:{messageElement:n,x:a.clientX,y:a.clientY}});this.chatContainer.dispatchEvent(c)}),n}}window.ChatView=Y;const r={cycleModelBtn:document.getElementById("cycle-model-btn"),modelNickname:document.getElementById("model-nickname"),tokenCountDisplay:document.getElementById("token-count-display"),settingsBtn:document.getElementById("settings-btn"),historyBtn:document.getElementById("history-btn"),chatContainer:document.getElementById("chat-container"),resizeHandle:document.getElementById("resize-handle"),messageInput:document.getElementById("message-input"),sendBtn:document.getElementById("send-btn"),settingsModal:document.getElementById("settings-modal"),llmConfigsContainer:document.getElementById("llm-configs-container"),addModelBtn:document.getElementById("add-model-btn"),saveSettingsBtn:document.getElementById("save-settings-btn"),closeSettingsBtn:document.getElementById("close-settings-btn"),historyModal:document.getElementById("history-modal"),conversationsContainer:document.getElementById("conversations-container"),addConversationBtn:document.getElementById("add-conversation-btn"),renameConversationBtn:document.getElementById("rename-conversation-btn"),deleteConversationBtn:document.getElementById("delete-conversation-btn"),compressConversationBtn:document.getElementById("compress-conversation-btn"),importConversationBtn:document.getElementById("import-conversation-btn"),exportConversationBtn:document.getElementById("export-conversation-btn"),loadConversationBtn:document.getElementById("load-conversation-btn"),closeHistoryBtn:document.getElementById("close-history-btn"),clearChatBtn:document.getElementById("clear-chat-btn"),importSettingsBtn:document.getElementById("import-settings-btn"),exportSettingsBtn:document.getElementById("export-settings-btn"),copyChatBtn:document.getElementById("copy-chat-btn"),footer:document.querySelector("footer"),attachFileBtn:document.getElementById("attach-file-btn"),attachedFilesContainer:document.getElementById("attached-files-container"),cancelEditBtn:document.getElementById("cancel-edit-btn"),addApiKeyBtn:document.getElementById("add-api-key-btn"),proxyUrl:document.getElementById("proxy-url"),apiKeysContainer:document.getElementById("api-keys-container")};function J(e,t,n,s){const i=document.createElement("div");i.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const o=parseInt(e.dataset.id),a=document.createElement("button");a.textContent="âœï¸",a.addEventListener("click",async()=>{const C=await s.chatAPI.getMessage(o);r.messageInput.value=C.content,s.attachedFiles=C.files||[],s.editingMessageId=o,S(s),r.cancelEditBtn.classList.remove("hidden"),r.sendBtn.textContent="ðŸ’¾",A(),r.messageInput.focus()});const c=document.createElement("button");c.textContent="ðŸ—‘ï¸",c.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await s.chatAPI.removeMessage(o),s.chatView.removeMessage(o)),A()});const l=document.createElement("button");l.textContent="ðŸ“‹",l.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),A()});const d=document.createElement("button");d.textContent="ðŸ”„ï¸",d.addEventListener("click",async()=>{const C=await s.chatAPI.getMessages(),y=C.findIndex(E=>E.id===o),k=C[y];let u;k.sender==="User"?u=C.slice(0,y+1):u=C.slice(0,y),await s.chatAPI.clearMessages();for(const E of u)await s.chatAPI.addMessage(E);const w=r.chatContainer.scrollTop;s.chatView.renderMessages(u),r.chatContainer.scrollTop=w;const I=u[u.length-1];if(I&&I.sender==="User"){A(),r.sendBtn.disabled=!0;const E={sender:"Assistant",content:"...",id:-1};s.chatView.appendMessage(E);const P=await s.chatAPI.sendMessage(u);s.chatView.removeMessage(-1),P&&s.chatView.appendMessage(P),r.sendBtn.disabled=!1,r.messageInput.focus(),x(s.chatAPI)}}),i.appendChild(a),i.appendChild(c),i.appendChild(l),i.appendChild(d),i.style.visibility="hidden",document.body.appendChild(i);const m=i.getBoundingClientRect(),h=window.innerWidth,g=window.innerHeight;let f=t,b=n;t+m.width>h&&(f=h-m.width-5),n+m.height>g&&(b=g-m.height-5),f<0&&(f=5),b<0&&(b=5),i.style.left=`${f}px`,i.style.top=`${b}px`,i.style.visibility="visible"}function A(){const e=document.querySelector(".message-controls");e&&e.remove()}async function x(e){const t=await e.getMessages(),n=await e.countTokens(t),s=e.getCurrentModel();r.tokenCountDisplay.textContent=`${n}/${s.maxTokens}`}async function B(e){const t=await e.chatAPI.getConversations();t.reverse(),r.conversationsContainer.innerHTML="",e.selectedConversationId=null,r.renameConversationBtn.disabled=!0,r.deleteConversationBtn.disabled=!0,r.loadConversationBtn.disabled=!0,r.exportConversationBtn.disabled=!0,r.compressConversationBtn.disabled=!0;for(const s of t){const i=document.createElement("li");i.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",i.dataset.id=s.id;const o=document.createElement("span");o.className="truncate";let a=s.name;if(!a){const c=await window.db.getMessages(s.id);c.length>0?a=c[0].content.split(`
`)[0]:a="New Conversation"}o.textContent=a,i.appendChild(o),i.addEventListener("click",()=>{if(e.selectedConversationId!==null){const c=r.conversationsContainer.querySelector(`[data-id='${e.selectedConversationId}']`);c&&c.classList.remove("selected")}i.classList.add("selected"),e.selectedConversationId=s.id,r.renameConversationBtn.disabled=!1,r.deleteConversationBtn.disabled=!1,r.loadConversationBtn.disabled=!1,r.exportConversationBtn.disabled=!1,r.compressConversationBtn.disabled=!1,i.scrollIntoView({block:"nearest"})}),r.conversationsContainer.appendChild(i)}const n=r.conversationsContainer.querySelector(`[data-id='${e.chatAPI.currentConversationId}']`);n&&(n.classList.add("selected"),e.selectedConversationId=e.chatAPI.currentConversationId,r.renameConversationBtn.disabled=!1,r.deleteConversationBtn.disabled=!1,r.loadConversationBtn.disabled=!1,r.exportConversationBtn.disabled=!1,r.compressConversationBtn.disabled=!1,setTimeout(()=>{n.scrollIntoView({block:"nearest"})},0))}function N(e){r.llmConfigsContainer.innerHTML="",e.getModels().forEach((t,n)=>{const s=document.createElement("div");s.className="mb-4 p-2 border border-black rounded-lg dark:border-black",s.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">${t.nickname}</h3>
                <button type="button" class="remove-model-btn text-xl" data-index="${n}">âž–</button>
            </div>
            <input type="text" value="${t.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
            <input type="text" value="${t.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
            <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${t.system_prompt}</textarea>
            <input type="number" step="0.1" value="${t.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
            <input type="number" value="${t.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">
            <input type="number" value="${t.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Thinking Budget (tokens)">
            <div class="google-search-container">
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="google-search-checkbox-${n}" class="mr-2" ${t.useGoogleSearch?"checked":""}>
                    <label for="google-search-checkbox-${n}">Enable Google Search</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="prepend-system-prompt-checkbox-${n}" class="mr-2" ${t.prependSystemPrompt?"checked":""}>
                    <label for="prepend-system-prompt-checkbox-${n}">Prepend System Prompt</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="url-context-checkbox-${n}" class="mr-2" ${t.useUrlContext?"checked":""}>
                    <label for="url-context-checkbox-${n}">Enable URL Context</label>
                </div>
            </div>
        `,r.llmConfigsContainer.appendChild(s)}),document.querySelectorAll(".remove-model-btn").forEach(t=>{t.addEventListener("click",n=>{const s=n.target.dataset.index;e.removeModel(s),N(e)})})}function W(e){const t=e.getGlobalSettings();r.proxyUrl.value=t.proxy||"",r.apiKeysContainer.innerHTML="",t.apiKeys.forEach(n=>{_(n)})}function _(e=""){const t=document.createElement("div");t.className="flex items-center space-x-2";const n=document.createElement("input");n.type="text",n.value=e,n.className="api-key-input w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600",n.placeholder="API Key";const s=document.createElement("button");s.type="button",s.textContent="âž–",s.className="text-xl",s.addEventListener("click",()=>{t.remove()}),t.appendChild(n),t.appendChild(s),r.apiKeysContainer.appendChild(t)}function S(e){r.attachedFilesContainer.innerHTML="",e.attachedFiles.forEach((o,a)=>{const c=document.createElement("div");c.className="attached-file-item";const l=document.createElement("span");l.textContent=o.name,c.appendChild(l);const d=document.createElement("button");d.className="remove-file-btn",d.textContent="âŒ",d.addEventListener("click",()=>{e.attachedFiles.splice(a,1),S(e)}),c.appendChild(d),r.attachedFilesContainer.appendChild(c)});const i=r.footer.querySelector(".flex-grow").scrollHeight-r.messageInput.offsetHeight+90;r.footer.offsetHeight<i&&(r.footer.style.height=`${i}px`)}function X(e){r.chatContainer.addEventListener("message-selected",o=>{const{messageElement:a,x:c,y:l}=o.detail;e.selectedMessage&&A(),e.selectedMessage=a,J(a,c,l,e)}),document.addEventListener("click",o=>{if(!document.querySelector(".message-controls"))return;const c=o.target.closest("[data-id]"),l=o.target.closest(".message-controls");!c&&!l&&A()}),r.historyBtn.addEventListener("click",async()=>{await B(e),r.historyModal.classList.remove("hidden")}),r.closeHistoryBtn.addEventListener("click",()=>{r.historyModal.classList.add("hidden")}),r.addConversationBtn.addEventListener("click",async()=>{const o=await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await e.chatAPI.switchConversation(o.id),e.chatView.clear(),await B(e),x(e.chatAPI)}),r.loadConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){await e.chatAPI.switchConversation(e.selectedConversationId);const o=await e.chatAPI.getMessages();e.chatView.renderMessages(o),r.historyModal.classList.add("hidden"),x(e.chatAPI);const a=e.chatView.chatContainer.lastElementChild;a&&a.scrollIntoView({behavior:"smooth"})}}),r.renameConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const o=e.chatAPI.conversations.find(c=>c.id===e.selectedConversationId),a=prompt("Enter new conversation name:",o.name);if(a&&a.trim()!==""){o.name=a,await e.chatAPI.updateConversation(o);const c=e.selectedConversationId;await B(e);const l=r.conversationsContainer.querySelector(`[data-id='${c}']`);l&&setTimeout(()=>{l.click(),l.scrollIntoView({block:"nearest"})},0)}}}),r.deleteConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null&&confirm("Are you sure you want to delete this conversation?")){let o=await e.chatAPI.getConversations();o.reverse();const a=o.findIndex(d=>d.id===e.selectedConversationId);await e.chatAPI.deleteConversation(e.selectedConversationId);let c=await e.chatAPI.getConversations();if(c.reverse(),c.length>0){let d=a;d>=c.length&&(d=c.length-1),await e.chatAPI.switchConversation(c[d].id)}else await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const l=await e.chatAPI.getMessages();e.chatView.renderMessages(l),await B(e),x(e.chatAPI)}}),r.compressConversationBtn.addEventListener("click",async()=>{if(e.compressionController){e.compressionController.abort(),e.compressionController=null,r.compressConversationBtn.textContent="ðŸ“¦";return}if(e.selectedConversationId!==null){const o=e.chatAPI.getCurrentModel();if(confirm(`Are you sure you want to compress this conversation using ${o.modelName} (${o.nickname})?`)){e.compressionController=new AbortController;const a=e.compressionController.signal;r.compressConversationBtn.textContent="ðŸ“¦...";const c=(l,d)=>{r.compressConversationBtn.textContent=`ðŸ“¦ ${l}/${d}`};try{await e.chatAPI.compressConversation(e.selectedConversationId,c,a),await B(e)}catch(l){l.name!=="AbortError"?alert("Error compressing conversation: "+l.message):(alert("Compression cancelled."),await B(e))}finally{e.compressionController=null,r.compressConversationBtn.textContent="ðŸ“¦"}}}}),r.exportConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const o=e.chatAPI.conversations.find(g=>g.id===e.selectedConversationId),a=await window.db.getMessages(e.selectedConversationId),c={...o,messages:a};let l=o.name;!l&&a.length>0&&(l=a[0].content.split(`
`)[0]);const d=l.replace(/[^a-z0-9]/gi,"_").toLowerCase(),m="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(c,null,2)),h=document.createElement("a");h.setAttribute("href",m),h.setAttribute("download",`${d}.json`),document.body.appendChild(h),h.click(),h.remove()}}),r.importConversationBtn.addEventListener("click",()=>{const o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=async a=>{const c=a.target.files[0],l=new FileReader;l.onload=async d=>{try{const m=d.target.result,h=JSON.parse(m);await window.db.importConversation(h),await B(e),alert("Conversation imported successfully!")}catch(m){alert("Error importing conversation: "+m.message)}},l.readAsText(c)},o.click()}),r.cycleModelBtn.addEventListener("click",()=>{const o=e.chatAPI.cycleModel();r.modelNickname.textContent=o.nickname,x(e.chatAPI)}),r.settingsBtn.addEventListener("click",()=>{W(e.chatAPI),N(e.chatAPI),r.settingsModal.classList.remove("hidden")}),r.closeSettingsBtn.addEventListener("click",()=>{r.settingsModal.classList.add("hidden")}),r.addModelBtn.addEventListener("click",()=>{e.chatAPI.addModel({modelName:"gemini-2.5-flash-lite",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192}),N(e.chatAPI)}),r.addApiKeyBtn.addEventListener("click",()=>{_()}),r.saveSettingsBtn.addEventListener("click",async o=>{o.preventDefault();const a=Array.from(document.querySelectorAll(".api-key-input")).map(d=>d.value.trim()).filter(d=>d),c=r.proxyUrl.value.trim();e.chatAPI.saveGlobalSettings({apiKeys:a,proxy:c});const l=Array.from(r.llmConfigsContainer.children).map(d=>({modelName:d.querySelector('input[placeholder="Model Name"]').value,nickname:d.querySelector('input[placeholder="Nickname"]').value,temperature:parseFloat(d.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(d.querySelector('input[placeholder="Max Output Tokens"]').value,10),system_prompt:d.querySelector("textarea").value,useGoogleSearch:d.querySelector('input[id^="google-search-checkbox-"]').checked,useUrlContext:d.querySelector('input[id^="url-context-checkbox-"]').checked,prependSystemPrompt:d.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked,thinkingBudget:parseInt(d.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)}));await e.chatAPI.saveModels(l),r.settingsModal.classList.add("hidden"),r.modelNickname.textContent=e.chatAPI.getCurrentModel().nickname,x(e.chatAPI)}),r.attachFileBtn.addEventListener("click",()=>{const o=document.createElement("input");o.type="file",o.multiple=!0,o.addEventListener("change",a=>{const c=a.target.files;for(let l=0;l<c.length;l++){const d=c[l],m=new FileReader;m.onload=h=>{e.attachedFiles.push({name:d.name,type:d.type,data:h.target.result}),S(e)},m.readAsDataURL(d)}}),o.click()}),r.sendBtn.addEventListener("click",async()=>{const o=r.messageInput.value.trim();if(o||e.attachedFiles.length>0)if(e.editingMessageId!==null){const a=await e.chatAPI.updateMessage(e.editingMessageId,o,e.attachedFiles);e.chatView.editMessage(a),e.editingMessageId=null,r.cancelEditBtn.classList.add("hidden"),r.sendBtn.textContent="â–¶ï¸",r.messageInput.value="",e.attachedFiles=[],S(e)}else{const a={sender:"User",content:o,files:e.attachedFiles},c=await e.chatAPI.addMessage(a);e.chatView.appendMessage(c),r.messageInput.value="",e.attachedFiles=[],S(e),r.sendBtn.disabled=!0;const l={sender:"Assistant",content:"...",id:-1};e.chatView.appendMessage(l);try{const d=await e.chatAPI.sendMessage(await e.chatAPI.getMessages());e.chatView.removeMessage(-1),d&&e.chatView.appendMessage(d)}catch(d){e.chatView.removeMessage(-1);const m={sender:"Error",content:`An error occurred: ${d.message}`,id:Date.now()};e.chatView.appendMessage(m)}finally{r.sendBtn.disabled=!1,x(e.chatAPI)}}}),r.cancelEditBtn.addEventListener("click",()=>{r.messageInput.value="",e.attachedFiles=[],e.editingMessageId=null,S(e),r.cancelEditBtn.classList.add("hidden"),r.sendBtn.textContent="â–¶ï¸"}),r.messageInput.addEventListener("keydown",o=>{o.ctrlKey&&o.key==="Enter"&&(o.preventDefault(),r.sendBtn.click())});let t=!1;const n=o=>{t=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},s=o=>{if(t){const a=o.clientY||o.touches&&o.touches[0].clientY;if(a===void 0)return;let c=window.innerHeight-a;const l=e.initialFooterHeight+r.attachedFilesContainer.offsetHeight,d=500;c<l&&(c=l),c>d&&(c=d),r.footer.style.height=`${c}px`}},i=()=>{t=!1,document.body.style.userSelect="",document.body.style.cursor=""};r.resizeHandle.addEventListener("mousedown",n),document.addEventListener("mousemove",s),document.addEventListener("mouseup",i),r.resizeHandle.addEventListener("touchstart",n,{passive:!0}),document.addEventListener("touchmove",s),document.addEventListener("touchend",i),r.clearChatBtn.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await e.chatAPI.clearMessages(),e.chatView.clear(),x(e.chatAPI))}),r.exportSettingsBtn.addEventListener("click",()=>{const o=e.chatAPI.getModels(),a="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(o,null,2)),c=document.createElement("a");c.setAttribute("href",a),c.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(c),c.click(),c.remove()}),r.importSettingsBtn.addEventListener("click",()=>{const o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=a=>{const c=a.target.files[0],l=new FileReader;l.onload=d=>{try{const m=d.target.result,h=JSON.parse(m);e.chatAPI.saveModels(h),N(e.chatAPI),r.modelNickname.textContent=e.chatAPI.getCurrentModel().nickname,alert("Settings imported successfully!")}catch(m){alert("Error importing settings: "+m.message)}},l.readAsText(c)},o.click()})}document.addEventListener("DOMContentLoaded",async()=>{const e={attachedFiles:[],editingMessageId:null,selectedMessage:null,selectedConversationId:null,initialFooterHeight:r.footer.offsetHeight,compressionController:null,chatView:new window.ChatView(r.chatContainer),chatAPI:window.chatAPI};X(e),await e.chatAPI.init();const t=e.chatAPI.getCurrentModel();t?r.modelNickname.textContent=t.nickname:(r.modelNickname.textContent="No Model",r.sendBtn.disabled=!0);const n=await e.chatAPI.getMessages();e.chatView.renderMessages(n),x(e.chatAPI),S(e)});
