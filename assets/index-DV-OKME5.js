(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const d of o)if(d.type==="childList")for(const a of d.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function s(o){const d={};return o.integrity&&(d.integrity=o.integrity),o.referrerPolicy&&(d.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?d.credentials="include":o.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function n(o){if(o.ep)return;o.ep=!0;const d=s(o);fetch(o.href,d)}})();const te="dumbllmchat_db",ne=4,M="messages",B="conversations",L="workflows",P="apiKeyGroups";let K;function E(){return new Promise((e,t)=>{if(K)return e(K);const s=indexedDB.open(te,ne);s.onerror=n=>{t("Error opening IndexedDB")},s.onsuccess=n=>{K=n.target.result,e(K)},s.onupgradeneeded=n=>{const o=n.target.result;if(o.objectStoreNames.contains(B)||o.createObjectStore(B,{keyPath:"id",autoIncrement:!0}),!o.objectStoreNames.contains(M))o.createObjectStore(M,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const a=n.target.transaction.objectStore(M);a.indexNames.contains("conversationId")||a.createIndex("conversationId","conversationId",{unique:!1})}o.objectStoreNames.contains(L)||o.createObjectStore(L,{keyPath:"id"}),o.objectStoreNames.contains(P)||o.createObjectStore(P,{keyPath:"id",autoIncrement:!0})}})}async function oe(){const e=await E();return new Promise((t,s)=>{const d=e.transaction([B],"readonly").objectStore(B).getAll();d.onerror=a=>{s("Error getting conversations from IndexedDB")},d.onsuccess=a=>{t(a.target.result)}})}async function Y(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([B],"readwrite").objectStore(B).add(e);a.onerror=c=>{n("Error adding conversation to IndexedDB")},a.onsuccess=c=>{s(c.target.result)}})}async function se(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([B],"readwrite").objectStore(B).put(e);a.onerror=c=>{n("Error updating conversation in IndexedDB")},a.onsuccess=c=>{s(c.target.result)}})}async function re(e){const t=await E();return new Promise((s,n)=>{const o=t.transaction([B,M],"readwrite"),d=o.objectStore(B),a=o.objectStore(M);d.delete(e);const h=a.index("conversationId").openCursor(IDBKeyRange.only(e));h.onsuccess=r=>{const l=r.target.result;l&&(l.delete(),l.continue())},o.oncomplete=()=>{s()},o.onerror=r=>{n("Error deleting conversation from IndexedDB")}})}async function ae(e){const t=await E();return new Promise((s,n)=>{const c=t.transaction([M],"readonly").objectStore(M).index("conversationId").getAll(e);c.onerror=h=>{n("Error getting messages from IndexedDB")},c.onsuccess=h=>{s(h.target.result)}})}async function J(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([M],"readwrite").objectStore(M).add(e);a.onerror=c=>{n("Error adding message to IndexedDB")},a.onsuccess=c=>{s(c.target.result)}})}async function ie(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([M],"readwrite").objectStore(M).put(e);a.onerror=c=>{n("Error updating message in IndexedDB")},a.onsuccess=c=>{s(c.target.result)}})}async function ce(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([M],"readwrite").objectStore(M).delete(e);a.onerror=c=>{n("Error removing message from IndexedDB")},a.onsuccess=c=>{s()}})}async function le(e){const t=await E();return new Promise((s,n)=>{const o=t.transaction([M],"readwrite"),c=o.objectStore(M).index("conversationId").openCursor(IDBKeyRange.only(e));c.onsuccess=h=>{const r=h.target.result;r&&(r.delete(),r.continue())},o.oncomplete=()=>{s()},o.onerror=h=>{n("Error clearing messages from IndexedDB")}})}async function de(e){const{messages:t,...s}=e;delete s.id;const n=await Y(s);for(const o of t)delete o.id,o.conversationId=n,await J(o)}async function ue(){const e=await E();return new Promise((t,s)=>{const d=e.transaction([L],"readonly").objectStore(L).getAll();d.onerror=a=>s(`Error getting workflows: ${a.target.error}`),d.onsuccess=a=>t(a.target.result)})}async function me(e){const t=await E();return new Promise((s,n)=>{e.id||(e.id=`workflow_${Date.now()}_${Math.random().toString(36).substring(2,9)}`);const a=t.transaction([L],"readwrite").objectStore(L).add(e);a.onerror=c=>n(`Error adding workflow: ${c.target.error}`),a.onsuccess=c=>s(e.id)})}async function ge(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([L],"readwrite").objectStore(L).put(e);a.onerror=c=>n(`Error updating workflow: ${c.target.error}`),a.onsuccess=c=>s(c.target.result)})}async function he(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([L],"readwrite").objectStore(L).delete(e);a.onerror=c=>n(`Error deleting workflow: ${c.target.error}`),a.onsuccess=()=>s()})}async function we(){const e=await E();return new Promise((t,s)=>{const d=e.transaction([P],"readonly").objectStore(P).getAll();d.onerror=a=>s(`Error getting API key groups: ${a.target.error}`),d.onsuccess=a=>t(a.target.result)})}async function fe(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([P],"readwrite").objectStore(P).add(e);a.onerror=c=>n(`Error adding API key group: ${c.target.error}`),a.onsuccess=c=>s(c.target.result)})}async function pe(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([P],"readwrite").objectStore(P).put(e);a.onerror=c=>n(`Error updating API key group: ${c.target.error}`),a.onsuccess=c=>s(c.target.result)})}async function ye(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([P],"readwrite").objectStore(P).delete(e);a.onerror=c=>n(`Error deleting API key group: ${c.target.error}`),a.onsuccess=()=>s()})}async function ve(e){const t=await E();return new Promise((s,n)=>{const a=t.transaction([P],"readonly").objectStore(P).get(e);a.onerror=c=>n(`Error getting API key group: ${c.target.error}`),a.onsuccess=c=>s(c.target.result)})}window.db={getConversations:oe,addConversation:Y,updateConversation:se,deleteConversation:re,getMessages:ae,addMessage:J,updateMessage:ie,removeMessage:ce,clearMessages:le,importConversation:de,getWorkflows:ue,addWorkflow:me,updateWorkflow:ge,deleteWorkflow:he,getApiKeyGroups:we,addApiKeyGroup:fe,updateApiKeyGroup:pe,deleteApiKeyGroup:ye,getApiKeyGroup:ve};function U(e){if(!e)return"";let t=e.trim();for(;t.endsWith("/");)t=t.slice(0,-1);return t?t+"/":""}class be{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.currentWorkflowId=null,this.proxy="",this.workflowRequestDelay=0,this.sequentialWorkflowRequests=!0,this.apiRetryDelay=200,this.init()}async init(){const t=this.getGlobalSettings();this.proxy=t.proxy||"",this.workflowRequestDelay=t.workflowRequestDelay||0,this.sequentialWorkflowRequests=t.sequentialWorkflowRequests??!0,this.apiRetryDelay=t.apiRetryDelay??200,await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),this.currentWorkflowId=localStorage.getItem("current_workflow_id"),this.currentModelIndex=this.getCurrentModelIndex(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(t){const s=await window.db.addConversation(t),n={...t,id:s};return this.conversations.push(n),n}async updateConversation(t){await window.db.updateConversation(t);const s=this.conversations.findIndex(n=>n.id===t.id);s!==-1&&(this.conversations[s]=t)}async deleteConversation(t){await window.db.deleteConversation(t),this.conversations=this.conversations.filter(s=>s.id!==t),this.currentConversationId===t&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(t){this.currentConversationId=t,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const t=localStorage.getItem("llm_models");return t?JSON.parse(t):[]}async fetchModelInfo(t){return{...t,maxTokens:t.maxOutputTokens||8192}}async fetchAndSetModels(){const t=this.getModels(),s=await Promise.all(t.map(n=>this.fetchModelInfo(n)));this.models=s}async saveModels(t){const s=t.map(n=>{const{maxTokens:o,...d}=n;return d});localStorage.setItem("llm_models",JSON.stringify(s)),await this.fetchAndSetModels()}getGlobalSettings(){const t=localStorage.getItem("global_settings");return t?JSON.parse(t):{proxy:"",workflowRequestDelay:0,sequentialWorkflowRequests:!0,apiRetryDelay:200}}saveGlobalSettings(t){localStorage.setItem("global_settings",JSON.stringify(t)),this.proxy=t.proxy||"",this.workflowRequestDelay=t.workflowRequestDelay||0,this.sequentialWorkflowRequests=t.sequentialWorkflowRequests??!0,this.apiRetryDelay=t.apiRetryDelay??200}addModel(t){this.models.push(t),this.saveModels(this.models)}updateModel(t,s){this.models[t]=s,this.saveModels(this.models)}removeModel(t){this.models.splice(t,1),this.saveModels(this.models)}getCurrentModel(){return this.models[this.currentModelIndex]}setCurrentWorkflow(t){this.currentWorkflowId=t,localStorage.setItem("current_workflow_id",t),localStorage.removeItem("current_model_index")}setCurrentModelIndex(t){this.currentModelIndex=t,this.currentWorkflowId=null,localStorage.setItem("current_model_index",t),localStorage.removeItem("current_workflow_id")}getCurrentModelIndex(){const t=localStorage.getItem("current_model_index");return t?parseInt(t,10):0}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(t){return this.messages.find(s=>s.id===t)}async addMessage(t){if(!this.currentConversationId){const d=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=d.id,this.saveCurrentConversationId()}const s={...t,conversationId:this.currentConversationId},n=await window.db.addMessage(s),o={...s,id:n};return this.messages.push(o),o}async updateMessage(t,s,n){const o=await this.getMessage(t);return o.content=s,n&&(o.files=n),await window.db.updateMessage(o),o}async removeMessage(t){await window.db.removeMessage(t),this.messages=this.messages.filter(s=>s.id!==t)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async executeRequestWithCycling(t,s,n){if(!t.apiKeyGroupId)throw new Error(`Model "${t.nickname}" has no API key group assigned.`);const o=await window.db.getApiKeyGroup(t.apiKeyGroupId),d=(o?.keys||[]).filter(r=>r);if(d.length===0)throw new Error(`API key group "${o?.name||"Unknown"}" is empty or does not exist.`);let a=null,c=null,h=0;for(;;){const r=d[h];if(h=(h+1)%d.length,n?.aborted)throw new DOMException("Aborted by user","AbortError");if(c&&Date.now()-c>6e4)throw new Error(`API requests failed for 60 seconds. Last error: ${a.message}`);try{const{endpoint:l,headers:u,body:m}=s(t,r),f=await fetch(l,{method:"POST",headers:u,body:JSON.stringify(m),signal:n});if(!f.ok){const w=await f.json().catch(()=>({}));throw f.status===403||f.status===404?new Error(`Unrecoverable API Error: ${f.status} ${f.statusText} - ${w.error?.message||"Unknown error"}`):new Error(`API Error: ${f.status} ${f.statusText} - ${w.error?.message||"Unknown error"}`)}return await f.json()}catch(l){if(l.message.startsWith("Unrecoverable"))throw l;a=l,c=Date.now(),console.warn(`API request with key ending in ...${r.slice(-4)} failed:`,l.message),await new Promise(u=>setTimeout(u,this.apiRetryDelay))}}}_buildApiRequest(t,s,n,o=[]){const{type:d,modelName:a,temperature:c,system_prompt:h,maxOutputTokens:r,prependSystemPrompt:l,thinkingBudget:u,endpoint:m}=t,f=U(this.proxy);let w,g,b={"Content-Type":"application/json"};if(this.proxy&&(b["ngrok-skip-browser-warning"]="true"),d==="gemini"){w=`${f}https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent`,b["x-goog-api-key"]=s;let k=n.map(v=>{const y=[{text:v.content}];return v.files&&v.files.forEach(p=>{y.push({inline_data:{mime_type:p.type,data:p.data.split(",")[1]}})}),{role:v.sender==="User"?"user":"model",parts:y}});if(l&&h){const v=k[k.length-1];v.role==="user"&&(v.parts[0].text=`${h}

${v.parts[0].text}`)}g={contents:k,generationConfig:{temperature:c,topK:1,topP:1,maxOutputTokens:r||8192,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]},!l&&h&&(g.systemInstruction={role:"user",parts:[{text:h}]}),o.length>0&&(g.tools=o),u&&(g.generationConfig.thinkingConfig={thinkingBudget:u})}else if(d==="openai"){w=f+(m||"https://api.openai.com/v1/chat/completions"),b.Authorization=`Bearer ${s}`;const k=n.map(v=>({role:v.sender==="User"?"user":"assistant",content:v.content}));h&&k.unshift({role:"system",content:h}),g={model:a,messages:k,temperature:c,max_tokens:r||2048},t.reasoningEffort&&(g.include_reasoning=!0,g.reasoning_effort=t.reasoningEffort)}else throw new Error(`Unsupported model type: ${d}`);return{endpoint:w,headers:b,body:g}}async _generateContent(t,s){const n=this.getCurrentModel(),o=[];n.useGoogleSearch&&o.push({google_search:{}}),n.useUrlContext&&o.push({url_context:{}});const d=(c,h)=>this._buildApiRequest(c,h,t,o),a=await this.executeRequestWithCycling(n,d,s);if(n.type==="gemini"){if(!a.candidates||a.candidates.length===0){const h=a.promptFeedback?.blockReason;return h?`[The model blocked the response. Reason: ${h}]`:"[The model sent an empty response.]"}const c=a.candidates[0].content;return c?.parts?c.parts.map(h=>h.text).join(""):"[The model sent an empty response.]"}else if(n.type==="openai")return a.choices?.[0]?.message?.content||"[The model sent an empty response.]";return"[An unknown error occurred]"}async sendMessage(t){const n={sender:"Assistant",content:await this._generateContent(t)};return await this.addMessage(n)}async generateFromModel(t,s,n=[],o){const d=this.models.find(r=>r.nickname.toLowerCase()===t.toLowerCase());if(!d)throw new Error(`Model with nickname "${t}" not found.`);const a=[];n.includes("google")&&a.push({google_search:{}}),n.includes("urlcontext")&&a.push({url_context:{}});const c=(r,l)=>this._buildApiRequest(r,l,s,a),h=await this.executeRequestWithCycling(d,c,o);if(d.type==="gemini"){if(!h.candidates||h.candidates.length===0){const l=h.promptFeedback?.blockReason;return l?`[The model blocked the response. Reason: ${l}]`:"[The model sent an empty response.]"}const r=h.candidates[0].content;return r?.parts?r.parts.map(l=>l.text).join(""):"[The model sent an empty response.]"}else if(d.type==="openai")return h.choices?.[0]?.message?.content||"[The model sent an empty response.]";return"[An unknown error occurred]"}async countTokens(t){const s=this.getCurrentModel();if(s.type==="openai"){const o=t.map(d=>d.content).join(" ");return Math.ceil(o.length/4)}const n=(o,d)=>{const{modelName:a}=o,h=`${U(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${a}:countTokens`,r={"Content-Type":"application/json","x-goog-api-key":d};this.proxy&&(r["ngrok-skip-browser-warning"]="true");const l={contents:t.map(u=>({role:u.sender==="User"?"user":"model",parts:[{text:u.content}]}))};return{endpoint:h,headers:r,body:l}};try{return(await this.executeRequestWithCycling(s,n)).totalTokens}catch(o){return console.error("Token count failed:",o),0}}async compressConversation(t,s,n){if(n?.aborted)return;const o=this.conversations.find(l=>l.id===t);if(!o)throw new Error("Conversation not found");const d=await window.db.getMessages(t);if(d.length===0)throw new Error("Cannot compress an empty conversation.");const a=Math.ceil(d.length/8),c=`[Compressed] ${o.name}`,h=await this.addConversation({name:c,timestamp:Date.now()}),r=async()=>{await this.deleteConversation(h.id),n.removeEventListener("abort",r)};n?.addEventListener("abort",r);for(let l=0;l<d.length;l+=8){if(n?.aborted)throw new DOMException("Aborted by user","AbortError");s&&s(l/8+1,a);const f=`... [your compression prompt] ...

${d.slice(l,l+8).map(g=>`${g.sender}: ${g.content}`).join(`
`)}`,w=await this._generateContent([{sender:"User",content:f}],n);if(!w||w.trim()===""||w.includes("empty response"))throw new Error("Compression failed for a chunk.");await window.db.addMessage({sender:"Assistant",content:w,conversationId:h.id})}return n?.removeEventListener("abort",r),h}}window.chatAPI=new be;class Ie{constructor(t){this.chatContainer=t}appendMessage(t){const s=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,n=this.createMessageElement(t);this.chatContainer.appendChild(n),s&&n.scrollIntoView({behavior:"smooth"})}renderMessages(t){this.clear(),t.forEach(s=>{const n=this.createMessageElement(s);this.chatContainer.appendChild(n)})}removeMessage(t){const s=this.chatContainer.querySelector(`[data-id='${t}']`);s&&s.remove()}editMessage(t){const s=this.chatContainer.querySelector(`[data-id='${t.id}']`);if(s){const n=this.createMessageElement(t);s.replaceWith(n)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(t){const s=document.createElement("div");let n="bg-gray-300 dark:bg-gray-700",o="self-start";t.sender==="User"?(n="bg-blue-500 text-white",o="self-end"):t.sender==="Error"&&(n="bg-red-500 text-white"),s.className=`p-3 rounded-lg ${n} w-full ${o} message`,s.dataset.id=t.id;const d=document.createElement("div");if(d.className="message-content",d.innerHTML=marked.parse(t.content,{breaks:!0}),s.appendChild(d),t.files&&t.files.length>0){const a=document.createElement("div");a.className="flex flex-wrap gap-2 mt-2",t.files.forEach(c=>{const h=document.createElement("div");h.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const r=document.createElement("span");r.className="mr-2 text-gray-800 dark:text-gray-200",r.style.wordBreak="break-all",r.textContent=c.name,h.appendChild(r);const l=document.createElement("button");l.textContent="â¬‡ï¸",l.className="download-file-btn",l.addEventListener("click",()=>{const u=document.createElement("a");u.href=c.data,u.download=c.name,u.click()}),h.appendChild(l),a.appendChild(h)}),s.appendChild(a)}return s.querySelectorAll("pre").forEach(a=>{const c=a.querySelector("code"),h=c.className.split("-")[1]||"",r=document.createElement("div");r.className="code-block-container";const l=document.createElement("div");l.className="code-block-header";const u=document.createElement("span");u.textContent=h,l.appendChild(u);const m=document.createElement("button");m.textContent="Copy",m.className="copy-code-btn",l.appendChild(m),r.appendChild(l),r.appendChild(a.cloneNode(!0)),a.replaceWith(r),hljs.highlightElement(r.querySelector("pre code")),m.addEventListener("click",f=>{f.stopPropagation();const w=c.innerText;navigator.clipboard.writeText(w).then(()=>{m.textContent="Copied!",setTimeout(()=>{m.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),t.sender!=="Error"&&s.addEventListener("click",a=>{const c=new CustomEvent("message-selected",{detail:{messageElement:s,x:a.clientX,y:a.clientY}});this.chatContainer.dispatchEvent(c)}),s}}window.ChatView=Ie;const i={modelSelector:document.getElementById("model-selector"),tokenCountDisplay:document.getElementById("token-count-display"),settingsBtn:document.getElementById("settings-btn"),historyBtn:document.getElementById("history-btn"),chatContainer:document.getElementById("chat-container"),resizeHandle:document.getElementById("resize-handle"),messageInput:document.getElementById("message-input"),sendBtn:document.getElementById("send-btn"),settingsModal:document.getElementById("settings-modal"),llmConfigsContainer:document.getElementById("llm-configs-container"),addModelBtn:document.getElementById("add-model-btn"),closeSettingsBtn:document.getElementById("close-settings-btn"),historyModal:document.getElementById("history-modal"),conversationsContainer:document.getElementById("conversations-container"),addConversationBtn:document.getElementById("add-conversation-btn"),renameConversationBtn:document.getElementById("rename-conversation-btn"),deleteConversationBtn:document.getElementById("delete-conversation-btn"),compressConversationBtn:document.getElementById("compress-conversation-btn"),importConversationBtn:document.getElementById("import-conversation-btn"),exportConversationBtn:document.getElementById("export-conversation-btn"),loadConversationBtn:document.getElementById("load-conversation-btn"),closeHistoryBtn:document.getElementById("close-history-btn"),clearChatBtn:document.getElementById("clear-chat-btn"),importSettingsBtn:document.getElementById("import-settings-btn"),exportSettingsBtn:document.getElementById("export-settings-btn"),copyChatBtn:document.getElementById("copy-chat-btn"),footer:document.querySelector("footer"),attachFileBtn:document.getElementById("attach-file-btn"),attachedFilesContainer:document.getElementById("attached-files-container"),cancelEditBtn:document.getElementById("cancel-edit-btn"),proxyUrl:document.getElementById("proxy-url"),sequentialWorkflowRequests:document.getElementById("sequential-workflow-requests"),workflowRequestDelay:document.getElementById("workflow-request-delay"),apiRetryDelay:document.getElementById("api-retry-delay"),settingsTabs:document.getElementById("settings-tabs"),tabGlobal:document.getElementById("tab-global"),tabModels:document.getElementById("tab-models"),tabWorkflows:document.getElementById("tab-workflows"),workflowsList:document.getElementById("workflows-list"),addWorkflowBtn:document.getElementById("add-workflow-btn"),workflowEditorOverlay:document.getElementById("workflow-editor-overlay"),workflowNameInput:document.getElementById("workflow-name-input"),workflowScriptInput:document.getElementById("workflow-script-input"),workflowEditorCancelBtn:document.getElementById("workflow-editor-cancel-btn")};class Ce{parse(t){const s=t.split(`
`),n=[],o=[];for(let a=0;a<s.length;a++){const c=s[a];if(c.trim()===""||c.trim().startsWith("//"))continue;const h=c.match(/^(\s*)/),r=h?h[1]:"",l=this.calculateIndentLevel(r);let u=this.parseLine(c.trim(),l);if(!u)throw new SyntaxError(`Invalid syntax on line ${a+1}: "${c.trim()}"`);if(u.prompt.trim()==='"""'){let m="";for(a++;a<s.length;){const f=s[a];if(f.trim().endsWith('"""')){m+=f.trim().slice(0,-3);break}m+=f+`
`,a++}u.prompt=m.trim()}for(u.id=u.id||`node_${Date.now()}_${a}`,u.children=u.children||[],u.explicitDependencies=u.explicitDependencies||[],u.flags=u.flags||[];o.length>0&&o[o.length-1].indentLevel>=u.indentLevel;)o.pop();o.length>0&&o[o.length-1].children.push(u.id),o.push(u),n.push(u)}const d=new Map(n.map(a=>[a.id,a]));return n.forEach(a=>{const c=/\{\{#(\w+)\}\}/g;let h;if(a.prompt)for(;(h=c.exec(a.prompt))!==null;)d.has(h[1])&&a.explicitDependencies.push(h[1])}),n.forEach(a=>{if(!a.children||a.children.length===0)return;const c=new Set;for(const h of a.children){const r=d.get(h);r&&r.explicitDependencies.includes(a.id)&&c.add(h)}c.size>0&&(a.children=a.children.filter(h=>!c.has(h)))}),n}calculateIndentLevel(t){const s=t.replace(/\t/g,"  ").length;return Math.floor(s/2)}parseLine(t,s){const n=t.match(/^(#[\w-]+)\s*=\s*(.*)/);if(n){const[,w,g]=n;return{id:w.substring(1),type:"static",prompt:g.trim(),indentLevel:s,flags:[]}}const o=t.indexOf(":");if(o===-1){const w=t.split(/\s+/).filter(Boolean);let g=null,b=null,k=null,v=[],y=0;if(w[y]?.startsWith("#")&&(g=w[y].substring(1),y++),y<w.length&&!w[y].startsWith("+")){const p=w[y];p.startsWith("#")?k=p.substring(1):b=p,y++}for(;y<w.length;)w[y].startsWith("+")&&v.push(w[y].substring(1)),y++;return g||b||k?{id:g,model:b,modelVariable:k,type:"llm",prompt:"",indentLevel:s,flags:v}:null}const d=t.substring(0,o).trim(),a=t.substring(o+1).trim(),c=d.split(/\s+/).filter(Boolean);let h=null,r=null,l=null,u=[],m=0;if(c[m]?.startsWith("#")&&(h=c[m].substring(1),m++),m<c.length&&!c[m].startsWith("+")){const w=c[m];w.startsWith("#")?l=w.substring(1):r=w,m++}for(;m<c.length;)c[m].startsWith("+")&&u.push(c[m].substring(1)),m++;return!h&&!r&&!l?null:{id:h,model:r,modelVariable:l,type:r||l?"llm":"static",prompt:a,indentLevel:s,flags:u}}}const A={PENDING:"PENDING",RUNNING:"RUNNING",COMPLETED:"COMPLETED",FAILED:"FAILED"};function F(e){return new Promise(t=>setTimeout(t,e))}class X{constructor(t){this.chatAPI=t,this.parser=new Ce}async execute(t,s,n=()=>{}){const o=this.parser.parse(t);if(!o||o.length===0)return"";const d=this.chatAPI.getModels().map(g=>g.nickname.toLowerCase()),a=new Map(o.filter(g=>g.type==="static").map(g=>[g.id,g.prompt])),c=new Set;o.filter(g=>g.type==="llm").forEach(g=>{if(g.model)c.add(g.model.toLowerCase());else if(g.modelVariable){const b=a.get(g.modelVariable);b&&c.add(b.toLowerCase())}});const h=[...c].filter(g=>!d.includes(g));if(h.length>0)throw new Error(`Workflow aborted: The following models are not defined: ${h.join(", ")}`);new Map(o.map(g=>[g.id,g]));const r=new Map(o.map(g=>[g.id,A.PENDING])),l=new Map;let u=!0,m=-1,f=0;for(;u;){const g=o.filter(y=>{if(r.get(y.id)!==A.PENDING)return!1;const p=y.children||[],I=y.explicitDependencies||[];return[...new Set([...p,...I])].every(x=>r.get(x)===A.COMPLETED)});if(g.length===0)if(Array.from(r.values()).some(p=>p===A.PENDING||p===A.RUNNING)){if(g.length===m?f++:f=0,f>5)throw new Error("Deadlock detected: No runnable nodes found, but some nodes are still pending.")}else{u=!1;continue}m=g.length;const b=g.filter(y=>y.type==="llm"),v=g.filter(y=>y.type==="static").map(async y=>{r.set(y.id,A.RUNNING),n(`Resolving: ${y.id}`);try{let p=y.prompt.replace(/\{\{INPUT\}\}/g,s);y.explicitDependencies&&y.explicitDependencies.forEach(I=>{const C=new RegExp(`\\{\\{#${I}\\}}`,"g");p=p.replace(C,l.get(I)||"")}),l.set(y.id,p),r.set(y.id,A.COMPLETED),n(`Completed: ${y.id}`)}catch(p){throw r.set(y.id,A.FAILED),n(`Failed: ${y.id} - ${p.message}`),new Error(`Error resolving static node ${y.id}: ${p.message}`)}});if(await Promise.all(v),this.chatAPI.sequentialWorkflowRequests)for(let y=0;y<b.length;y++){this.chatAPI.workflowRequestDelay>0&&y>0&&(n(`Waiting for ${this.chatAPI.workflowRequestDelay} seconds...`),await F(this.chatAPI.workflowRequestDelay*1e3));const p=b[y];r.set(p.id,A.RUNNING);try{let I=p.model;if(p.modelVariable&&(I=l.get(p.modelVariable),!I))throw new Error(`Could not resolve model variable "${p.modelVariable}"`);n(`Running: ${p.id} (${I})`);let C=p.prompt.replace(/\{\{INPUT\}\}/g,s);const x=new Set;p.explicitDependencies&&p.explicitDependencies.forEach(S=>{const N=new RegExp(`\\{\\{#${S}\\}}`,"g");C=C.replace(N,l.get(S)),x.add(S)});const T=(p.children||[]).filter(S=>!x.has(S)).map(S=>l.get(S)).join(`

`);T&&(C=`${T}

${C}`);let $=[];p.flags&&p.flags.includes("history")?($=await this.chatAPI.getMessages()||[],$.push({sender:"User",content:C})):$=[{sender:"User",content:C}];const j=await this.chatAPI.generateFromModel(I,$,p.flags);l.set(p.id,j),r.set(p.id,A.COMPLETED),n(`Completed: ${p.id}`)}catch(I){throw r.set(p.id,A.FAILED),n(`Failed: ${p.id} - ${I.message}`),new Error(`Error executing node ${p.id}: ${I.message}`)}}else{const y=b.map(async(p,I)=>{this.chatAPI.workflowRequestDelay>0&&(n(`Waiting for ${this.chatAPI.workflowRequestDelay}s before ${p.id}...`),await F(this.chatAPI.workflowRequestDelay*1e3)),r.set(p.id,A.RUNNING);try{let C=p.model;if(p.modelVariable&&(C=l.get(p.modelVariable),!C))throw new Error(`Could not resolve model variable "${p.modelVariable}"`);n(`Running: ${p.id} (${C})`);let x=p.prompt.replace(/\{\{INPUT\}\}/g,s);const T=new Set;p.explicitDependencies&&p.explicitDependencies.forEach(N=>{const ee=new RegExp(`\\{\\{#${N}\\}}`,"g");x=x.replace(ee,l.get(N)),T.add(N)});const $=(p.children||[]).filter(N=>!T.has(N)).map(N=>l.get(N)).join(`

`);$&&(x=`${$}

${x}`);let D=[];p.flags&&p.flags.includes("history")?(D=await this.chatAPI.getMessages()||[],D.push({sender:"User",content:x})):D=[{sender:"User",content:x}];const S=await this.chatAPI.generateFromModel(C,D,p.flags);l.set(p.id,S),r.set(p.id,A.COMPLETED),n(`Completed: ${p.id}`)}catch(C){throw r.set(p.id,A.FAILED),n(`Failed: ${p.id} - ${C.message}`),new Error(`Error executing node ${p.id}: ${C.message}`)}});await Promise.all(y)}await new Promise(y=>setTimeout(y,50))}return o.filter(g=>g.indentLevel===0&&g.type==="llm").map(g=>l.get(g.id)).join(`

`)}}function ke(e,t,s,n){const o=document.createElement("div");o.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const d=parseInt(e.dataset.id),a=document.createElement("button");a.textContent="âœï¸",a.addEventListener("click",async()=>{const g=await n.chatAPI.getMessage(d);i.messageInput.value=g.content,n.attachedFiles=g.files||[],n.editingMessageId=d,W(n),i.cancelEditBtn.classList.remove("hidden"),i.sendBtn.textContent="ðŸ’¾",_(),i.messageInput.focus()});const c=document.createElement("button");c.textContent="ðŸ—‘ï¸",c.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await n.chatAPI.removeMessage(d),n.chatView.removeMessage(d)),_()});const h=document.createElement("button");h.textContent="ðŸ“‹",h.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),_()});const r=document.createElement("button");r.textContent="ðŸ”„ï¸",r.addEventListener("click",async()=>{const g=await n.chatAPI.getMessages(),b=g.findIndex(I=>I.id===d),k=g[b];let v;k.sender==="User"?v=g.slice(0,b+1):v=g.slice(0,b),await n.chatAPI.clearMessages();for(const I of v)await n.chatAPI.addMessage(I);const y=i.chatContainer.scrollTop;n.chatView.renderMessages(v),i.chatContainer.scrollTop=y;const p=v[v.length-1];if(p&&p.sender==="User"){_(),i.sendBtn.disabled=!0;const I="temp-"+Date.now();n.chatView.appendMessage({sender:"Assistant",content:"...",id:I},!0);try{if(n.chatAPI.currentWorkflowId){const x=(await window.db.getWorkflows()).find(S=>S.id===n.chatAPI.currentWorkflowId);if(!x)throw new Error("Selected workflow not found.");const T=new X(n.chatAPI),$=S=>Z(I,S),D=await T.execute(x.script,p.content,$);n.chatView.removeMessage(I);const j=await n.chatAPI.addMessage({sender:"Assistant",content:D});n.chatView.appendMessage(j)}else{const C=await n.chatAPI.sendMessage(v);n.chatView.removeMessage(I),C&&n.chatView.appendMessage(C)}}catch(C){n.chatView.removeMessage(I);const x={sender:"Error",content:C.message,id:Date.now()};n.chatView.appendMessage(x)}finally{i.sendBtn.disabled=!1,n.chatAPI.currentWorkflowId||q(n.chatAPI)}}}),o.appendChild(a),o.appendChild(c),o.appendChild(h),o.appendChild(r),o.style.visibility="hidden",document.body.appendChild(o);const l=o.getBoundingClientRect(),u=window.innerWidth,m=window.innerHeight;let f=t,w=s;t+l.width>u&&(f=u-l.width-5),s+l.height>m&&(w=m-l.height-5),f<0&&(f=5),w<0&&(w=5),o.style.left=`${f}px`,o.style.top=`${w}px`,o.style.visibility="visible"}function _(){const e=document.querySelector(".message-controls");e&&e.remove()}async function q(e){const t=await e.getMessages(),s=await e.countTokens(t),n=e.getCurrentModel();i.tokenCountDisplay.textContent=`${s}/${n.maxTokens}`}async function R(e){const t=await e.chatAPI.getConversations();t.reverse(),i.conversationsContainer.innerHTML="",e.selectedConversationId=null,i.renameConversationBtn.disabled=!0,i.deleteConversationBtn.disabled=!0,i.loadConversationBtn.disabled=!0,i.exportConversationBtn.disabled=!0,i.compressConversationBtn.disabled=!0;for(const n of t){const o=document.createElement("li");o.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",o.dataset.id=n.id;const d=document.createElement("span");d.className="truncate";let a=n.name;if(!a){const c=await window.db.getMessages(n.id);c.length>0?a=c[0].content.split(`
`)[0]:a="New Conversation"}d.textContent=a,o.appendChild(d),o.addEventListener("click",()=>{if(e.selectedConversationId!==null){const c=i.conversationsContainer.querySelector(`[data-id='${e.selectedConversationId}']`);c&&c.classList.remove("selected")}o.classList.add("selected"),e.selectedConversationId=n.id,i.renameConversationBtn.disabled=!1,i.deleteConversationBtn.disabled=!1,i.loadConversationBtn.disabled=!1,i.exportConversationBtn.disabled=!1,i.compressConversationBtn.disabled=!1,o.scrollIntoView({block:"nearest"})}),i.conversationsContainer.appendChild(o)}const s=i.conversationsContainer.querySelector(`[data-id='${e.chatAPI.currentConversationId}']`);s&&(s.classList.add("selected"),e.selectedConversationId=e.chatAPI.currentConversationId,i.renameConversationBtn.disabled=!1,i.deleteConversationBtn.disabled=!1,i.loadConversationBtn.disabled=!1,i.exportConversationBtn.disabled=!1,i.compressConversationBtn.disabled=!1,setTimeout(()=>{s.scrollIntoView({block:"nearest"})},0))}async function O(e){const s=(await window.db.getApiKeyGroups()).map(n=>`<option value="${n.id}">${n.name}</option>`).join("");i.llmConfigsContainer.innerHTML="",e.getModels().forEach((n,o)=>{const d=document.createElement("div");d.className="mb-4 p-2 border border-black rounded-lg dark:border-black";const a=`
            <select class="api-key-group-selector w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-index="${o}">
                <option value="" disabled ${n.apiKeyGroupId?"":"selected"}>Select Key Group...</option>
                ${s}
            </select>
        `;d.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">${n.nickname}</h3>
                <button type="button" class="remove-model-btn text-xl" data-index="${o}">âž–</button>
            </div>
            <select class="model-type-selector w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" data-index="${o}">
                <option value="gemini" ${n.type==="gemini"?"selected":""}>Gemini</option>
                <option value="openai" ${n.type==="openai"?"selected":""}>OpenAI Compatible</option>
            </select>
            <input type="text" value="${n.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
            <input type="text" value="${n.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
            <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${n.system_prompt}</textarea>
            
            ${a}

            <div class="openai-config ${n.type==="openai"?"":"hidden"}">
                <input type="text" value="${n.endpoint||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600 openai-endpoint" placeholder="API Endpoint (e.g., https://api.groq.com/openai/v1/chat/completions)">
                <input type="text" value="${n.reasoningEffort||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600 openai-reasoning-effort" placeholder="Reasoning Effort (e.g., none, default, low, medium, high)">
            </div>
            <input type="number" step="0.1" value="${n.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
            <input type="number" value="${n.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">
            <input type="number" value="${n.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600 ${n.type==="openai"?"hidden":""}" placeholder="Thinking Budget (tokens)">
            <div class="google-search-container ${n.type==="openai"?"hidden":""}">
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="google-search-checkbox-${o}" class="mr-2" ${n.useGoogleSearch?"checked":""}>
                    <label for="google-search-checkbox-${o}">Enable Google Search</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="prepend-system-prompt-checkbox-${o}" class="mr-2" ${n.prependSystemPrompt?"checked":""}>
                    <label for="prepend-system-prompt-checkbox-${o}">Prepend System Prompt</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="url-context-checkbox-${o}" class="mr-2" ${n.useUrlContext?"checked":""}>
                    <label for="url-context-checkbox-${o}">Enable URL Context</label>
                </div>
            </div>
        `,i.llmConfigsContainer.appendChild(d);const c=d.querySelector(".api-key-group-selector");n.apiKeyGroupId&&(c.value=n.apiKeyGroupId)}),document.querySelectorAll(".remove-model-btn").forEach(n=>{n.addEventListener("click",o=>{const d=o.target.dataset.index;e.removeModel(d),O(e)})}),document.querySelectorAll(".model-type-selector").forEach(n=>{n.addEventListener("change",o=>{o.target.dataset.index;const d=n.closest(".mb-4"),a=d.querySelector(".openai-config"),c=d.querySelector('input[placeholder="Thinking Budget (tokens)"]'),h=d.querySelector(".google-search-container");o.target.value==="openai"?(a.classList.remove("hidden"),c.classList.add("hidden"),h.classList.add("hidden")):(a.classList.add("hidden"),c.classList.remove("hidden"),h.classList.remove("hidden"))})})}function Ee(e){const t=e.getGlobalSettings();i.proxyUrl.value=t.proxy||"",i.sequentialWorkflowRequests.checked=t.sequentialWorkflowRequests??!0,i.workflowRequestDelay.value=t.workflowRequestDelay||0,i.apiRetryDelay.value=t.apiRetryDelay??200}function W(e){i.attachedFilesContainer.innerHTML="",e.attachedFiles.forEach((d,a)=>{const c=document.createElement("div");c.className="attached-file-item";const h=document.createElement("span");h.textContent=d.name,c.appendChild(h);const r=document.createElement("button");r.className="remove-file-btn",r.textContent="âŒ",r.addEventListener("click",()=>{e.attachedFiles.splice(a,1),W(e)}),c.appendChild(r),i.attachedFilesContainer.appendChild(c)});const o=i.footer.querySelector(".flex-grow").scrollHeight-i.messageInput.offsetHeight+90;i.footer.offsetHeight<o&&(i.footer.style.height=`${o}px`)}function z(e){i.tabGlobal.classList.add("hidden"),i.tabModels.classList.add("hidden"),i.tabWorkflows.classList.add("hidden"),document.getElementById("tab-api-keys").classList.add("hidden"),i.settingsTabs.querySelectorAll("button").forEach(n=>{n.classList.remove("border-blue-500","text-blue-500"),n.classList.add("text-gray-500")});const t=i.settingsTabs.querySelector(`[data-tab="${e}"]`),s=document.getElementById(`tab-${e}`);t&&s&&(s.classList.remove("hidden"),t.classList.add("border-blue-500","text-blue-500"),t.classList.remove("text-gray-500")),e==="api-keys"&&V(),e==="models"&&O(window.chatAPI)}async function V(){const e=await window.db.getApiKeyGroups(),t=document.getElementById("api-key-groups-container");t.innerHTML="",e.forEach(s=>{const n=document.createElement("div");n.className="mb-4 p-2 border rounded-lg dark:border-gray-600",n.dataset.groupId=s.id,n.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <input type="text" value="${s.name}" class="group-name-input text-lg font-semibold bg-transparent border-b dark:border-gray-500 focus:outline-none focus:border-blue-500">
                <button type="button" class="remove-api-key-group-btn text-xl">âž–</button>
            </div>
            <div class="api-keys-list space-y-2">
                ${(s.keys||[]).map(o=>`
                    <div class="flex items-center space-x-2">
                        <input type="text" value="${o}" class="api-key-input w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
                        <button type="button" class="remove-api-key-btn text-xl">âž–</button>
                    </div>
                `).join("")}
            </div>
            <button type="button" class="add-api-key-to-group-btn mt-2 text-sm p-2 bg-blue-500 text-white rounded-lg">Add Key</button>
        `,t.appendChild(n)})}async function G(e){const t=await window.db.getWorkflows();if(i.workflowsList.innerHTML="",!t||t.length===0){i.workflowsList.innerHTML='<p class="text-gray-500">No workflows created yet.</p>';return}t.forEach(s=>{const n=document.createElement("div");n.className="flex justify-between items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700";const o=document.createElement("span");o.textContent=s.name,n.appendChild(o);const d=document.createElement("div"),a=document.createElement("button");a.textContent="âœï¸",a.className="mr-2",a.onclick=()=>Q(e,s);const c=document.createElement("button");c.textContent="ðŸ—‘ï¸",c.onclick=async()=>{confirm(`Are you sure you want to delete workflow "${s.name}"?`)&&(await window.db.deleteWorkflow(s.id),G(e))},d.appendChild(a),d.appendChild(c),n.appendChild(d),i.workflowsList.appendChild(n)})}function Q(e,t=null){t?(e.editingWorkflowId=t.id,i.workflowNameInput.value=t.name,i.workflowScriptInput.value=t.script):(e.editingWorkflowId=null,i.workflowNameInput.value="",i.workflowScriptInput.value=""),i.workflowEditorOverlay.classList.remove("hidden")}async function H(e){const t=e.getModels(),s=await window.db.getWorkflows();i.modelSelector.innerHTML="";const n=document.createElement("optgroup");n.label="Models",t.forEach((d,a)=>{const c=document.createElement("option");c.value=`model_${a}`,c.textContent=d.nickname,n.appendChild(c)});const o=document.createElement("optgroup");o.label="Workflows",s.forEach(d=>{const a=document.createElement("option");a.value=`workflow_${d.id}`,a.textContent=d.name,o.appendChild(a)}),i.modelSelector.appendChild(n),i.modelSelector.appendChild(o),e.currentWorkflowId?i.modelSelector.value=`workflow_${e.currentWorkflowId}`:i.modelSelector.value=`model_${e.currentModelIndex}`}function Z(e,t){const s=i.chatContainer.querySelector(`[data-id="${e}"]`);if(s){const n=s.querySelector(".message-content");n&&(n.textContent=t)}}function xe(e){i.chatContainer.addEventListener("message-selected",r=>{const{messageElement:l,x:u,y:m}=r.detail;e.selectedMessage&&_(),e.selectedMessage=l,ke(l,u,m,e)}),document.addEventListener("click",r=>{if(!document.querySelector(".message-controls"))return;const u=r.target.closest("[data-id]"),m=r.target.closest(".message-controls");!u&&!m&&_()}),i.historyBtn.addEventListener("click",async()=>{await R(e),i.historyModal.classList.remove("hidden")}),i.closeHistoryBtn.addEventListener("click",()=>{i.historyModal.classList.add("hidden")}),i.addConversationBtn.addEventListener("click",async()=>{const r=await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await e.chatAPI.switchConversation(r.id),e.chatView.clear(),await R(e),q(e.chatAPI)}),i.loadConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){await e.chatAPI.switchConversation(e.selectedConversationId);const r=await e.chatAPI.getMessages();e.chatView.renderMessages(r),i.historyModal.classList.add("hidden"),q(e.chatAPI);const l=e.chatView.chatContainer.lastElementChild;l&&l.scrollIntoView({behavior:"smooth"})}}),i.renameConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const r=e.chatAPI.conversations.find(u=>u.id===e.selectedConversationId),l=prompt("Enter new conversation name:",r.name);if(l&&l.trim()!==""){r.name=l,await e.chatAPI.updateConversation(r);const u=e.selectedConversationId;await R(e);const m=i.conversationsContainer.querySelector(`[data-id='${u}']`);m&&setTimeout(()=>{m.click(),m.scrollIntoView({block:"nearest"})},0)}}}),i.deleteConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null&&confirm("Are you sure you want to delete this conversation?")){let r=await e.chatAPI.getConversations();r.reverse();const l=r.findIndex(f=>f.id===e.selectedConversationId);await e.chatAPI.deleteConversation(e.selectedConversationId);let u=await e.chatAPI.getConversations();if(u.reverse(),u.length>0){let f=l;f>=u.length&&(f=u.length-1),await e.chatAPI.switchConversation(u[f].id)}else await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const m=await e.chatAPI.getMessages();e.chatView.renderMessages(m),await R(e),q(e.chatAPI)}}),i.compressConversationBtn.addEventListener("click",async()=>{if(e.compressionController){e.compressionController.abort(),e.compressionController=null,i.compressConversationBtn.textContent="ðŸ“¦";return}if(e.selectedConversationId!==null){const r=e.chatAPI.getCurrentModel();if(confirm(`Are you sure you want to compress this conversation using ${r.modelName} (${r.nickname})?`)){e.compressionController=new AbortController;const l=e.compressionController.signal;i.compressConversationBtn.textContent="ðŸ“¦...";const u=(m,f)=>{i.compressConversationBtn.textContent=`ðŸ“¦ ${m}/${f}`};try{await e.chatAPI.compressConversation(e.selectedConversationId,u,l),await R(e)}catch(m){m.name!=="AbortError"?alert("Error compressing conversation: "+m.message):(alert("Compression cancelled."),await R(e))}finally{e.compressionController=null,i.compressConversationBtn.textContent="ðŸ“¦"}}}}),i.exportConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const r=e.chatAPI.conversations.find(b=>b.id===e.selectedConversationId),l=await window.db.getMessages(e.selectedConversationId),u={...r,messages:l};let m=r.name;!m&&l.length>0&&(m=l[0].content.split(`
`)[0]);const f=m.replace(/[^a-z0-9]/gi,"_").toLowerCase(),w="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(u,null,2)),g=document.createElement("a");g.setAttribute("href",w),g.setAttribute("download",`${f}.json`),document.body.appendChild(g),g.click(),g.remove()}}),i.importConversationBtn.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".json",r.onchange=async l=>{const u=l.target.files[0],m=new FileReader;m.onload=async f=>{try{const w=f.target.result,g=JSON.parse(w);await window.db.importConversation(g),await R(e),alert("Conversation imported successfully!")}catch(w){alert("Error importing conversation: "+w.message)}},m.readAsText(u)},r.click()}),i.modelSelector.addEventListener("change",r=>{const l=r.target.value;if(l.startsWith("model_")){const u=parseInt(l.split("_")[1]);e.chatAPI.setCurrentModelIndex(u),q(e.chatAPI)}else if(l.startsWith("workflow_")){const u=l.substring(9);e.chatAPI.setCurrentWorkflow(u),i.tokenCountDisplay.textContent="Workflow"}}),i.settingsBtn.addEventListener("click",async()=>{Ee(e.chatAPI),O(e.chatAPI),await G(e),z("global"),i.settingsModal.classList.remove("hidden")}),i.settingsTabs.addEventListener("click",r=>{const l=r.target.closest("button");l&&l.dataset.tab&&z(l.dataset.tab)}),i.closeSettingsBtn.addEventListener("click",()=>{i.settingsModal.classList.add("hidden")}),i.addModelBtn.addEventListener("click",()=>{e.chatAPI.addModel({type:"gemini",modelName:"gemini-2.5-flash-lite",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192,useGoogleSearch:!1,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576,reasoningEffort:null}),O(e.chatAPI)}),document.getElementById("add-api-key-group-btn").addEventListener("click",async()=>{await window.db.addApiKeyGroup({name:"New Key Group",keys:[]}),await V()});let t;const s=async r=>{if(!r)return;const l=parseInt(r.dataset.groupId,10),u=r.querySelector(".group-name-input").value,m=Array.from(r.querySelectorAll(".api-key-input")).map(f=>f.value.trim());await window.db.updateApiKeyGroup({id:l,name:u,keys:m})};i.settingsModal.addEventListener("click",async r=>{const l=r.target.closest("[data-group-id]");if(r.target.classList.contains("remove-api-key-group-btn")){const u=parseInt(l.dataset.groupId,10);confirm("Are you sure you want to delete this API key group?")&&(await window.db.deleteApiKeyGroup(u),await V())}if(r.target.classList.contains("add-api-key-to-group-btn")){const u=document.createElement("div");u.className="flex items-center space-x-2",u.innerHTML=`
                <input type="text" class="api-key-input w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
                <button type="button" class="remove-api-key-btn text-xl">âž–</button>
            `,l.querySelector(".api-keys-list").appendChild(u),u.querySelector("input").focus()}r.target.classList.contains("remove-api-key-btn")&&(r.target.closest(".flex.items-center.space-x-2").remove(),await s(l))}),i.settingsModal.addEventListener("input",async r=>{const l=r.target.closest("[data-group-id]");r.target.classList.contains("group-name-input")&&await s(l),r.target.classList.contains("api-key-input")&&(clearTimeout(t),t=setTimeout(()=>{s(l)},500))});const n=async r=>{const l=i.proxyUrl.value.trim(),u=parseFloat(i.workflowRequestDelay.value),m=i.sequentialWorkflowRequests.checked,f=parseInt(i.apiRetryDelay.value,10);r.saveGlobalSettings({proxy:l,workflowRequestDelay:u,sequentialWorkflowRequests:m,apiRetryDelay:f})},o=async r=>{const l=Array.from(i.llmConfigsContainer.children).map(u=>{const m=u.querySelector(".model-type-selector").value,f=u.querySelector(".api-key-group-selector").value,w={type:m,apiKeyGroupId:f?parseInt(f,10):null,modelName:u.querySelector('input[placeholder="Model Name"]').value,nickname:u.querySelector('input[placeholder="Nickname"]').value,temperature:parseFloat(u.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(u.querySelector('input[placeholder="Max Output Tokens"]').value,10),system_prompt:u.querySelector("textarea").value,prependSystemPrompt:u.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked};return m==="gemini"?(w.useGoogleSearch=u.querySelector('input[id^="google-search-checkbox-"]').checked,w.useUrlContext=u.querySelector('input[id^="url-context-checkbox-"]').checked,w.thinkingBudget=parseInt(u.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)):m==="openai"&&(w.endpoint=u.querySelector(".openai-endpoint").value,w.reasoningEffort=u.querySelector(".openai-reasoning-effort").value.trim(),w.reasoningEffort===""&&(w.reasoningEffort=null)),w});await r.saveModels(l),await H(r)};i.tabGlobal.addEventListener("change",()=>n(e.chatAPI)),i.llmConfigsContainer.addEventListener("change",()=>o(e.chatAPI)),i.addWorkflowBtn.addEventListener("click",async()=>{const l={id:await window.db.addWorkflow({name:"New Workflow",script:`#
`}),name:"New Workflow",script:`#
`};await G(e),Q(e,l)}),i.workflowEditorCancelBtn.addEventListener("click",()=>{i.workflowEditorOverlay.classList.add("hidden")}),i.workflowEditorOverlay.addEventListener("input",async()=>{if(e.editingWorkflowId){const r=i.workflowNameInput.value.trim(),l=i.workflowScriptInput.value,u={id:e.editingWorkflowId,name:r,script:l};await window.db.updateWorkflow(u),await G(e),await H(e.chatAPI)}}),i.attachFileBtn.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.multiple=!0,r.addEventListener("change",l=>{const u=l.target.files;for(let m=0;m<u.length;m++){const f=u[m],w=new FileReader;w.onload=g=>{e.attachedFiles.push({name:f.name,type:f.type,data:g.target.result}),W(e)},w.readAsDataURL(f)}}),r.click()}),i.sendBtn.addEventListener("click",async()=>{const r=i.messageInput.value.trim();if(!r&&e.attachedFiles.length===0)return;if(e.editingMessageId!==null){const m=await e.chatAPI.updateMessage(e.editingMessageId,r,e.attachedFiles);e.chatView.editMessage(m),e.editingMessageId=null,i.cancelEditBtn.classList.add("hidden"),i.sendBtn.textContent="â–¶ï¸",i.messageInput.value="",e.attachedFiles=[],W(e);return}const l={sender:"User",content:r,files:e.attachedFiles},u=await e.chatAPI.addMessage(l);if(e.chatView.appendMessage(u),i.messageInput.value="",e.attachedFiles=[],W(e),i.sendBtn.disabled=!0,e.chatAPI.currentWorkflowId){const m="temp-"+Date.now();e.chatView.appendMessage({sender:"Assistant",content:"Starting workflow...",id:m},!0);try{const w=(await window.db.getWorkflows()).find(y=>y.id===e.chatAPI.currentWorkflowId);if(!w)throw new Error("Selected workflow not found.");const g=new X(e.chatAPI),b=y=>Z(m,y),k=await g.execute(w.script,r,b);e.chatView.removeMessage(m);const v=await e.chatAPI.addMessage({sender:"Assistant",content:k});e.chatView.appendMessage(v)}catch(f){e.chatView.removeMessage(m);const w={sender:"Error",content:f.message,id:Date.now()};e.chatView.appendMessage(w)}finally{i.sendBtn.disabled=!1}}else{const m={sender:"Assistant",content:"...",id:-1};e.chatView.appendMessage(m);try{const f=await e.chatAPI.sendMessage(await e.chatAPI.getMessages());e.chatView.removeMessage(-1),f&&e.chatView.appendMessage(f)}catch(f){e.chatView.removeMessage(-1);const w={sender:"Error",content:`An error occurred: ${f.message}`,id:Date.now()};e.chatView.appendMessage(w)}finally{i.sendBtn.disabled=!1,q(e.chatAPI)}}}),i.cancelEditBtn.addEventListener("click",()=>{i.messageInput.value="",e.attachedFiles=[],e.editingMessageId=null,W(e),i.cancelEditBtn.classList.add("hidden"),i.sendBtn.textContent="â–¶ï¸"}),i.messageInput.addEventListener("keydown",r=>{r.ctrlKey&&r.key==="Enter"&&(r.preventDefault(),i.sendBtn.click())});let d=!1;const a=r=>{d=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},c=r=>{if(d){const l=r.clientY||r.touches&&r.touches[0].clientY;if(l===void 0)return;let u=window.innerHeight-l;const m=e.initialFooterHeight+i.attachedFilesContainer.offsetHeight,f=500;u<m&&(u=m),u>f&&(u=f),i.footer.style.height=`${u}px`}},h=()=>{d=!1,document.body.style.userSelect="",document.body.style.cursor=""};i.resizeHandle.addEventListener("mousedown",a),document.addEventListener("mousemove",c),document.addEventListener("mouseup",h),i.resizeHandle.addEventListener("touchstart",a,{passive:!0}),document.addEventListener("touchmove",c),document.addEventListener("touchend",h),i.clearChatBtn.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await e.chatAPI.clearMessages(),e.chatView.clear(),q(e.chatAPI))}),i.exportSettingsBtn.addEventListener("click",async()=>{const r=e.chatAPI.getModels(),l=await window.db.getWorkflows(),u=await window.db.getApiKeyGroups(),f="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({models:r,workflows:l,apiKeyGroups:u},null,2)),w=document.createElement("a");w.setAttribute("href",f),w.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(w),w.click(),w.remove()}),i.importSettingsBtn.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".json",r.onchange=async l=>{const u=l.target.files[0],m=new FileReader;m.onload=async f=>{try{const w=f.target.result,g=JSON.parse(w);if(g.apiKeyGroups){const k=await window.db.getApiKeyGroups();for(const v of k)await window.db.deleteApiKeyGroup(v.id);for(const v of g.apiKeyGroups)delete v.id,await window.db.addApiKeyGroup(v)}let b=[];if(Array.isArray(g)?b=g:g.models&&(b=g.models),b.length>0&&await e.chatAPI.saveModels(b),g.workflows){const k=await window.db.getWorkflows();for(const v of k)await window.db.deleteWorkflow(v.id);for(const v of g.workflows)delete v.id,await window.db.addWorkflow(v)}await O(e.chatAPI),await H(e.chatAPI),await G(e),await V(),alert("Settings imported successfully!")}catch(w){console.error("Error importing settings:",w),alert("Error importing settings: "+w.message)}},m.readAsText(u)},r.click()})}document.addEventListener("DOMContentLoaded",async()=>{const e={attachedFiles:[],editingMessageId:null,selectedMessage:null,selectedConversationId:null,initialFooterHeight:i.footer.offsetHeight,compressionController:null,chatView:new window.ChatView(i.chatContainer),chatAPI:window.chatAPI};xe(e),await e.chatAPI.init(),e.chatAPI.getCurrentModel()||(i.sendBtn.disabled=!0),await H(e.chatAPI);const s=await e.chatAPI.getMessages();e.chatView.renderMessages(s),e.chatAPI.currentWorkflowId?i.tokenCountDisplay.textContent="Workflow":q(e.chatAPI),W(e)});
