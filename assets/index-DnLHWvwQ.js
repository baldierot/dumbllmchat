(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const l of a)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const l={};return a.integrity&&(l.integrity=a.integrity),a.referrerPolicy&&(l.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?l.credentials="include":a.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(a){if(a.ep)return;a.ep=!0;const l=n(a);fetch(a.href,l)}})();const Ie="dumbllmchat_db",xe=2,I="messages",A="conversations";let te;function L(){return new Promise((h,e)=>{if(te)return h(te);const n=indexedDB.open(Ie,xe);n.onerror=o=>{e("Error opening IndexedDB")},n.onsuccess=o=>{te=o.target.result,h(te)},n.onupgradeneeded=o=>{const a=o.target.result;if(a.objectStoreNames.contains(A)||a.createObjectStore(A,{keyPath:"id",autoIncrement:!0}),!a.objectStoreNames.contains(I))a.createObjectStore(I,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const c=o.target.transaction.objectStore(I);c.indexNames.contains("conversationId")||c.createIndex("conversationId","conversationId",{unique:!1})}}})}async function Me(){const h=await L();return new Promise((e,n)=>{const l=h.transaction([A],"readonly").objectStore(A).getAll();l.onerror=c=>{n("Error getting conversations from IndexedDB")},l.onsuccess=c=>{e(c.target.result)}})}async function he(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([A],"readwrite").objectStore(A).add(h);c.onerror=d=>{o("Error adding conversation to IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function ke(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([A],"readwrite").objectStore(A).put(h);c.onerror=d=>{o("Error updating conversation in IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function Se(h){const e=await L();return new Promise((n,o)=>{const a=e.transaction([A,I],"readwrite"),l=a.objectStore(A),c=a.objectStore(I);l.delete(h);const g=c.index("conversationId").openCursor(IDBKeyRange.only(h));g.onsuccess=p=>{const u=p.target.result;u&&(u.delete(),u.continue())},a.oncomplete=()=>{n()},a.onerror=p=>{o("Error deleting conversation from IndexedDB")}})}async function Ae(h){const e=await L();return new Promise((n,o)=>{const d=e.transaction([I],"readonly").objectStore(I).index("conversationId").getAll(h);d.onerror=g=>{o("Error getting messages from IndexedDB")},d.onsuccess=g=>{n(g.target.result)}})}async function pe(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([I],"readwrite").objectStore(I).add(h);c.onerror=d=>{o("Error adding message to IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function Pe(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([I],"readwrite").objectStore(I).put(h);c.onerror=d=>{o("Error updating message in IndexedDB")},c.onsuccess=d=>{n(d.target.result)}})}async function Be(h){const e=await L();return new Promise((n,o)=>{const c=e.transaction([I],"readwrite").objectStore(I).delete(h);c.onerror=d=>{o("Error removing message from IndexedDB")},c.onsuccess=d=>{n()}})}async function Le(h){const e=await L();return new Promise((n,o)=>{const a=e.transaction([I],"readwrite"),d=a.objectStore(I).index("conversationId").openCursor(IDBKeyRange.only(h));d.onsuccess=g=>{const p=g.target.result;p&&(p.delete(),p.continue())},a.oncomplete=()=>{n()},a.onerror=g=>{o("Error clearing messages from IndexedDB")}})}async function Ne(h){const{messages:e,...n}=h;delete n.id;const o=await he(n);for(const a of e)delete a.id,a.conversationId=o,await pe(a)}window.db={getConversations:Me,addConversation:he,updateConversation:ke,deleteConversation:Se,getMessages:Ae,addMessage:pe,updateMessage:Pe,removeMessage:Be,clearMessages:Le,importConversation:Ne};function ae(h){if(!h)return"";let e=h.trim();for(;e.endsWith("/");)e=e.slice(0,-1);return e?e+"/":""}class Te{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.init()}async init(){await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(e){const n=await window.db.addConversation(e),o={...e,id:n};return this.conversations.push(o),o}async updateConversation(e){await window.db.updateConversation(e);const n=this.conversations.findIndex(o=>o.id===e.id);n!==-1&&(this.conversations[n]=e)}async deleteConversation(e){await window.db.deleteConversation(e),this.conversations=this.conversations.filter(n=>n.id!==e),this.currentConversationId===e&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(e){this.currentConversationId=e,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const e=localStorage.getItem("llm_models");return e?JSON.parse(e):[{modelName:"gemini-2.5-flash-lite",nickname:"flash-lite",apiKey:"",temperature:.7,maxOutputTokens:65536,proxy:"",system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576},{modelName:"gemini-2.5-pro",nickname:"pro",apiKey:"",temperature:.7,maxOutputTokens:65536,proxy:"",system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576}]}async fetchModelInfo(e){const{modelName:n,apiKey:o,proxy:a}=e,c=`${ae(a)}https://generativelanguage.googleapis.com/v1beta/models/${n}`;try{const d=await fetch(c,{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":o,"ngrok-skip-browser-warning":"true"}});if(!d.ok)return{...e,maxTokens:0};const g=await d.json();return{...e,maxTokens:g.inputTokenLimit}}catch{return{...e,maxTokens:0}}}async fetchAndSetModels(){const e=this.getModels(),n=await Promise.all(e.map(o=>this.fetchModelInfo(o)));this.models=n}async saveModels(e){const n=e.map(o=>{const{maxTokens:a,...l}=o;return l});localStorage.setItem("llm_models",JSON.stringify(n)),await this.fetchAndSetModels()}addModel(e){this.models.push(e),this.saveModels(this.models)}updateModel(e,n){this.models[e]=n,this.saveModels(this.models)}removeModel(e){this.models.splice(e,1),this.saveModels(this.models)}getCurrentModel(){return this.models[this.currentModelIndex]}cycleModel(){return this.currentModelIndex=(this.currentModelIndex+1)%this.models.length,this.saveCurrentModelIndex(),this.getCurrentModel()}getCurrentModelIndex(){const e=localStorage.getItem("current_model_index");return e?parseInt(e,10):0}saveCurrentModelIndex(){localStorage.setItem("current_model_index",this.currentModelIndex)}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(e){return this.messages.find(n=>n.id===e)}async addMessage(e){if(!this.currentConversationId){const l=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=l.id,this.saveCurrentConversationId()}const n={...e,conversationId:this.currentConversationId},o=await window.db.addMessage(n),a={...n,id:o};return this.messages.push(a),a}async updateMessage(e,n,o){const a=await this.getMessage(e);return a.content=n,o&&(a.files=o),await window.db.updateMessage(a),a}async removeMessage(e){await window.db.removeMessage(e),this.messages=this.messages.filter(n=>n.id!==e)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async countTokens(e){const n=this.getCurrentModel(),{modelName:o,apiKey:a,proxy:l}=n,d=`${ae(l)}https://generativelanguage.googleapis.com/v1beta/models/${o}:countTokens`,p={contents:e.map(u=>{const C=[{text:u.content}];return u.files&&u.files.forEach(b=>{C.push({inline_data:{mime_type:b.type,data:b.data.split(",")[1]}})}),{role:u.sender==="User"?"user":"model",parts:C}})};try{const u=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":a,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(p)});if(!u.ok){const b=await u.json().catch(()=>({}));throw new Error(`API Error: ${u.status} ${u.statusText} - ${b.error?.message||"Unknown error"}`)}return(await u.json()).totalTokens}catch(u){return console.error("Token count failed:",u),0}}async _generateContent(e,n){const o=this.getCurrentModel(),{modelName:a,apiKey:l,temperature:c,system_prompt:d,useGoogleSearch:g,useUrlContext:p,maxOutputTokens:u,prependSystemPrompt:C,thinkingBudget:b,proxy:R}=o;let M;const K=`${ae(R)}https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent`,k=e.map(E=>{const F=[{text:E.content}];return E.files&&E.files.forEach(V=>{F.push({inline_data:{mime_type:V.type,data:V.data.split(",")[1]}})}),{role:E.sender==="User"?"user":"model",parts:F}});if(C){const E=k[k.length-1];E.role==="user"&&(E.parts[0].text=`${d}

${E.parts[0].text}`)}M={contents:k,generationConfig:{temperature:c,topK:1,topP:1,maxOutputTokens:u||2048,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]},C||(M.systemInstruction={role:"user",parts:[{text:d}]});const P=[];g&&P.push({google_search:{}}),p&&P.push({url_context:{}}),P.length>0&&(M.tools=P),b&&(M.generationConfig.thinkingConfig={thinkingBudget:b});const x=await fetch(K,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":l,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(M),signal:n});if(!x.ok){const E=await x.json().catch(()=>({}));throw new Error(`API Error: ${x.status} ${x.statusText} - ${E.error?.message||"Unknown error"}`)}const N=(await x.json()).candidates[0].content;return N&&N.parts?N.parts.map(E=>E.text).join(""):"[The model sent an empty response.]"}async sendMessage(e){const o={sender:"Assistant",content:await this._generateContent(e)};return await this.addMessage(o)}async compressConversation(e,n,o){if(o?.aborted)return;const a=this.conversations.find(u=>u.id===e);if(!a)throw new Error("Conversation not found");const l=await window.db.getMessages(e),c=Math.ceil(l.length/4),d=`[Compressed] ${a.name}`,g=await this.addConversation({name:d,timestamp:Date.now()}),p=async()=>{await this.deleteConversation(g.id),o.removeEventListener("abort",p)};o?.addEventListener("abort",p);for(let u=0;u<l.length;u+=4){if(o?.aborted)throw new DOMException("Aborted by user","AbortError");const C=u/4+1;n&&n(C,c);const M=`You are a Specialized Context Preservation and Compression Engine. Your primary goal is to losslessly (or near-losslessly) compress the provided multi-turn conversation history into a single, highly dense, and concise textual block. This block must function as a perfect summary and contextual anchor for a subsequent LLM to pick up the conversation as if it had access to the full original transcript.

Your output should only contain the compressed message, with no additional commentary or explanations.

Preserve the original writing style of the conversation to some extent in the compressed output.

Here is the conversation snippet:

${l.slice(u,u+4).map(k=>`${k.sender}: ${k.content}`).join(`
`)}`,K={sender:"Assistant",content:await this._generateContent([{sender:"User",content:M}],o),conversationId:g.id};await window.db.addMessage(K)}return o?.removeEventListener("abort",p),g}}window.chatAPI=new Te;class $e{constructor(e){this.chatContainer=e}appendMessage(e){const n=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,o=this.createMessageElement(e);this.chatContainer.appendChild(o),n&&o.scrollIntoView({behavior:"smooth"})}renderMessages(e){this.clear(),e.forEach(n=>{const o=this.createMessageElement(n);this.chatContainer.appendChild(o)})}removeMessage(e){const n=this.chatContainer.querySelector(`[data-id='${e}']`);n&&n.remove()}editMessage(e){const n=this.chatContainer.querySelector(`[data-id='${e.id}']`);if(n){const o=this.createMessageElement(e);n.replaceWith(o)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(e){const n=document.createElement("div");let o="bg-gray-300 dark:bg-gray-700",a="self-start";e.sender==="User"?(o="bg-blue-500 text-white",a="self-end"):e.sender==="Error"&&(o="bg-red-500 text-white"),n.className=`p-3 rounded-lg ${o} w-full ${a} message`,n.dataset.id=e.id;const l=document.createElement("div");if(l.className="message-content",l.innerHTML=marked.parse(e.content,{breaks:!0}),n.appendChild(l),e.files&&e.files.length>0){const c=document.createElement("div");c.className="flex flex-wrap gap-2 mt-2",e.files.forEach(d=>{const g=document.createElement("div");g.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const p=document.createElement("span");p.className="mr-2 text-gray-800 dark:text-gray-200",p.style.wordBreak="break-all",p.textContent=d.name,g.appendChild(p);const u=document.createElement("button");u.textContent="â¬‡ï¸",u.className="download-file-btn",u.addEventListener("click",()=>{const C=document.createElement("a");C.href=d.data,C.download=d.name,C.click()}),g.appendChild(u),c.appendChild(g)}),n.appendChild(c)}return n.querySelectorAll("pre").forEach(c=>{const d=c.querySelector("code"),g=d.className.split("-")[1]||"",p=document.createElement("div");p.className="code-block-container";const u=document.createElement("div");u.className="code-block-header";const C=document.createElement("span");C.textContent=g,u.appendChild(C);const b=document.createElement("button");b.textContent="Copy",b.className="copy-code-btn",u.appendChild(b),p.appendChild(u),p.appendChild(c.cloneNode(!0)),c.replaceWith(p),hljs.highlightElement(p.querySelector("pre code")),b.addEventListener("click",R=>{R.stopPropagation();const M=d.innerText;navigator.clipboard.writeText(M).then(()=>{b.textContent="Copied!",setTimeout(()=>{b.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),e.sender!=="Error"&&n.addEventListener("click",c=>{const d=new CustomEvent("message-selected",{detail:{messageElement:n,x:c.clientX,y:c.clientY}});this.chatContainer.dispatchEvent(d)}),n}}window.ChatView=$e;document.addEventListener("DOMContentLoaded",()=>{const h=document.getElementById("cycle-model-btn"),e=document.getElementById("model-nickname"),n=document.getElementById("token-count-display"),o=document.getElementById("settings-btn"),a=document.getElementById("history-btn"),l=document.getElementById("chat-container"),c=document.getElementById("resize-handle"),d=document.getElementById("message-input"),g=document.getElementById("send-btn"),p=document.getElementById("settings-modal"),u=document.getElementById("llm-configs-container"),C=document.getElementById("add-model-btn"),b=document.getElementById("save-settings-btn"),R=document.getElementById("close-settings-btn"),M=document.getElementById("history-modal"),O=document.getElementById("conversations-container"),K=document.getElementById("add-conversation-btn"),k=document.getElementById("rename-conversation-btn"),P=document.getElementById("delete-conversation-btn"),x=document.getElementById("compress-conversation-btn"),re=document.getElementById("import-conversation-btn"),N=document.getElementById("export-conversation-btn"),E=document.getElementById("load-conversation-btn"),F=document.getElementById("close-history-btn"),V=document.getElementById("clear-chat-btn"),we=document.getElementById("import-settings-btn"),ve=document.getElementById("export-settings-btn");document.getElementById("copy-chat-btn");const z=document.querySelector("footer"),ye=document.getElementById("attach-file-btn"),ne=document.getElementById("attached-files-container"),J=document.getElementById("cancel-edit-btn");let S=[],Y=null,W=null,y=null,fe=z.offsetHeight;const f=new window.ChatView(l);l.addEventListener("message-selected",t=>{const{messageElement:r,x:s,y:i}=t.detail;W&&U(),W=r,Ce(r,s,i)}),document.addEventListener("click",t=>{if(!document.querySelector(".message-controls"))return;const s=t.target.closest("[data-id]"),i=t.target.closest(".message-controls");!s&&!i&&U()});const Ce=async(t,r,s)=>{const i=document.createElement("div");i.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const m=parseInt(t.dataset.id),v=document.createElement("button");v.textContent="âœï¸",v.addEventListener("click",async()=>{const H=await window.chatAPI.getMessage(m);d.value=H.content,S=H.files||[],Y=m,q(),J.classList.remove("hidden"),g.textContent="ðŸ’¾",U(),d.focus()});const w=document.createElement("button");w.textContent="ðŸ—‘ï¸",w.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await window.chatAPI.removeMessage(m),f.removeMessage(m)),U()});const T=document.createElement("button");T.textContent="ðŸ“‹",T.addEventListener("click",()=>{navigator.clipboard.writeText(t.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),U()});const $=document.createElement("button");$.textContent="ðŸ”„ï¸",$.addEventListener("click",async()=>{const H=await window.chatAPI.getMessages(),oe=H.findIndex(G=>G.id===m),be=H[oe];let j;be.sender==="User"?j=H.slice(0,oe+1):j=H.slice(0,oe),await window.chatAPI.clearMessages();for(const G of j)await window.chatAPI.addMessage(G);const Ee=l.scrollTop;f.renderMessages(j),l.scrollTop=Ee;const me=j[j.length-1];if(me&&me.sender==="User"){U(),g.disabled=!0;const G={sender:"Assistant",content:"...",id:-1};f.appendMessage(G);const ge=await window.chatAPI.sendMessage(j);f.removeMessage(-1),ge&&f.appendMessage(ge),g.disabled=!1,d.focus(),B()}}),i.appendChild(v),i.appendChild(w),i.appendChild(T),i.appendChild($),i.style.visibility="hidden",document.body.appendChild(i);const Q=i.getBoundingClientRect(),le=window.innerWidth,ue=window.innerHeight;let Z=r,ee=s;r+Q.width>le&&(Z=le-Q.width-5),s+Q.height>ue&&(ee=ue-Q.height-5),Z<0&&(Z=5),ee<0&&(ee=5),i.style.left=`${Z}px`,i.style.top=`${ee}px`,i.style.visibility="visible"},U=()=>{const t=document.querySelector(".message-controls");t&&t.remove(),W&&(W=null)},B=async()=>{const t=await window.chatAPI.getMessages(),r=await window.chatAPI.countTokens(t),s=window.chatAPI.getCurrentModel();n.textContent=`${r}/${s.maxTokens}`},_=async()=>{const t=await window.chatAPI.getConversations();t.reverse(),O.innerHTML="",y=null,k.disabled=!0,P.disabled=!0,E.disabled=!0,N.disabled=!0,x.disabled=!0;for(const s of t){const i=document.createElement("li");i.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",i.dataset.id=s.id;const m=document.createElement("span");m.className="truncate";let v=s.name;if(!v){const w=await window.db.getMessages(s.id);w.length>0?v=w[0].content.split(`
`)[0]:v="New Conversation"}m.textContent=v,i.appendChild(m),i.addEventListener("click",()=>{if(y!==null){const w=O.querySelector(`[data-id='${y}']`);w&&w.classList.remove("selected")}i.classList.add("selected"),y=s.id,k.disabled=!1,P.disabled=!1,E.disabled=!1,N.disabled=!1,x.disabled=!1,i.scrollIntoView({block:"nearest"})}),O.appendChild(i)}const r=O.querySelector(`[data-id='${window.chatAPI.currentConversationId}']`);r&&(r.classList.add("selected"),y=window.chatAPI.currentConversationId,k.disabled=!1,P.disabled=!1,E.disabled=!1,N.disabled=!1,x.disabled=!1,setTimeout(()=>{r.scrollIntoView({block:"nearest"})},0))};a.addEventListener("click",async()=>{await _(),M.classList.remove("hidden")}),F.addEventListener("click",()=>{M.classList.add("hidden")}),K.addEventListener("click",async()=>{const t=await window.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await window.chatAPI.switchConversation(t.id),f.clear(),await _(),B()}),E.addEventListener("click",async()=>{if(y!==null){await window.chatAPI.switchConversation(y);const t=await window.chatAPI.getMessages();f.renderMessages(t),M.classList.add("hidden"),B();const r=f.chatContainer.lastElementChild;r&&r.scrollIntoView({behavior:"smooth"})}}),k.addEventListener("click",async()=>{if(y!==null){const t=window.chatAPI.conversations.find(s=>s.id===y),r=prompt("Enter new conversation name:",t.name);if(r&&r.trim()!==""){t.name=r,await window.chatAPI.updateConversation(t);const s=y;await _();const i=O.querySelector(`[data-id='${s}']`);i&&setTimeout(()=>{i.click(),i.scrollIntoView({block:"nearest"})},0)}}}),P.addEventListener("click",async()=>{if(y!==null&&confirm("Are you sure you want to delete this conversation?")){let t=await window.chatAPI.getConversations();t.reverse();const r=t.findIndex(m=>m.id===y);await window.chatAPI.deleteConversation(y);let s=await window.chatAPI.getConversations();if(s.reverse(),s.length>0){let m=r;m>=s.length&&(m=s.length-1),await window.chatAPI.switchConversation(s[m].id)}else await window.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const i=await window.chatAPI.getMessages();f.renderMessages(i),await _(),B()}});let D=null;x.addEventListener("click",async()=>{if(D){D.abort(),D=null,x.textContent="ðŸ“¦";return}if(y!==null&&confirm("Are you sure you want to compress this conversation?")){D=new AbortController;const t=D.signal;x.textContent="ðŸ“¦...";const r=(s,i)=>{x.textContent=`ðŸ“¦ ${s}/${i}`};try{await window.chatAPI.compressConversation(y,r,t),await _()}catch(s){s.name!=="AbortError"?alert("Error compressing conversation: "+s.message):(alert("Compression cancelled."),await _())}finally{D=null,x.textContent="ðŸ“¦"}}}),N.addEventListener("click",async()=>{if(y!==null){const t=window.chatAPI.conversations.find(T=>T.id===y),r=await window.db.getMessages(y),s={...t,messages:r};let i=t.name;!i&&r.length>0&&(i=r[0].content.split(`
`)[0]);const m=i.replace(/[^a-z0-9]/gi,"_").toLowerCase(),v="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s,null,2)),w=document.createElement("a");w.setAttribute("href",v),w.setAttribute("download",`${m}.json`),document.body.appendChild(w),w.click(),w.remove()}}),re.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async r=>{const s=r.target.files[0],i=new FileReader;i.onload=async m=>{try{const v=m.target.result,w=JSON.parse(v);await window.db.importConversation(w),await _(),alert("Conversation imported successfully!")}catch(v){alert("Error importing conversation: "+v.message)}},i.readAsText(s)},t.click()});const X=()=>{u.innerHTML="",window.chatAPI.getModels().forEach((t,r)=>{const s=document.createElement("div");s.className="mb-4 p-4 border border-black rounded-lg dark:border-black",s.innerHTML=`
                                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-lg font-semibold">${t.nickname}</h3>
                    <button type="button" class="remove-model-btn text-xl" data-index="${r}">âž–</button>
                </div>
                <input type="text" value="${t.proxy||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Proxy URL">
                <input type="text" value="${t.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
                <input type="text" value="${t.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
                <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${t.system_prompt}</textarea>
                                <input type="text" value="${t.apiKey||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
                <input type="number" step="0.1" value="${t.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
                <input type="number" value="${t.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">

                <input type="number" value="${t.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Thinking Budget (tokens)">
                <div class="google-search-container">
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="google-search-checkbox-${r}" class="mr-2" ${t.useGoogleSearch?"checked":""}>
                        <label for="google-search-checkbox-${r}">Enable Google Search</label>
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="prepend-system-prompt-checkbox-${r}" class="mr-2" ${t.prependSystemPrompt?"checked":""}>
                        <label for="prepend-system-prompt-checkbox-${r}">Prepend System Prompt</label>
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="url-context-checkbox-${r}" class="mr-2" ${t.useUrlContext?"checked":""}>
                        <label for="url-context-checkbox-${r}">Enable URL Context</label>
                    </div>
                </div>
            `,u.appendChild(s)}),document.querySelectorAll(".remove-model-btn").forEach(t=>{t.addEventListener("click",r=>{const s=r.target.dataset.index;window.chatAPI.removeModel(s),X()})})};h.addEventListener("click",()=>{const t=window.chatAPI.cycleModel();e.textContent=t.nickname,B()}),o.addEventListener("click",()=>{X(),p.classList.remove("hidden")}),R.addEventListener("click",()=>{p.classList.add("hidden")}),C.addEventListener("click",()=>{window.chatAPI.addModel({modelName:"gemini-2.5-flash-lite",apiKey:"",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192,proxy:""}),X()}),b.addEventListener("click",async t=>{t.preventDefault();const r=Array.from(u.children).map(s=>({modelName:s.querySelector('input[placeholder="Model Name"]').value,nickname:s.querySelector('input[placeholder="Nickname"]').value,apiKey:s.querySelector('input[placeholder="API Key"]').value,temperature:parseFloat(s.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(s.querySelector('input[placeholder="Max Output Tokens"]').value,10),proxy:s.querySelector('input[placeholder="Proxy URL"]').value,system_prompt:s.querySelector("textarea").value,useGoogleSearch:s.querySelector('input[id^="google-search-checkbox-"]').checked,useUrlContext:s.querySelector('input[id^="url-context-checkbox-"]').checked,prependSystemPrompt:s.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked,thinkingBudget:parseInt(s.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)}));await window.chatAPI.saveModels(r),p.classList.add("hidden"),e.textContent=window.chatAPI.getCurrentModel().nickname,B()});const q=()=>{ne.innerHTML="",S.forEach((m,v)=>{const w=document.createElement("div");w.className="attached-file-item";const T=document.createElement("span");T.textContent=m.name,w.appendChild(T);const $=document.createElement("button");$.className="remove-file-btn",$.textContent="âŒ",$.addEventListener("click",()=>{S.splice(v,1),q()}),w.appendChild($),ne.appendChild(w)});const i=z.querySelector(".flex-grow").scrollHeight-d.offsetHeight+90;z.offsetHeight<i&&(z.style.height=`${i}px`)};ye.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.addEventListener("change",r=>{const s=r.target.files;for(let i=0;i<s.length;i++){const m=s[i],v=new FileReader;v.onload=w=>{S.push({name:m.name,type:m.type,data:w.target.result}),q()},v.readAsDataURL(m)}}),t.click()}),g.addEventListener("click",async()=>{const t=d.value.trim();if(t||S.length>0)if(Y!==null){const r=await window.chatAPI.updateMessage(Y,t,S);f.editMessage(r),Y=null,J.classList.add("hidden"),g.textContent="â–¶ï¸",d.value="",S=[],q()}else{const r={sender:"User",content:t,files:S},s=await window.chatAPI.addMessage(r);f.appendMessage(s),d.value="",S=[],q(),g.disabled=!0;const i={sender:"Assistant",content:"...",id:-1};f.appendMessage(i);try{const m=await window.chatAPI.sendMessage(await window.chatAPI.getMessages());f.removeMessage(-1),m&&f.appendMessage(m)}catch(m){f.removeMessage(-1);const v={sender:"Error",content:`An error occurred: ${m.message}`,id:Date.now()};f.appendMessage(v)}finally{g.disabled=!1,B()}}}),J.addEventListener("click",()=>{d.value="",S=[],Y=null,q(),J.classList.add("hidden"),g.textContent="â–¶ï¸"}),d.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&(t.preventDefault(),g.click())});let se=!1;const ie=t=>{se=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},ce=t=>{if(se){const r=t.clientY||t.touches&&t.touches[0].clientY;if(r===void 0)return;let s=window.innerHeight-r;const i=fe+ne.offsetHeight,m=500;s<i&&(s=i),s>m&&(s=m),z.style.height=`${s}px`}},de=()=>{se=!1,document.body.style.userSelect="",document.body.style.cursor=""};c.addEventListener("mousedown",ie),document.addEventListener("mousemove",ce),document.addEventListener("mouseup",de),c.addEventListener("touchstart",ie,{passive:!0}),document.addEventListener("touchmove",ce),document.addEventListener("touchend",de),V.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await window.chatAPI.clearMessages(),f.clear(),B())}),ve.addEventListener("click",()=>{const t=window.chatAPI.getModels(),r="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t,null,2)),s=document.createElement("a");s.setAttribute("href",r),s.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(s),s.click(),s.remove()}),we.addEventListener("click",()=>{const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=r=>{const s=r.target.files[0],i=new FileReader;i.onload=m=>{try{const v=m.target.result,w=JSON.parse(v);window.chatAPI.saveModels(w),X(),e.textContent=window.chatAPI.getCurrentModel().nickname,alert("Settings imported successfully!")}catch(v){alert("Error importing settings: "+v.message)}},i.readAsText(s)},t.click()}),(async()=>{await window.chatAPI.init();const t=window.chatAPI.getCurrentModel();t?e.textContent=t.nickname:(e.textContent="No Model",g.disabled=!0);const r=await window.chatAPI.getMessages();f.renderMessages(r),B(),q()})()});
