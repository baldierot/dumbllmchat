(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))r(c);new MutationObserver(c=>{for(const n of c)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function o(c){const n={};return c.integrity&&(n.integrity=c.integrity),c.referrerPolicy&&(n.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?n.credentials="include":c.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(c){if(c.ep)return;c.ep=!0;const n=o(c);fetch(c.href,n)}})();const H="dumbllmchat_db",j=2,C="messages",x="conversations";let L;function B(){return new Promise((e,t)=>{if(L)return e(L);const o=indexedDB.open(H,j);o.onerror=r=>{t("Error opening IndexedDB")},o.onsuccess=r=>{L=r.target.result,e(L)},o.onupgradeneeded=r=>{const c=r.target.result;if(c.objectStoreNames.contains(x)||c.createObjectStore(x,{keyPath:"id",autoIncrement:!0}),!c.objectStoreNames.contains(C))c.createObjectStore(C,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const i=r.target.transaction.objectStore(C);i.indexNames.contains("conversationId")||i.createIndex("conversationId","conversationId",{unique:!1})}}})}async function R(){const e=await B();return new Promise((t,o)=>{const n=e.transaction([x],"readonly").objectStore(x).getAll();n.onerror=i=>{o("Error getting conversations from IndexedDB")},n.onsuccess=i=>{t(i.target.result)}})}async function _(e){const t=await B();return new Promise((o,r)=>{const i=t.transaction([x],"readwrite").objectStore(x).add(e);i.onerror=s=>{r("Error adding conversation to IndexedDB")},i.onsuccess=s=>{o(s.target.result)}})}async function V(e){const t=await B();return new Promise((o,r)=>{const i=t.transaction([x],"readwrite").objectStore(x).put(e);i.onerror=s=>{r("Error updating conversation in IndexedDB")},i.onsuccess=s=>{o(s.target.result)}})}async function D(e){const t=await B();return new Promise((o,r)=>{const c=t.transaction([x,C],"readwrite"),n=c.objectStore(x),i=c.objectStore(C);n.delete(e);const d=i.index("conversationId").openCursor(IDBKeyRange.only(e));d.onsuccess=l=>{const u=l.target.result;u&&(u.delete(),u.continue())},c.oncomplete=()=>{o()},c.onerror=l=>{r("Error deleting conversation from IndexedDB")}})}async function F(e){const t=await B();return new Promise((o,r)=>{const s=t.transaction([C],"readonly").objectStore(C).index("conversationId").getAll(e);s.onerror=d=>{r("Error getting messages from IndexedDB")},s.onsuccess=d=>{o(d.target.result)}})}async function q(e){const t=await B();return new Promise((o,r)=>{const i=t.transaction([C],"readwrite").objectStore(C).add(e);i.onerror=s=>{r("Error adding message to IndexedDB")},i.onsuccess=s=>{o(s.target.result)}})}async function U(e){const t=await B();return new Promise((o,r)=>{const i=t.transaction([C],"readwrite").objectStore(C).put(e);i.onerror=s=>{r("Error updating message in IndexedDB")},i.onsuccess=s=>{o(s.target.result)}})}async function z(e){const t=await B();return new Promise((o,r)=>{const i=t.transaction([C],"readwrite").objectStore(C).delete(e);i.onerror=s=>{r("Error removing message from IndexedDB")},i.onsuccess=s=>{o()}})}async function K(e){const t=await B();return new Promise((o,r)=>{const c=t.transaction([C],"readwrite"),s=c.objectStore(C).index("conversationId").openCursor(IDBKeyRange.only(e));s.onsuccess=d=>{const l=d.target.result;l&&(l.delete(),l.continue())},c.oncomplete=()=>{o()},c.onerror=d=>{r("Error clearing messages from IndexedDB")}})}async function Y(e){const{messages:t,...o}=e;delete o.id;const r=await _(o);for(const c of t)delete c.id,c.conversationId=r,await q(c)}window.db={getConversations:R,addConversation:_,updateConversation:V,deleteConversation:D,getMessages:F,addMessage:q,updateMessage:U,removeMessage:z,clearMessages:K,importConversation:Y};function T(e){if(!e)return"";let t=e.trim();for(;t.endsWith("/");)t=t.slice(0,-1);return t?t+"/":""}class G{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.init()}async init(){await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(t){const o=await window.db.addConversation(t),r={...t,id:o};return this.conversations.push(r),r}async updateConversation(t){await window.db.updateConversation(t);const o=this.conversations.findIndex(r=>r.id===t.id);o!==-1&&(this.conversations[o]=t)}async deleteConversation(t){await window.db.deleteConversation(t),this.conversations=this.conversations.filter(o=>o.id!==t),this.currentConversationId===t&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(t){this.currentConversationId=t,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const t=localStorage.getItem("llm_models");return t?JSON.parse(t):[{modelName:"gemini-2.5-flash-lite",nickname:"flash-lite",apiKey:"",temperature:.7,maxOutputTokens:65536,proxy:"",system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576},{modelName:"gemini-2.5-pro",nickname:"pro",apiKey:"",temperature:.7,maxOutputTokens:65536,proxy:"",system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576}]}async fetchModelInfo(t){const{modelName:o,apiKey:r,proxy:c}=t,i=`${T(c)}https://generativelanguage.googleapis.com/v1beta/models/${o}`;try{const s=await fetch(i,{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":r,"ngrok-skip-browser-warning":"true"}});if(!s.ok)return{...t,maxTokens:0};const d=await s.json();return{...t,maxTokens:d.inputTokenLimit}}catch{return{...t,maxTokens:0}}}async fetchAndSetModels(){const t=this.getModels(),o=await Promise.all(t.map(r=>this.fetchModelInfo(r)));this.models=o}async saveModels(t){const o=t.map(r=>{const{maxTokens:c,...n}=r;return n});localStorage.setItem("llm_models",JSON.stringify(o)),await this.fetchAndSetModels()}addModel(t){this.models.push(t),this.saveModels(this.models)}updateModel(t,o){this.models[t]=o,this.saveModels(this.models)}removeModel(t){this.models.splice(t,1),this.saveModels(this.models)}getCurrentModel(){return this.models[this.currentModelIndex]}cycleModel(){return this.currentModelIndex=(this.currentModelIndex+1)%this.models.length,this.saveCurrentModelIndex(),this.getCurrentModel()}getCurrentModelIndex(){const t=localStorage.getItem("current_model_index");return t?parseInt(t,10):0}saveCurrentModelIndex(){localStorage.setItem("current_model_index",this.currentModelIndex)}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(t){return this.messages.find(o=>o.id===t)}async addMessage(t){if(!this.currentConversationId){const n=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=n.id,this.saveCurrentConversationId()}const o={...t,conversationId:this.currentConversationId},r=await window.db.addMessage(o),c={...o,id:r};return this.messages.push(c),c}async updateMessage(t,o,r){const c=await this.getMessage(t);return c.content=o,r&&(c.files=r),await window.db.updateMessage(c),c}async removeMessage(t){await window.db.removeMessage(t),this.messages=this.messages.filter(o=>o.id!==t)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async countTokens(t){const o=this.getCurrentModel(),{modelName:r,apiKey:c,proxy:n}=o,s=`${T(n)}https://generativelanguage.googleapis.com/v1beta/models/${r}:countTokens`,l={contents:t.map(u=>{const m=[{text:u.content}];return u.files&&u.files.forEach(h=>{m.push({inline_data:{mime_type:h.type,data:h.data.split(",")[1]}})}),{role:u.sender==="User"?"user":"model",parts:m}})};try{const u=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":c,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(l)});if(!u.ok){const h=await u.json().catch(()=>({}));throw new Error(`API Error: ${u.status} ${u.statusText} - ${h.error?.message||"Unknown error"}`)}return(await u.json()).totalTokens}catch(u){return console.error("Token count failed:",u),0}}async _generateContent(t,o){const r=this.getCurrentModel(),{modelName:c,apiKey:n,temperature:i,system_prompt:s,useGoogleSearch:d,useUrlContext:l,maxOutputTokens:u,prependSystemPrompt:m,thinkingBudget:h,proxy:b}=r;let v;const E=`${T(b)}https://generativelanguage.googleapis.com/v1beta/models/${c}:generateContent`,w=t.map(y=>{const $=[{text:y.content}];return y.files&&y.files.forEach(O=>{$.push({inline_data:{mime_type:O.type,data:O.data.split(",")[1]}})}),{role:y.sender==="User"?"user":"model",parts:$}});if(m){const y=w[w.length-1];y.role==="user"&&(y.parts[0].text=`${s}

${y.parts[0].text}`)}v={contents:w,generationConfig:{temperature:i,topK:1,topP:1,maxOutputTokens:u||2048,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]},m||(v.systemInstruction={role:"user",parts:[{text:s}]});const f=[];d&&f.push({google_search:{}}),l&&f.push({url_context:{}}),f.length>0&&(v.tools=f),h&&(v.generationConfig.thinkingConfig={thinkingBudget:h});const g=await fetch(E,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":n,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(v),signal:o});if(!g.ok){const y=await g.json().catch(()=>({}));throw new Error(`API Error: ${g.status} ${g.statusText} - ${y.error?.message||"Unknown error"}`)}const M=await g.json();if(!M.candidates||M.candidates.length===0)return"[The model sent an empty response.]";const p=M.candidates[0].content;return p&&p.parts?p.parts.map(y=>y.text).join(""):"[The model sent an empty response.]"}async sendMessage(t){const r={sender:"Assistant",content:await this._generateContent(t)};return await this.addMessage(r)}async compressConversation(t,o,r){if(r?.aborted)return;const c=this.conversations.find(u=>u.id===t);if(!c)throw new Error("Conversation not found");const n=await window.db.getMessages(t);if(n.length===0)throw new Error("Cannot compress an empty conversation.");const i=Math.ceil(n.length/4),s=`[Compressed] ${c.name}`,d=await this.addConversation({name:s,timestamp:Date.now()}),l=async()=>{await this.deleteConversation(d.id),r.removeEventListener("abort",l)};r?.addEventListener("abort",l);for(let u=0;u<n.length;u+=4){if(r?.aborted)throw new DOMException("Aborted by user","AbortError");const m=u/4+1;o&&o(m,i);const b=n.slice(u,u+4).map(g=>`${g.sender}: ${g.content}`).join(`
`);let v="";if(u>0){const g=n.slice(Math.max(0,u-16),u);g.length>0&&(v=`

Here is a supplementary context from the previous part of the conversation:
${g.map(p=>`${p.sender}: ${p.content}`).join(`
`)}`)}const I=`You are a Specialized Context Preservation and Compression Engine. Your primary goal is to losslessly (or near-losslessly) compress the provided multi-turn conversation history into a single, highly dense, and concise textual block. This block must function as a perfect summary and contextual anchor for a subsequent LLM to pick up the conversation as if it had access to the full original transcript.

Your output should only contain the compressed message of the given conversation snippet, with no additional commentary or explanations. Do not include the supplementary context in your output.

Preserve the original writing style of the conversation to some extent in the compressed output.${v}

Here is the conversation snippet to compress (and not the supplementary context):

${b}`,E=3;let w="";for(let g=0;g<E;g++){if(r?.aborted)throw new DOMException("Aborted by user","AbortError");if(w=await this._generateContent([{sender:"User",content:I}],r),w.trim()!==""&&w!=="[The model sent an empty response.]")break;g<E-1&&await new Promise(M=>setTimeout(M,1e3))}if(w.trim()===""||w==="[The model sent an empty response.]")throw new Error(`Compression failed for a chunk after ${E} retries.`);const f={sender:"Assistant",content:w,conversationId:d.id};await window.db.addMessage(f)}return r?.removeEventListener("abort",l),d}}window.chatAPI=new G;class J{constructor(t){this.chatContainer=t}appendMessage(t){const o=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,r=this.createMessageElement(t);this.chatContainer.appendChild(r),o&&r.scrollIntoView({behavior:"smooth"})}renderMessages(t){this.clear(),t.forEach(o=>{const r=this.createMessageElement(o);this.chatContainer.appendChild(r)})}removeMessage(t){const o=this.chatContainer.querySelector(`[data-id='${t}']`);o&&o.remove()}editMessage(t){const o=this.chatContainer.querySelector(`[data-id='${t.id}']`);if(o){const r=this.createMessageElement(t);o.replaceWith(r)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(t){const o=document.createElement("div");let r="bg-gray-300 dark:bg-gray-700",c="self-start";t.sender==="User"?(r="bg-blue-500 text-white",c="self-end"):t.sender==="Error"&&(r="bg-red-500 text-white"),o.className=`p-3 rounded-lg ${r} w-full ${c} message`,o.dataset.id=t.id;const n=document.createElement("div");if(n.className="message-content",n.innerHTML=marked.parse(t.content,{breaks:!0}),o.appendChild(n),t.files&&t.files.length>0){const i=document.createElement("div");i.className="flex flex-wrap gap-2 mt-2",t.files.forEach(s=>{const d=document.createElement("div");d.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const l=document.createElement("span");l.className="mr-2 text-gray-800 dark:text-gray-200",l.style.wordBreak="break-all",l.textContent=s.name,d.appendChild(l);const u=document.createElement("button");u.textContent="â¬‡ï¸",u.className="download-file-btn",u.addEventListener("click",()=>{const m=document.createElement("a");m.href=s.data,m.download=s.name,m.click()}),d.appendChild(u),i.appendChild(d)}),o.appendChild(i)}return o.querySelectorAll("pre").forEach(i=>{const s=i.querySelector("code"),d=s.className.split("-")[1]||"",l=document.createElement("div");l.className="code-block-container";const u=document.createElement("div");u.className="code-block-header";const m=document.createElement("span");m.textContent=d,u.appendChild(m);const h=document.createElement("button");h.textContent="Copy",h.className="copy-code-btn",u.appendChild(h),l.appendChild(u),l.appendChild(i.cloneNode(!0)),i.replaceWith(l),hljs.highlightElement(l.querySelector("pre code")),h.addEventListener("click",b=>{b.stopPropagation();const v=s.innerText;navigator.clipboard.writeText(v).then(()=>{h.textContent="Copied!",setTimeout(()=>{h.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),t.sender!=="Error"&&o.addEventListener("click",i=>{const s=new CustomEvent("message-selected",{detail:{messageElement:o,x:i.clientX,y:i.clientY}});this.chatContainer.dispatchEvent(s)}),o}}window.ChatView=J;const a={cycleModelBtn:document.getElementById("cycle-model-btn"),modelNickname:document.getElementById("model-nickname"),tokenCountDisplay:document.getElementById("token-count-display"),settingsBtn:document.getElementById("settings-btn"),historyBtn:document.getElementById("history-btn"),chatContainer:document.getElementById("chat-container"),resizeHandle:document.getElementById("resize-handle"),messageInput:document.getElementById("message-input"),sendBtn:document.getElementById("send-btn"),settingsModal:document.getElementById("settings-modal"),llmConfigsContainer:document.getElementById("llm-configs-container"),addModelBtn:document.getElementById("add-model-btn"),saveSettingsBtn:document.getElementById("save-settings-btn"),closeSettingsBtn:document.getElementById("close-settings-btn"),historyModal:document.getElementById("history-modal"),conversationsContainer:document.getElementById("conversations-container"),addConversationBtn:document.getElementById("add-conversation-btn"),renameConversationBtn:document.getElementById("rename-conversation-btn"),deleteConversationBtn:document.getElementById("delete-conversation-btn"),compressConversationBtn:document.getElementById("compress-conversation-btn"),importConversationBtn:document.getElementById("import-conversation-btn"),exportConversationBtn:document.getElementById("export-conversation-btn"),loadConversationBtn:document.getElementById("load-conversation-btn"),closeHistoryBtn:document.getElementById("close-history-btn"),clearChatBtn:document.getElementById("clear-chat-btn"),importSettingsBtn:document.getElementById("import-settings-btn"),exportSettingsBtn:document.getElementById("export-settings-btn"),copyChatBtn:document.getElementById("copy-chat-btn"),footer:document.querySelector("footer"),attachFileBtn:document.getElementById("attach-file-btn"),attachedFilesContainer:document.getElementById("attached-files-container"),cancelEditBtn:document.getElementById("cancel-edit-btn")};function W(e,t,o,r){const c=document.createElement("div");c.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const n=parseInt(e.dataset.id),i=document.createElement("button");i.textContent="âœï¸",i.addEventListener("click",async()=>{const I=await r.chatAPI.getMessage(n);a.messageInput.value=I.content,r.attachedFiles=I.files||[],r.editingMessageId=n,A(r),a.cancelEditBtn.classList.remove("hidden"),a.sendBtn.textContent="ðŸ’¾",P(),a.messageInput.focus()});const s=document.createElement("button");s.textContent="ðŸ—‘ï¸",s.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await r.chatAPI.removeMessage(n),r.chatView.removeMessage(n)),P()});const d=document.createElement("button");d.textContent="ðŸ“‹",d.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),P()});const l=document.createElement("button");l.textContent="ðŸ”„ï¸",l.addEventListener("click",async()=>{const I=await r.chatAPI.getMessages(),E=I.findIndex(p=>p.id===n),w=I[E];let f;w.sender==="User"?f=I.slice(0,E+1):f=I.slice(0,E),await r.chatAPI.clearMessages();for(const p of f)await r.chatAPI.addMessage(p);const g=a.chatContainer.scrollTop;r.chatView.renderMessages(f),a.chatContainer.scrollTop=g;const M=f[f.length-1];if(M&&M.sender==="User"){P(),a.sendBtn.disabled=!0;const p={sender:"Assistant",content:"...",id:-1};r.chatView.appendMessage(p);const y=await r.chatAPI.sendMessage(f);r.chatView.removeMessage(-1),y&&r.chatView.appendMessage(y),a.sendBtn.disabled=!1,a.messageInput.focus(),k(r.chatAPI)}}),c.appendChild(i),c.appendChild(s),c.appendChild(d),c.appendChild(l),c.style.visibility="hidden",document.body.appendChild(c);const u=c.getBoundingClientRect(),m=window.innerWidth,h=window.innerHeight;let b=t,v=o;t+u.width>m&&(b=m-u.width-5),o+u.height>h&&(v=h-u.height-5),b<0&&(b=5),v<0&&(v=5),c.style.left=`${b}px`,c.style.top=`${v}px`,c.style.visibility="visible"}function P(){const e=document.querySelector(".message-controls");e&&e.remove()}async function k(e){const t=await e.getMessages(),o=await e.countTokens(t),r=e.getCurrentModel();a.tokenCountDisplay.textContent=`${o}/${r.maxTokens}`}async function S(e){const t=await e.chatAPI.getConversations();t.reverse(),a.conversationsContainer.innerHTML="",e.selectedConversationId=null,a.renameConversationBtn.disabled=!0,a.deleteConversationBtn.disabled=!0,a.loadConversationBtn.disabled=!0,a.exportConversationBtn.disabled=!0,a.compressConversationBtn.disabled=!0;for(const r of t){const c=document.createElement("li");c.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",c.dataset.id=r.id;const n=document.createElement("span");n.className="truncate";let i=r.name;if(!i){const s=await window.db.getMessages(r.id);s.length>0?i=s[0].content.split(`
`)[0]:i="New Conversation"}n.textContent=i,c.appendChild(n),c.addEventListener("click",()=>{if(e.selectedConversationId!==null){const s=a.conversationsContainer.querySelector(`[data-id='${e.selectedConversationId}']`);s&&s.classList.remove("selected")}c.classList.add("selected"),e.selectedConversationId=r.id,a.renameConversationBtn.disabled=!1,a.deleteConversationBtn.disabled=!1,a.loadConversationBtn.disabled=!1,a.exportConversationBtn.disabled=!1,a.compressConversationBtn.disabled=!1,c.scrollIntoView({block:"nearest"})}),a.conversationsContainer.appendChild(c)}const o=a.conversationsContainer.querySelector(`[data-id='${e.chatAPI.currentConversationId}']`);o&&(o.classList.add("selected"),e.selectedConversationId=e.chatAPI.currentConversationId,a.renameConversationBtn.disabled=!1,a.deleteConversationBtn.disabled=!1,a.loadConversationBtn.disabled=!1,a.exportConversationBtn.disabled=!1,a.compressConversationBtn.disabled=!1,setTimeout(()=>{o.scrollIntoView({block:"nearest"})},0))}function N(e){a.llmConfigsContainer.innerHTML="",e.getModels().forEach((t,o)=>{const r=document.createElement("div");r.className="mb-4 p-2 border border-black rounded-lg dark:border-black",r.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">${t.nickname}</h3>
                <button type="button" class="remove-model-btn text-xl" data-index="${o}">âž–</button>
            </div>
            <input type="text" value="${t.proxy||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Proxy URL">
            <input type="text" value="${t.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
            <input type="text" value="${t.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
            <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${t.system_prompt}</textarea>
            <input type="text" value="${t.apiKey||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="API Key">
            <input type="number" step="0.1" value="${t.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
            <input type="number" value="${t.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">
            <input type="number" value="${t.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Thinking Budget (tokens)">
            <div class="google-search-container">
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="google-search-checkbox-${o}" class="mr-2" ${t.useGoogleSearch?"checked":""}>
                    <label for="google-search-checkbox-${o}">Enable Google Search</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="prepend-system-prompt-checkbox-${o}" class="mr-2" ${t.prependSystemPrompt?"checked":""}>
                    <label for="prepend-system-prompt-checkbox-${o}">Prepend System Prompt</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="url-context-checkbox-${o}" class="mr-2" ${t.useUrlContext?"checked":""}>
                    <label for="url-context-checkbox-${o}">Enable URL Context</label>
                </div>
            </div>
        `,a.llmConfigsContainer.appendChild(r)}),document.querySelectorAll(".remove-model-btn").forEach(t=>{t.addEventListener("click",o=>{const r=o.target.dataset.index;e.removeModel(r),N(e)})})}function A(e){a.attachedFilesContainer.innerHTML="",e.attachedFiles.forEach((n,i)=>{const s=document.createElement("div");s.className="attached-file-item";const d=document.createElement("span");d.textContent=n.name,s.appendChild(d);const l=document.createElement("button");l.className="remove-file-btn",l.textContent="âŒ",l.addEventListener("click",()=>{e.attachedFiles.splice(i,1),A(e)}),s.appendChild(l),a.attachedFilesContainer.appendChild(s)});const c=a.footer.querySelector(".flex-grow").scrollHeight-a.messageInput.offsetHeight+90;a.footer.offsetHeight<c&&(a.footer.style.height=`${c}px`)}function X(e){a.chatContainer.addEventListener("message-selected",n=>{const{messageElement:i,x:s,y:d}=n.detail;e.selectedMessage&&P(),e.selectedMessage=i,W(i,s,d,e)}),document.addEventListener("click",n=>{if(!document.querySelector(".message-controls"))return;const s=n.target.closest("[data-id]"),d=n.target.closest(".message-controls");!s&&!d&&P()}),a.historyBtn.addEventListener("click",async()=>{await S(e),a.historyModal.classList.remove("hidden")}),a.closeHistoryBtn.addEventListener("click",()=>{a.historyModal.classList.add("hidden")}),a.addConversationBtn.addEventListener("click",async()=>{const n=await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await e.chatAPI.switchConversation(n.id),e.chatView.clear(),await S(e),k(e.chatAPI)}),a.loadConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){await e.chatAPI.switchConversation(e.selectedConversationId);const n=await e.chatAPI.getMessages();e.chatView.renderMessages(n),a.historyModal.classList.add("hidden"),k(e.chatAPI);const i=e.chatView.chatContainer.lastElementChild;i&&i.scrollIntoView({behavior:"smooth"})}}),a.renameConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const n=e.chatAPI.conversations.find(s=>s.id===e.selectedConversationId),i=prompt("Enter new conversation name:",n.name);if(i&&i.trim()!==""){n.name=i,await e.chatAPI.updateConversation(n);const s=e.selectedConversationId;await S(e);const d=a.conversationsContainer.querySelector(`[data-id='${s}']`);d&&setTimeout(()=>{d.click(),d.scrollIntoView({block:"nearest"})},0)}}}),a.deleteConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null&&confirm("Are you sure you want to delete this conversation?")){let n=await e.chatAPI.getConversations();n.reverse();const i=n.findIndex(l=>l.id===e.selectedConversationId);await e.chatAPI.deleteConversation(e.selectedConversationId);let s=await e.chatAPI.getConversations();if(s.reverse(),s.length>0){let l=i;l>=s.length&&(l=s.length-1),await e.chatAPI.switchConversation(s[l].id)}else await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const d=await e.chatAPI.getMessages();e.chatView.renderMessages(d),await S(e),k(e.chatAPI)}}),a.compressConversationBtn.addEventListener("click",async()=>{if(e.compressionController){e.compressionController.abort(),e.compressionController=null,a.compressConversationBtn.textContent="ðŸ“¦";return}if(e.selectedConversationId!==null){const n=e.chatAPI.getCurrentModel();if(confirm(`Are you sure you want to compress this conversation using ${n.modelName} (${n.nickname})?`)){e.compressionController=new AbortController;const i=e.compressionController.signal;a.compressConversationBtn.textContent="ðŸ“¦...";const s=(d,l)=>{a.compressConversationBtn.textContent=`ðŸ“¦ ${d}/${l}`};try{await e.chatAPI.compressConversation(e.selectedConversationId,s,i),await S(e)}catch(d){d.name!=="AbortError"?alert("Error compressing conversation: "+d.message):(alert("Compression cancelled."),await S(e))}finally{e.compressionController=null,a.compressConversationBtn.textContent="ðŸ“¦"}}}}),a.exportConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const n=e.chatAPI.conversations.find(h=>h.id===e.selectedConversationId),i=await window.db.getMessages(e.selectedConversationId),s={...n,messages:i};let d=n.name;!d&&i.length>0&&(d=i[0].content.split(`
`)[0]);const l=d.replace(/[^a-z0-9]/gi,"_").toLowerCase(),u="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(s,null,2)),m=document.createElement("a");m.setAttribute("href",u),m.setAttribute("download",`${l}.json`),document.body.appendChild(m),m.click(),m.remove()}}),a.importConversationBtn.addEventListener("click",()=>{const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=async i=>{const s=i.target.files[0],d=new FileReader;d.onload=async l=>{try{const u=l.target.result,m=JSON.parse(u);await window.db.importConversation(m),await S(e),alert("Conversation imported successfully!")}catch(u){alert("Error importing conversation: "+u.message)}},d.readAsText(s)},n.click()}),a.cycleModelBtn.addEventListener("click",()=>{const n=e.chatAPI.cycleModel();a.modelNickname.textContent=n.nickname,k(e.chatAPI)}),a.settingsBtn.addEventListener("click",()=>{N(e.chatAPI),a.settingsModal.classList.remove("hidden")}),a.closeSettingsBtn.addEventListener("click",()=>{a.settingsModal.classList.add("hidden")}),a.addModelBtn.addEventListener("click",()=>{e.chatAPI.addModel({modelName:"gemini-2.5-flash-lite",apiKey:"",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192,proxy:""}),N(e.chatAPI)}),a.saveSettingsBtn.addEventListener("click",async n=>{n.preventDefault();const i=Array.from(a.llmConfigsContainer.children).map(s=>({modelName:s.querySelector('input[placeholder="Model Name"]').value,nickname:s.querySelector('input[placeholder="Nickname"]').value,apiKey:s.querySelector('input[placeholder="API Key"]').value,temperature:parseFloat(s.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(s.querySelector('input[placeholder="Max Output Tokens"]').value,10),proxy:s.querySelector('input[placeholder="Proxy URL"]').value,system_prompt:s.querySelector("textarea").value,useGoogleSearch:s.querySelector('input[id^="google-search-checkbox-"]').checked,useUrlContext:s.querySelector('input[id^="url-context-checkbox-"]').checked,prependSystemPrompt:s.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked,thinkingBudget:parseInt(s.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)}));await e.chatAPI.saveModels(i),a.settingsModal.classList.add("hidden"),a.modelNickname.textContent=e.chatAPI.getCurrentModel().nickname,k(e.chatAPI)}),a.attachFileBtn.addEventListener("click",()=>{const n=document.createElement("input");n.type="file",n.multiple=!0,n.addEventListener("change",i=>{const s=i.target.files;for(let d=0;d<s.length;d++){const l=s[d],u=new FileReader;u.onload=m=>{e.attachedFiles.push({name:l.name,type:l.type,data:m.target.result}),A(e)},u.readAsDataURL(l)}}),n.click()}),a.sendBtn.addEventListener("click",async()=>{const n=a.messageInput.value.trim();if(n||e.attachedFiles.length>0)if(e.editingMessageId!==null){const i=await e.chatAPI.updateMessage(e.editingMessageId,n,e.attachedFiles);e.chatView.editMessage(i),e.editingMessageId=null,a.cancelEditBtn.classList.add("hidden"),a.sendBtn.textContent="â–¶ï¸",a.messageInput.value="",e.attachedFiles=[],A(e)}else{const i={sender:"User",content:n,files:e.attachedFiles},s=await e.chatAPI.addMessage(i);e.chatView.appendMessage(s),a.messageInput.value="",e.attachedFiles=[],A(e),a.sendBtn.disabled=!0;const d={sender:"Assistant",content:"...",id:-1};e.chatView.appendMessage(d);try{const l=await e.chatAPI.sendMessage(await e.chatAPI.getMessages());e.chatView.removeMessage(-1),l&&e.chatView.appendMessage(l)}catch(l){e.chatView.removeMessage(-1);const u={sender:"Error",content:`An error occurred: ${l.message}`,id:Date.now()};e.chatView.appendMessage(u)}finally{a.sendBtn.disabled=!1,k(e.chatAPI)}}}),a.cancelEditBtn.addEventListener("click",()=>{a.messageInput.value="",e.attachedFiles=[],e.editingMessageId=null,A(e),a.cancelEditBtn.classList.add("hidden"),a.sendBtn.textContent="â–¶ï¸"}),a.messageInput.addEventListener("keydown",n=>{n.ctrlKey&&n.key==="Enter"&&(n.preventDefault(),a.sendBtn.click())});let t=!1;const o=n=>{t=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},r=n=>{if(t){const i=n.clientY||n.touches&&n.touches[0].clientY;if(i===void 0)return;let s=window.innerHeight-i;const d=e.initialFooterHeight+a.attachedFilesContainer.offsetHeight,l=500;s<d&&(s=d),s>l&&(s=l),a.footer.style.height=`${s}px`}},c=()=>{t=!1,document.body.style.userSelect="",document.body.style.cursor=""};a.resizeHandle.addEventListener("mousedown",o),document.addEventListener("mousemove",r),document.addEventListener("mouseup",c),a.resizeHandle.addEventListener("touchstart",o,{passive:!0}),document.addEventListener("touchmove",r),document.addEventListener("touchend",c),a.clearChatBtn.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await e.chatAPI.clearMessages(),e.chatView.clear(),k(e.chatAPI))}),a.exportSettingsBtn.addEventListener("click",()=>{const n=e.chatAPI.getModels(),i="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(n,null,2)),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(s),s.click(),s.remove()}),a.importSettingsBtn.addEventListener("click",()=>{const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=i=>{const s=i.target.files[0],d=new FileReader;d.onload=l=>{try{const u=l.target.result,m=JSON.parse(u);e.chatAPI.saveModels(m),N(e.chatAPI),a.modelNickname.textContent=e.chatAPI.getCurrentModel().nickname,alert("Settings imported successfully!")}catch(u){alert("Error importing settings: "+u.message)}},d.readAsText(s)},n.click()})}document.addEventListener("DOMContentLoaded",async()=>{const e={attachedFiles:[],editingMessageId:null,selectedMessage:null,selectedConversationId:null,initialFooterHeight:a.footer.offsetHeight,compressionController:null,chatView:new window.ChatView(a.chatContainer),chatAPI:window.chatAPI};X(e),await e.chatAPI.init();const t=e.chatAPI.getCurrentModel();t?a.modelNickname.textContent=t.nickname:(a.modelNickname.textContent="No Model",a.sendBtn.disabled=!0);const o=await e.chatAPI.getMessages();e.chatView.renderMessages(o),k(e.chatAPI),A(e)});
