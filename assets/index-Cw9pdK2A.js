(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function o(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=o(i);fetch(i.href,a)}})();const X="dumbllmchat_db",Q=3,I="messages",S="conversations",B="workflows";let _;function k(){return new Promise((e,t)=>{if(_)return e(_);const o=indexedDB.open(X,Q);o.onerror=n=>{t("Error opening IndexedDB")},o.onsuccess=n=>{_=n.target.result,e(_)},o.onupgradeneeded=n=>{const i=n.target.result;if(i.objectStoreNames.contains(S)||i.createObjectStore(S,{keyPath:"id",autoIncrement:!0}),!i.objectStoreNames.contains(I))i.createObjectStore(I,{keyPath:"id",autoIncrement:!0}).createIndex("conversationId","conversationId",{unique:!1});else{const s=n.target.transaction.objectStore(I);s.indexNames.contains("conversationId")||s.createIndex("conversationId","conversationId",{unique:!1})}i.objectStoreNames.contains(B)||i.createObjectStore(B,{keyPath:"id"})}})}async function Z(){const e=await k();return new Promise((t,o)=>{const a=e.transaction([S],"readonly").objectStore(S).getAll();a.onerror=s=>{o("Error getting conversations from IndexedDB")},a.onsuccess=s=>{t(s.target.result)}})}async function K(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([S],"readwrite").objectStore(S).add(e);s.onerror=r=>{n("Error adding conversation to IndexedDB")},s.onsuccess=r=>{o(r.target.result)}})}async function ee(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([S],"readwrite").objectStore(S).put(e);s.onerror=r=>{n("Error updating conversation in IndexedDB")},s.onsuccess=r=>{o(r.target.result)}})}async function te(e){const t=await k();return new Promise((o,n)=>{const i=t.transaction([S,I],"readwrite"),a=i.objectStore(S),s=i.objectStore(I);a.delete(e);const l=s.index("conversationId").openCursor(IDBKeyRange.only(e));l.onsuccess=d=>{const u=d.target.result;u&&(u.delete(),u.continue())},i.oncomplete=()=>{o()},i.onerror=d=>{n("Error deleting conversation from IndexedDB")}})}async function ne(e){const t=await k();return new Promise((o,n)=>{const r=t.transaction([I],"readonly").objectStore(I).index("conversationId").getAll(e);r.onerror=l=>{n("Error getting messages from IndexedDB")},r.onsuccess=l=>{o(l.target.result)}})}async function F(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([I],"readwrite").objectStore(I).add(e);s.onerror=r=>{n("Error adding message to IndexedDB")},s.onsuccess=r=>{o(r.target.result)}})}async function se(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([I],"readwrite").objectStore(I).put(e);s.onerror=r=>{n("Error updating message in IndexedDB")},s.onsuccess=r=>{o(r.target.result)}})}async function oe(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([I],"readwrite").objectStore(I).delete(e);s.onerror=r=>{n("Error removing message from IndexedDB")},s.onsuccess=r=>{o()}})}async function re(e){const t=await k();return new Promise((o,n)=>{const i=t.transaction([I],"readwrite"),r=i.objectStore(I).index("conversationId").openCursor(IDBKeyRange.only(e));r.onsuccess=l=>{const d=l.target.result;d&&(d.delete(),d.continue())},i.oncomplete=()=>{o()},i.onerror=l=>{n("Error clearing messages from IndexedDB")}})}async function ae(e){const{messages:t,...o}=e;delete o.id;const n=await K(o);for(const i of t)delete i.id,i.conversationId=n,await F(i)}async function ie(){const e=await k();return new Promise((t,o)=>{const a=e.transaction([B],"readonly").objectStore(B).getAll();a.onerror=s=>o(`Error getting workflows: ${s.target.error}`),a.onsuccess=s=>t(s.target.result)})}async function ce(e){const t=await k();return new Promise((o,n)=>{e.id||(e.id=`workflow_${Date.now()}_${Math.random().toString(36).substring(2,9)}`);const s=t.transaction([B],"readwrite").objectStore(B).add(e);s.onerror=r=>n(`Error adding workflow: ${r.target.error}`),s.onsuccess=r=>o(e.id)})}async function de(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([B],"readwrite").objectStore(B).put(e);s.onerror=r=>n(`Error updating workflow: ${r.target.error}`),s.onsuccess=r=>o(r.target.result)})}async function le(e){const t=await k();return new Promise((o,n)=>{const s=t.transaction([B],"readwrite").objectStore(B).delete(e);s.onerror=r=>n(`Error deleting workflow: ${r.target.error}`),s.onsuccess=()=>o()})}window.db={getConversations:Z,addConversation:K,updateConversation:ee,deleteConversation:te,getMessages:ne,addMessage:F,updateMessage:se,removeMessage:oe,clearMessages:re,importConversation:ae,getWorkflows:ie,addWorkflow:ce,updateWorkflow:de,deleteWorkflow:le};function V(e){if(!e)return"";let t=e.trim();for(;t.endsWith("/");)t=t.slice(0,-1);return t?t+"/":""}class ue{constructor(){this.models=this.getModels(),this.messages=[],this.conversations=[],this.currentConversationId=null,this.currentModelIndex=this.getCurrentModelIndex(),this.currentWorkflowId=null,this.apiKeys=[],this.proxy="",this.invalidKeys=new Map,this.init()}async init(){const t=this.getGlobalSettings();this.apiKeys=t.apiKeys||[],this.proxy=t.proxy||"",await this.fetchAndSetModels(),this.conversations=await window.db.getConversations(),this.currentConversationId=this.getCurrentConversationId(),this.currentWorkflowId=localStorage.getItem("current_workflow_id"),this.currentModelIndex=this.getCurrentModelIndex(),!this.currentConversationId&&this.conversations.length>0&&(this.currentConversationId=this.conversations[0].id,this.saveCurrentConversationId()),this.currentConversationId&&(this.messages=await this.getMessages())}getCurrentConversationId(){return parseInt(localStorage.getItem("current_conversation_id"))}saveCurrentConversationId(){localStorage.setItem("current_conversation_id",this.currentConversationId)}async getConversations(){return this.conversations=await window.db.getConversations(),this.conversations}async addConversation(t){const o=await window.db.addConversation(t),n={...t,id:o};return this.conversations.push(n),n}async updateConversation(t){await window.db.updateConversation(t);const o=this.conversations.findIndex(n=>n.id===t.id);o!==-1&&(this.conversations[o]=t)}async deleteConversation(t){await window.db.deleteConversation(t),this.conversations=this.conversations.filter(o=>o.id!==t),this.currentConversationId===t&&(this.conversations.length>0?this.currentConversationId=this.conversations[0].id:this.currentConversationId=null,this.saveCurrentConversationId())}async switchConversation(t){this.currentConversationId=t,this.saveCurrentConversationId(),this.messages=await this.getMessages()}getModels(){const t=localStorage.getItem("llm_models");return t?JSON.parse(t):[{modelName:"gemini-2.5-flash-lite",nickname:"flash-lite",temperature:.7,maxOutputTokens:65536,system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576},{modelName:"gemini-2.5-pro",nickname:"pro",temperature:.7,maxOutputTokens:65536,system_prompt:"You are a helpful assistant.",useGoogleSearch:!0,useUrlContext:!1,prependSystemPrompt:!1,thinkingBudget:24576}]}async fetchModelInfo(t){const{modelName:o}=t,n=this.getApiKey();if(!n)return{...t,maxTokens:0};const a=`${V(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${o}`;try{const s=await fetch(a,{method:"GET",headers:{"Content-Type":"application/json","x-goog-api-key":n,"ngrok-skip-browser-warning":"true"}});if(!s.ok)return{...t,maxTokens:0};const r=await s.json();return{...t,maxTokens:r.inputTokenLimit}}catch{return{...t,maxTokens:0}}}async fetchAndSetModels(){const t=this.getModels(),o=await Promise.all(t.map(n=>this.fetchModelInfo(n)));this.models=o}async saveModels(t){const o=t.map(n=>{const{maxTokens:i,apiKey:a,proxy:s,...r}=n;return r});localStorage.setItem("llm_models",JSON.stringify(o)),await this.fetchAndSetModels()}getGlobalSettings(){const t=localStorage.getItem("global_settings");return t?JSON.parse(t):{apiKeys:[],proxy:""}}saveGlobalSettings(t){localStorage.setItem("global_settings",JSON.stringify(t)),this.apiKeys=t.apiKeys||[],this.proxy=t.proxy||""}getApiKey(){const t=new Date().toISOString().slice(0,10);let o=this.apiKeys.filter(n=>{const i=this.invalidKeys.get(n);return!i||i!==t});return o.length===0&&(this.invalidKeys.clear(),o=this.apiKeys),o.length===0?null:o[0]}addModel(t){const{apiKey:o,proxy:n,...i}=t;this.models.push(i),this.saveModels(this.models)}updateModel(t,o){this.models[t]=o,this.saveModels(this.models)}removeModel(t){this.models.splice(t,1),this.saveModels(this.models)}getCurrentModel(){return this.models[this.currentModelIndex]}setCurrentWorkflow(t){this.currentWorkflowId=t,localStorage.setItem("current_workflow_id",t),localStorage.removeItem("current_model_index")}setCurrentModelIndex(t){this.currentModelIndex=t,this.currentWorkflowId=null,localStorage.setItem("current_model_index",t),localStorage.removeItem("current_workflow_id")}getCurrentModelIndex(){const t=localStorage.getItem("current_model_index");return t?parseInt(t,10):0}async getMessages(){return this.currentConversationId?(this.messages=await window.db.getMessages(this.currentConversationId),this.messages):[]}async getMessage(t){return this.messages.find(o=>o.id===t)}async addMessage(t){if(!this.currentConversationId){const a=await this.addConversation({name:"New Conversation",timestamp:Date.now()});this.currentConversationId=a.id,this.saveCurrentConversationId()}const o={...t,conversationId:this.currentConversationId},n=await window.db.addMessage(o),i={...o,id:n};return this.messages.push(i),i}async updateMessage(t,o,n){const i=await this.getMessage(t);return i.content=o,n&&(i.files=n),await window.db.updateMessage(i),i}async removeMessage(t){await window.db.removeMessage(t),this.messages=this.messages.filter(o=>o.id!==t)}async clearMessages(){this.currentConversationId&&(await window.db.clearMessages(this.currentConversationId),this.messages=[])}async countTokens(t){const o=this.getCurrentModel(),{modelName:n}=o,i=this.getApiKey();if(!i)throw new Error("No valid API key available.");const s=`${V(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${n}:countTokens`,l={contents:t.map(d=>{const u=[{text:d.content}];return d.files&&d.files.forEach(m=>{u.push({inline_data:{mime_type:m.type,data:m.data.split(",")[1]}})}),{role:d.sender==="User"?"user":"model",parts:u}})};try{const d=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":i,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(l)});if(!d.ok){const m=await d.json().catch(()=>({})),v=new Date().toISOString().slice(0,10);throw this.invalidKeys.set(i,v),new Error(`API Error: ${d.status} ${d.statusText} - ${m.error?.message||"Unknown error"}`)}return(await d.json()).totalTokens}catch(d){console.error("Token count failed:",d);const u=new Date().toISOString().slice(0,10);return this.invalidKeys.set(i,u),0}}async _makeApiRequest(t,o,n=[],i){const{modelName:a,temperature:s,system_prompt:r,maxOutputTokens:l,prependSystemPrompt:d,thinkingBudget:u}=t,m=this.getApiKey();if(!m)throw new Error("No valid API key available.");const C=`${V(this.proxy)}https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent`,p=o.map(f=>{const h=[{text:f.content}];return f.files&&f.files.forEach(w=>{h.push({inline_data:{mime_type:w.type,data:w.data.split(",")[1]}})}),{role:f.sender==="User"?"user":"model",parts:h}});if(d){const f=p[p.length-1];f.role==="user"&&(f.parts[0].text=`${r}

${f.parts[0].text}`)}const g={contents:p,generationConfig:{temperature:s,topK:1,topP:1,maxOutputTokens:l||2048,stopSequences:[]},safetySettings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}]};!d&&r&&(g.systemInstruction={role:"user",parts:[{text:r}]}),n.length>0&&(g.tools=n),u&&(g.generationConfig.thinkingConfig={thinkingBudget:u});try{const f=await fetch(C,{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-key":m,"ngrok-skip-browser-warning":"true"},body:JSON.stringify(g),signal:i});if(!f.ok){const y=await f.json().catch(()=>({})),b=new Date().toISOString().slice(0,10);throw this.invalidKeys.set(m,b),new Error(`API Error: ${f.status} ${f.statusText} - ${y.error?.message||"Unknown error"}`)}const h=await f.json();if(!h.candidates||h.candidates.length===0){const y=h.promptFeedback?.blockReason;return y?`[The model blocked the response. Reason: ${y}]`:"[The model sent an empty response.]"}const w=h.candidates[0].content;return w&&w.parts?w.parts.map(y=>y.text).join(""):"[The model sent an empty response.]"}catch(f){if(f.name!=="AbortError"){const h=new Date().toISOString().slice(0,10);this.invalidKeys.set(m,h)}throw f}}async generateFromModel(t,o,n=[],i){const a=this.models.find(r=>r.nickname.toLowerCase()===t.toLowerCase());if(!a)throw new Error(`Model with nickname "${t}" not found.`);const s=[];return n.includes("google")&&s.push({google_search:{}}),n.includes("urlcontext")&&s.push({url_context:{}}),this._makeApiRequest(a,o,s,i)}async _generateContent(t,o){const n=this.getCurrentModel(),i=[];return n.useGoogleSearch&&i.push({google_search:{}}),n.useUrlContext&&i.push({url_context:{}}),this._makeApiRequest(n,t,i,o)}async sendMessage(t){const n={sender:"Assistant",content:await this._generateContent(t)};return await this.addMessage(n)}async compressConversation(t,o,n){if(n?.aborted)return;const i=this.conversations.find(u=>u.id===t);if(!i)throw new Error("Conversation not found");const a=await window.db.getMessages(t);if(a.length===0)throw new Error("Cannot compress an empty conversation.");const s=Math.ceil(a.length/8),r=`[Compressed] ${i.name}`,l=await this.addConversation({name:r,timestamp:Date.now()}),d=async()=>{await this.deleteConversation(l.id),n.removeEventListener("abort",d)};n?.addEventListener("abort",d);for(let u=0;u<a.length;u+=8){if(n?.aborted)throw new DOMException("Aborted by user","AbortError");const m=u/8+1;o&&o(m,s);const p=`You are a Specialized Context Preservation and Compression Engine. Your primary goal is to losslessly (or near-losslessly) compress the provided multi-turn conversation history into a single, highly dense, and concise textual block. This block must function as a perfect summary and contextual anchor for a subsequent LLM to pick up the conversation as if it had access to the full original transcript.

Your output should only contain the compressed message, with no additional commentary or explanations.

Preserve the original writing style of the conversation as much as possible in the compressed output.

If the conversation is a narrative piece, do not mention the "Assistant" or "User" roles. Otherwise, you should include them.

Here is the conversation snippet:

${a.slice(u,u+8).map(w=>`${w.sender}: ${w.content}`).join(`
`)}`,g=3;let f="";for(let w=0;w<g;w++){if(n?.aborted)throw new DOMException("Aborted by user","AbortError");if(f=await this._generateContent([{sender:"User",content:p}],n),f.trim()!==""&&f!=="[The model sent an empty response.]")break;w<g-1&&await new Promise(y=>setTimeout(y,1e3))}if(f.trim()===""||f==="[The model sent an empty response.]")throw new Error(`Compression failed for a chunk after ${g} retries.`);const h={sender:"Assistant",content:f,conversationId:l.id};await window.db.addMessage(h)}return n?.removeEventListener("abort",d),l}}window.chatAPI=new ue;class me{constructor(t){this.chatContainer=t}appendMessage(t){const o=this.chatContainer.scrollHeight-this.chatContainer.clientHeight<=this.chatContainer.scrollTop+1,n=this.createMessageElement(t);this.chatContainer.appendChild(n),o&&n.scrollIntoView({behavior:"smooth"})}renderMessages(t){this.clear(),t.forEach(o=>{const n=this.createMessageElement(o);this.chatContainer.appendChild(n)})}removeMessage(t){const o=this.chatContainer.querySelector(`[data-id='${t}']`);o&&o.remove()}editMessage(t){const o=this.chatContainer.querySelector(`[data-id='${t.id}']`);if(o){const n=this.createMessageElement(t);o.replaceWith(n)}}clear(){this.chatContainer.innerHTML=""}createMessageElement(t){const o=document.createElement("div");let n="bg-gray-300 dark:bg-gray-700",i="self-start";t.sender==="User"?(n="bg-blue-500 text-white",i="self-end"):t.sender==="Error"&&(n="bg-red-500 text-white"),o.className=`p-3 rounded-lg ${n} w-full ${i} message`,o.dataset.id=t.id;const a=document.createElement("div");if(a.className="message-content",a.innerHTML=marked.parse(t.content,{breaks:!0}),o.appendChild(a),t.files&&t.files.length>0){const s=document.createElement("div");s.className="flex flex-wrap gap-2 mt-2",t.files.forEach(r=>{const l=document.createElement("div");l.className="flex items-center bg-gray-200 dark:bg-gray-600 rounded-lg p-2";const d=document.createElement("span");d.className="mr-2 text-gray-800 dark:text-gray-200",d.style.wordBreak="break-all",d.textContent=r.name,l.appendChild(d);const u=document.createElement("button");u.textContent="â¬‡ï¸",u.className="download-file-btn",u.addEventListener("click",()=>{const m=document.createElement("a");m.href=r.data,m.download=r.name,m.click()}),l.appendChild(u),s.appendChild(l)}),o.appendChild(s)}return o.querySelectorAll("pre").forEach(s=>{const r=s.querySelector("code"),l=r.className.split("-")[1]||"",d=document.createElement("div");d.className="code-block-container";const u=document.createElement("div");u.className="code-block-header";const m=document.createElement("span");m.textContent=l,u.appendChild(m);const v=document.createElement("button");v.textContent="Copy",v.className="copy-code-btn",u.appendChild(v),d.appendChild(u),d.appendChild(s.cloneNode(!0)),s.replaceWith(d),hljs.highlightElement(d.querySelector("pre code")),v.addEventListener("click",C=>{C.stopPropagation();const p=r.innerText;navigator.clipboard.writeText(p).then(()=>{v.textContent="Copied!",setTimeout(()=>{v.textContent="Copy"},2e3)},()=>{alert("Failed to copy code.")})})}),t.sender!=="Error"&&o.addEventListener("click",s=>{const r=new CustomEvent("message-selected",{detail:{messageElement:o,x:s.clientX,y:s.clientY}});this.chatContainer.dispatchEvent(r)}),o}}window.ChatView=me;const c={modelSelector:document.getElementById("model-selector"),tokenCountDisplay:document.getElementById("token-count-display"),settingsBtn:document.getElementById("settings-btn"),historyBtn:document.getElementById("history-btn"),chatContainer:document.getElementById("chat-container"),resizeHandle:document.getElementById("resize-handle"),messageInput:document.getElementById("message-input"),sendBtn:document.getElementById("send-btn"),settingsModal:document.getElementById("settings-modal"),llmConfigsContainer:document.getElementById("llm-configs-container"),addModelBtn:document.getElementById("add-model-btn"),saveSettingsBtn:document.getElementById("save-settings-btn"),closeSettingsBtn:document.getElementById("close-settings-btn"),historyModal:document.getElementById("history-modal"),conversationsContainer:document.getElementById("conversations-container"),addConversationBtn:document.getElementById("add-conversation-btn"),renameConversationBtn:document.getElementById("rename-conversation-btn"),deleteConversationBtn:document.getElementById("delete-conversation-btn"),compressConversationBtn:document.getElementById("compress-conversation-btn"),importConversationBtn:document.getElementById("import-conversation-btn"),exportConversationBtn:document.getElementById("export-conversation-btn"),loadConversationBtn:document.getElementById("load-conversation-btn"),closeHistoryBtn:document.getElementById("close-history-btn"),clearChatBtn:document.getElementById("clear-chat-btn"),importSettingsBtn:document.getElementById("import-settings-btn"),exportSettingsBtn:document.getElementById("export-settings-btn"),copyChatBtn:document.getElementById("copy-chat-btn"),footer:document.querySelector("footer"),attachFileBtn:document.getElementById("attach-file-btn"),attachedFilesContainer:document.getElementById("attached-files-container"),cancelEditBtn:document.getElementById("cancel-edit-btn"),addApiKeyBtn:document.getElementById("add-api-key-btn"),proxyUrl:document.getElementById("proxy-url"),apiKeysContainer:document.getElementById("api-keys-container"),settingsTabs:document.getElementById("settings-tabs"),tabGlobal:document.getElementById("tab-global"),tabModels:document.getElementById("tab-models"),tabWorkflows:document.getElementById("tab-workflows"),workflowsList:document.getElementById("workflows-list"),addWorkflowBtn:document.getElementById("add-workflow-btn"),workflowEditorOverlay:document.getElementById("workflow-editor-overlay"),workflowNameInput:document.getElementById("workflow-name-input"),workflowScriptInput:document.getElementById("workflow-script-input"),workflowEditorSaveBtn:document.getElementById("workflow-editor-save-btn"),workflowEditorCancelBtn:document.getElementById("workflow-editor-cancel-btn")};class ge{parse(t){const o=t.split(`
`),n=[],i=[];for(let s=0;s<o.length;s++){const r=o[s];if(r.trim()===""||r.trim().startsWith("//"))continue;const l=r.match(/^(\s*)/),d=l?l[1]:"",u=this.calculateIndentLevel(d);let m=this.parseLine(r.trim(),u);if(!m)throw new SyntaxError(`Invalid syntax on line ${s+1}: "${r.trim()}"`);if(m.prompt.trim()==='"""'){let v="";for(s++;s<o.length;){const C=o[s];if(C.trim().endsWith('"""')){v+=C.trim().slice(0,-3);break}v+=C+`
`,s++}m.prompt=v.trim()}for(m.id=m.id||`node_${Date.now()}_${s}`,m.children=m.children||[],m.explicitDependencies=m.explicitDependencies||[],m.flags=m.flags||[];i.length>0&&i[i.length-1].indentLevel>=m.indentLevel;)i.pop();i.length>0&&i[i.length-1].children.push(m.id),i.push(m),n.push(m)}const a=new Map(n.map(s=>[s.id,s]));return n.forEach(s=>{const r=/\{\{#(\w+)\}\}/g;let l;if(s.prompt)for(;(l=r.exec(s.prompt))!==null;)a.has(l[1])&&s.explicitDependencies.push(l[1])}),n}calculateIndentLevel(t){const o=t.replace(/\t/g,"  ").length;return Math.floor(o/2)}parseLine(t,o){const n=t.match(/^(#[\w-]+)\s*=\s*(.*)/);if(n){const[,p,g]=n;return{id:p.substring(1),type:"static",prompt:g.trim(),indentLevel:o,flags:[]}}const i=t.indexOf(":");if(i===-1){const p=t.split(/\s+/).filter(Boolean);let g=null,f=null,h=null,w=[],y=0;if(p[y]?.startsWith("#")&&(g=p[y].substring(1),y++),y<p.length&&!p[y].startsWith("+")){const b=p[y];b.startsWith("#")?h=b.substring(1):f=b,y++}for(;y<p.length;)p[y].startsWith("+")&&w.push(p[y].substring(1)),y++;return g||f||h?{id:g,model:f,modelVariable:h,type:"llm",prompt:"",indentLevel:o,flags:w}:null}const a=t.substring(0,i).trim(),s=t.substring(i+1).trim(),r=a.split(/\s+/).filter(Boolean);let l=null,d=null,u=null,m=[],v=0;if(r[v]?.startsWith("#")&&(l=r[v].substring(1),v++),v<r.length&&!r[v].startsWith("+")){const p=r[v];p.startsWith("#")?u=p.substring(1):d=p,v++}for(;v<r.length;)r[v].startsWith("+")&&m.push(r[v].substring(1)),v++;return!l&&!d&&!u?null:{id:l,model:d,modelVariable:u,type:d||u?"llm":"static",prompt:s,indentLevel:o,flags:m}}}const M={PENDING:"PENDING",RUNNING:"RUNNING",COMPLETED:"COMPLETED",FAILED:"FAILED"};class U{constructor(t){this.chatAPI=t,this.parser=new ge}async execute(t,o,n=()=>{}){const i=this.parser.parse(t);if(!i||i.length===0)return"";const a=this.chatAPI.getModels().map(g=>g.nickname.toLowerCase()),s=new Map(i.filter(g=>g.type==="static").map(g=>[g.id,g.prompt])),r=new Set;i.filter(g=>g.type==="llm").forEach(g=>{if(g.model)r.add(g.model.toLowerCase());else if(g.modelVariable){const f=s.get(g.modelVariable);f&&r.add(f.toLowerCase())}});const l=[...r].filter(g=>!a.includes(g));if(l.length>0)throw new Error(`Workflow aborted: The following models are not defined: ${l.join(", ")}`);new Map(i.map(g=>[g.id,g]));const d=new Map(i.map(g=>[g.id,M.PENDING])),u=new Map;let m=!0,v=-1,C=0;for(;m;){const g=i.filter(h=>{if(d.get(h.id)!==M.PENDING)return!1;const w=h.children||[],y=h.explicitDependencies||[];return[...new Set([...w,...y])].every(E=>d.get(E)===M.COMPLETED)});if(g.length===0)if(Array.from(d.values()).some(w=>w===M.PENDING||w===M.RUNNING)){if(g.length===v?C++:C=0,C>5)throw new Error("Deadlock detected: No runnable nodes found, but some nodes are still pending.")}else{m=!1;continue}v=g.length;const f=g.map(async h=>{if(d.set(h.id,M.RUNNING),h.type==="static"){n(`Resolving: ${h.id}`);try{let w=h.prompt.replace(/\{\{INPUT\}\}/g,o);h.explicitDependencies&&h.explicitDependencies.forEach(y=>{const b=new RegExp(`\\{\\{#${y}\\}\\}`,"g");w=w.replace(b,u.get(y)||"")}),u.set(h.id,w),d.set(h.id,M.COMPLETED),n(`Completed: ${h.id}`)}catch(w){throw d.set(h.id,M.FAILED),n(`Failed: ${h.id} - ${w.message}`),new Error(`Error resolving static node ${h.id}: ${w.message}`)}}else try{let w=h.model;if(h.modelVariable&&(w=u.get(h.modelVariable),!w))throw new Error(`Could not resolve model variable "${h.modelVariable}"`);n(`Running: ${h.id} (${w})`);let y=h.prompt.replace(/\{\{INPUT\}\}/g,o);const b=new Set;h.explicitDependencies&&h.explicitDependencies.forEach(A=>{const q=new RegExp(`\\{\\{#${A}\\}\\}`,"g");y=y.replace(q,u.get(A)),b.add(A)});const E=(h.children||[]).filter(A=>!b.has(A)).map(A=>u.get(A)).join(`

`);E&&(y=`${E}

${y}`);let x=[];h.flags&&h.flags.includes("history")?(x=await this.chatAPI.getMessages()||[],x.push({sender:"User",content:y})):x=[{sender:"User",content:y}];const W=await this.chatAPI.generateFromModel(w,x,h.flags);u.set(h.id,W),d.set(h.id,M.COMPLETED),n(`Completed: ${h.id}`)}catch(w){throw d.set(h.id,M.FAILED),n(`Failed: ${h.id} - ${w.message}`),new Error(`Error executing node ${h.id}: ${w.message}`)}});await Promise.all(f),await new Promise(h=>setTimeout(h,50))}return i.filter(g=>g.indentLevel===0&&g.type==="llm").map(g=>u.get(g.id)).join(`

`)}}function he(e,t,o,n){const i=document.createElement("div");i.className="message-controls absolute bg-white dark:bg-gray-800 rounded-lg shadow-lg p-2 flex space-x-2";const a=parseInt(e.dataset.id),s=document.createElement("button");s.textContent="âœï¸",s.addEventListener("click",async()=>{const g=await n.chatAPI.getMessage(a);c.messageInput.value=g.content,n.attachedFiles=g.files||[],n.editingMessageId=a,N(n),c.cancelEditBtn.classList.remove("hidden"),c.sendBtn.textContent="ðŸ’¾",T(),c.messageInput.focus()});const r=document.createElement("button");r.textContent="ðŸ—‘ï¸",r.addEventListener("click",async()=>{confirm("Are you sure you want to delete this message?")&&(await n.chatAPI.removeMessage(a),n.chatView.removeMessage(a)),T()});const l=document.createElement("button");l.textContent="ðŸ“‹",l.addEventListener("click",()=>{navigator.clipboard.writeText(e.textContent).then(()=>{alert("Message copied to clipboard!")},()=>{alert("Failed to copy message.")}),T()});const d=document.createElement("button");d.textContent="ðŸ”„ï¸",d.addEventListener("click",async()=>{const g=await n.chatAPI.getMessages(),f=g.findIndex(E=>E.id===a),h=g[f];let w;h.sender==="User"?w=g.slice(0,f+1):w=g.slice(0,f),await n.chatAPI.clearMessages();for(const E of w)await n.chatAPI.addMessage(E);const y=c.chatContainer.scrollTop;n.chatView.renderMessages(w),c.chatContainer.scrollTop=y;const b=w[w.length-1];if(b&&b.sender==="User"){T(),c.sendBtn.disabled=!0;const E="temp-"+Date.now();n.chatView.appendMessage({sender:"Assistant",content:"...",id:E},!0);try{if(n.chatAPI.currentWorkflowId){const $=(await window.db.getWorkflows()).find(R=>R.id===n.chatAPI.currentWorkflowId);if(!$)throw new Error("Selected workflow not found.");const W=new U(n.chatAPI),A=R=>Y(E,R),q=await W.execute($.script,b.content,A);n.chatView.removeMessage(E);const J=await n.chatAPI.addMessage({sender:"Assistant",content:q});n.chatView.appendMessage(J)}else{const x=await n.chatAPI.sendMessage(w);n.chatView.removeMessage(E),x&&n.chatView.appendMessage(x)}}catch(x){n.chatView.removeMessage(E);const $={sender:"Error",content:x.message,id:Date.now()};n.chatView.appendMessage($)}finally{c.sendBtn.disabled=!1,n.chatAPI.currentWorkflowId||P(n.chatAPI)}}}),i.appendChild(s),i.appendChild(r),i.appendChild(l),i.appendChild(d),i.style.visibility="hidden",document.body.appendChild(i);const u=i.getBoundingClientRect(),m=window.innerWidth,v=window.innerHeight;let C=t,p=o;t+u.width>m&&(C=m-u.width-5),o+u.height>v&&(p=v-u.height-5),C<0&&(C=5),p<0&&(p=5),i.style.left=`${C}px`,i.style.top=`${p}px`,i.style.visibility="visible"}function T(){const e=document.querySelector(".message-controls");e&&e.remove()}async function P(e){const t=await e.getMessages(),o=await e.countTokens(t),n=e.getCurrentModel();c.tokenCountDisplay.textContent=`${o}/${n.maxTokens}`}async function L(e){const t=await e.chatAPI.getConversations();t.reverse(),c.conversationsContainer.innerHTML="",e.selectedConversationId=null,c.renameConversationBtn.disabled=!0,c.deleteConversationBtn.disabled=!0,c.loadConversationBtn.disabled=!0,c.exportConversationBtn.disabled=!0,c.compressConversationBtn.disabled=!0;for(const n of t){const i=document.createElement("li");i.className="p-2 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700",i.dataset.id=n.id;const a=document.createElement("span");a.className="truncate";let s=n.name;if(!s){const r=await window.db.getMessages(n.id);r.length>0?s=r[0].content.split(`
`)[0]:s="New Conversation"}a.textContent=s,i.appendChild(a),i.addEventListener("click",()=>{if(e.selectedConversationId!==null){const r=c.conversationsContainer.querySelector(`[data-id='${e.selectedConversationId}']`);r&&r.classList.remove("selected")}i.classList.add("selected"),e.selectedConversationId=n.id,c.renameConversationBtn.disabled=!1,c.deleteConversationBtn.disabled=!1,c.loadConversationBtn.disabled=!1,c.exportConversationBtn.disabled=!1,c.compressConversationBtn.disabled=!1,i.scrollIntoView({block:"nearest"})}),c.conversationsContainer.appendChild(i)}const o=c.conversationsContainer.querySelector(`[data-id='${e.chatAPI.currentConversationId}']`);o&&(o.classList.add("selected"),e.selectedConversationId=e.chatAPI.currentConversationId,c.renameConversationBtn.disabled=!1,c.deleteConversationBtn.disabled=!1,c.loadConversationBtn.disabled=!1,c.exportConversationBtn.disabled=!1,c.compressConversationBtn.disabled=!1,setTimeout(()=>{o.scrollIntoView({block:"nearest"})},0))}function D(e){c.llmConfigsContainer.innerHTML="",e.getModels().forEach((t,o)=>{const n=document.createElement("div");n.className="mb-4 p-2 border border-black rounded-lg dark:border-black",n.innerHTML=`
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold">${t.nickname}</h3>
                <button type="button" class="remove-model-btn text-xl" data-index="${o}">âž–</button>
            </div>
            <input type="text" value="${t.modelName}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Model Name">
            <input type="text" value="${t.nickname}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Nickname">
            <textarea class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="System Prompt">${t.system_prompt}</textarea>
            <input type="number" step="0.1" value="${t.temperature}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Temperature">
            <input type="number" value="${t.maxOutputTokens||""}" class="w-full p-2 mb-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Max Output Tokens">
            <input type="number" value="${t.thinkingBudget??""}" class="w-full p-2 mt-2 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Thinking Budget (tokens)">
            <div class="google-search-container">
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="google-search-checkbox-${o}" class="mr-2" ${t.useGoogleSearch?"checked":""}>
                    <label for="google-search-checkbox-${o}">Enable Google Search</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="prepend-system-prompt-checkbox-${o}" class="mr-2" ${t.prependSystemPrompt?"checked":""}>
                    <label for="prepend-system-prompt-checkbox-${o}">Prepend System Prompt</label>
                </div>
                <div class="flex items-center mt-2">
                    <input type="checkbox" id="url-context-checkbox-${o}" class="mr-2" ${t.useUrlContext?"checked":""}>
                    <label for="url-context-checkbox-${o}">Enable URL Context</label>
                </div>
            </div>
        `,c.llmConfigsContainer.appendChild(n)}),document.querySelectorAll(".remove-model-btn").forEach(t=>{t.addEventListener("click",o=>{const n=o.target.dataset.index;e.removeModel(n),D(e)})})}function we(e){const t=e.getGlobalSettings();c.proxyUrl.value=t.proxy||"",c.apiKeysContainer.innerHTML="",t.apiKeys.forEach(o=>{G(o)})}function G(e=""){const t=document.createElement("div");t.className="flex items-center space-x-2";const o=document.createElement("input");o.type="text",o.value=e,o.className="api-key-input w-full p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600",o.placeholder="API Key";const n=document.createElement("button");n.type="button",n.textContent="âž–",n.className="text-xl",n.addEventListener("click",()=>{t.remove()}),t.appendChild(o),t.appendChild(n),c.apiKeysContainer.appendChild(t)}function N(e){c.attachedFilesContainer.innerHTML="",e.attachedFiles.forEach((a,s)=>{const r=document.createElement("div");r.className="attached-file-item";const l=document.createElement("span");l.textContent=a.name,r.appendChild(l);const d=document.createElement("button");d.className="remove-file-btn",d.textContent="âŒ",d.addEventListener("click",()=>{e.attachedFiles.splice(s,1),N(e)}),r.appendChild(d),c.attachedFilesContainer.appendChild(r)});const i=c.footer.querySelector(".flex-grow").scrollHeight-c.messageInput.offsetHeight+90;c.footer.offsetHeight<i&&(c.footer.style.height=`${i}px`)}function j(e){c.tabGlobal.classList.add("hidden"),c.tabModels.classList.add("hidden"),c.tabWorkflows.classList.add("hidden"),c.settingsTabs.querySelectorAll("button").forEach(n=>{n.classList.remove("border-blue-500","text-blue-500"),n.classList.add("text-gray-500")});const t=c.settingsTabs.querySelector(`[data-tab="${e}"]`),o=document.getElementById(`tab-${e}`);t&&o&&(o.classList.remove("hidden"),t.classList.add("border-blue-500","text-blue-500"),t.classList.remove("text-gray-500"))}async function H(e){const t=await window.db.getWorkflows();if(c.workflowsList.innerHTML="",!t||t.length===0){c.workflowsList.innerHTML='<p class="text-gray-500">No workflows created yet.</p>';return}t.forEach(o=>{const n=document.createElement("div");n.className="flex justify-between items-center p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700";const i=document.createElement("span");i.textContent=o.name,n.appendChild(i);const a=document.createElement("div"),s=document.createElement("button");s.textContent="âœï¸",s.className="mr-2",s.onclick=()=>z(e,o);const r=document.createElement("button");r.textContent="ðŸ—‘ï¸",r.onclick=async()=>{confirm(`Are you sure you want to delete workflow "${o.name}"?`)&&(await window.db.deleteWorkflow(o.id),H(e))},a.appendChild(s),a.appendChild(r),n.appendChild(a),c.workflowsList.appendChild(n)})}function z(e,t=null){t?(e.editingWorkflowId=t.id,c.workflowNameInput.value=t.name,c.workflowScriptInput.value=t.script):(e.editingWorkflowId=null,c.workflowNameInput.value="",c.workflowScriptInput.value=""),c.workflowEditorOverlay.classList.remove("hidden")}async function O(e){const t=e.getModels(),o=await window.db.getWorkflows();c.modelSelector.innerHTML="";const n=document.createElement("optgroup");n.label="Models",t.forEach((a,s)=>{const r=document.createElement("option");r.value=`model_${s}`,r.textContent=a.nickname,n.appendChild(r)});const i=document.createElement("optgroup");i.label="Workflows",o.forEach(a=>{const s=document.createElement("option");s.value=`workflow_${a.id}`,s.textContent=a.name,i.appendChild(s)}),c.modelSelector.appendChild(n),c.modelSelector.appendChild(i),e.currentWorkflowId?c.modelSelector.value=`workflow_${e.currentWorkflowId}`:c.modelSelector.value=`model_${e.currentModelIndex}`}function Y(e,t){const o=c.chatContainer.querySelector(`[data-id="${e}"]`);if(o){const n=o.querySelector(".message-content");n&&(n.textContent=t)}}function fe(e){c.chatContainer.addEventListener("message-selected",a=>{const{messageElement:s,x:r,y:l}=a.detail;e.selectedMessage&&T(),e.selectedMessage=s,he(s,r,l,e)}),document.addEventListener("click",a=>{if(!document.querySelector(".message-controls"))return;const r=a.target.closest("[data-id]"),l=a.target.closest(".message-controls");!r&&!l&&T()}),c.historyBtn.addEventListener("click",async()=>{await L(e),c.historyModal.classList.remove("hidden")}),c.closeHistoryBtn.addEventListener("click",()=>{c.historyModal.classList.add("hidden")}),c.addConversationBtn.addEventListener("click",async()=>{const a=await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});await e.chatAPI.switchConversation(a.id),e.chatView.clear(),await L(e),P(e.chatAPI)}),c.loadConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){await e.chatAPI.switchConversation(e.selectedConversationId);const a=await e.chatAPI.getMessages();e.chatView.renderMessages(a),c.historyModal.classList.add("hidden"),P(e.chatAPI);const s=e.chatView.chatContainer.lastElementChild;s&&s.scrollIntoView({behavior:"smooth"})}}),c.renameConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const a=e.chatAPI.conversations.find(r=>r.id===e.selectedConversationId),s=prompt("Enter new conversation name:",a.name);if(s&&s.trim()!==""){a.name=s,await e.chatAPI.updateConversation(a);const r=e.selectedConversationId;await L(e);const l=c.conversationsContainer.querySelector(`[data-id='${r}']`);l&&setTimeout(()=>{l.click(),l.scrollIntoView({block:"nearest"})},0)}}}),c.deleteConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null&&confirm("Are you sure you want to delete this conversation?")){let a=await e.chatAPI.getConversations();a.reverse();const s=a.findIndex(d=>d.id===e.selectedConversationId);await e.chatAPI.deleteConversation(e.selectedConversationId);let r=await e.chatAPI.getConversations();if(r.reverse(),r.length>0){let d=s;d>=r.length&&(d=r.length-1),await e.chatAPI.switchConversation(r[d].id)}else await e.chatAPI.addConversation({name:"New Conversation",timestamp:Date.now()});const l=await e.chatAPI.getMessages();e.chatView.renderMessages(l),await L(e),P(e.chatAPI)}}),c.compressConversationBtn.addEventListener("click",async()=>{if(e.compressionController){e.compressionController.abort(),e.compressionController=null,c.compressConversationBtn.textContent="ðŸ“¦";return}if(e.selectedConversationId!==null){const a=e.chatAPI.getCurrentModel();if(confirm(`Are you sure you want to compress this conversation using ${a.modelName} (${a.nickname})?`)){e.compressionController=new AbortController;const s=e.compressionController.signal;c.compressConversationBtn.textContent="ðŸ“¦...";const r=(l,d)=>{c.compressConversationBtn.textContent=`ðŸ“¦ ${l}/${d}`};try{await e.chatAPI.compressConversation(e.selectedConversationId,r,s),await L(e)}catch(l){l.name!=="AbortError"?alert("Error compressing conversation: "+l.message):(alert("Compression cancelled."),await L(e))}finally{e.compressionController=null,c.compressConversationBtn.textContent="ðŸ“¦"}}}}),c.exportConversationBtn.addEventListener("click",async()=>{if(e.selectedConversationId!==null){const a=e.chatAPI.conversations.find(v=>v.id===e.selectedConversationId),s=await window.db.getMessages(e.selectedConversationId),r={...a,messages:s};let l=a.name;!l&&s.length>0&&(l=s[0].content.split(`
`)[0]);const d=l.replace(/[^a-z0-9]/gi,"_").toLowerCase(),u="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(r,null,2)),m=document.createElement("a");m.setAttribute("href",u),m.setAttribute("download",`${d}.json`),document.body.appendChild(m),m.click(),m.remove()}}),c.importConversationBtn.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.accept=".json",a.onchange=async s=>{const r=s.target.files[0],l=new FileReader;l.onload=async d=>{try{const u=d.target.result,m=JSON.parse(u);await window.db.importConversation(m),await L(e),alert("Conversation imported successfully!")}catch(u){alert("Error importing conversation: "+u.message)}},l.readAsText(r)},a.click()}),c.modelSelector.addEventListener("change",a=>{const s=a.target.value;if(s.startsWith("model_")){const r=parseInt(s.split("_")[1]);e.chatAPI.setCurrentModelIndex(r),P(e.chatAPI)}else if(s.startsWith("workflow_")){const r=s.substring(9);e.chatAPI.setCurrentWorkflow(r),c.tokenCountDisplay.textContent="Workflow"}}),c.settingsBtn.addEventListener("click",async()=>{we(e.chatAPI),D(e.chatAPI),await H(e),j("global"),c.settingsModal.classList.remove("hidden")}),c.settingsTabs.addEventListener("click",a=>{const s=a.target.closest("button");s&&s.dataset.tab&&j(s.dataset.tab)}),c.closeSettingsBtn.addEventListener("click",()=>{c.settingsModal.classList.add("hidden")}),c.addModelBtn.addEventListener("click",()=>{e.chatAPI.addModel({modelName:"gemini-2.5-flash-lite",nickname:"New Model",temperature:.7,system_prompt:"You are a helpful assistant.",maxOutputTokens:8192}),D(e.chatAPI)}),c.addApiKeyBtn.addEventListener("click",()=>{G()}),c.saveSettingsBtn.addEventListener("click",async a=>{a.preventDefault();const s=Array.from(document.querySelectorAll(".api-key-input")).map(d=>d.value.trim()).filter(d=>d),r=c.proxyUrl.value.trim();e.chatAPI.saveGlobalSettings({apiKeys:s,proxy:r});const l=Array.from(c.llmConfigsContainer.children).map(d=>({modelName:d.querySelector('input[placeholder="Model Name"]').value,nickname:d.querySelector('input[placeholder="Nickname"]').value,temperature:parseFloat(d.querySelector('input[placeholder="Temperature"]').value),maxOutputTokens:parseInt(d.querySelector('input[placeholder="Max Output Tokens"]').value,10),system_prompt:d.querySelector("textarea").value,useGoogleSearch:d.querySelector('input[id^="google-search-checkbox-"]').checked,useUrlContext:d.querySelector('input[id^="url-context-checkbox-"]').checked,prependSystemPrompt:d.querySelector('input[id^="prepend-system-prompt-checkbox-"]').checked,thinkingBudget:parseInt(d.querySelector('input[placeholder="Thinking Budget (tokens)"]').value,10)}));await e.chatAPI.saveModels(l),await O(e.chatAPI),c.settingsModal.classList.add("hidden"),e.chatAPI.currentWorkflowId?c.tokenCountDisplay.textContent="Workflow":P(e.chatAPI)}),c.addWorkflowBtn.addEventListener("click",()=>{z(e,null)}),c.workflowEditorCancelBtn.addEventListener("click",()=>{c.workflowEditorOverlay.classList.add("hidden")}),c.workflowEditorSaveBtn.addEventListener("click",async()=>{const a=c.workflowNameInput.value.trim(),s=c.workflowScriptInput.value.trim();if(!a||!s){alert("Workflow Name and Script cannot be empty.");return}const r={name:a,script:s};e.editingWorkflowId?(r.id=e.editingWorkflowId,await window.db.updateWorkflow(r)):await window.db.addWorkflow(r),c.workflowEditorOverlay.classList.add("hidden"),await H(e),await O(e.chatAPI)}),c.attachFileBtn.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.multiple=!0,a.addEventListener("change",s=>{const r=s.target.files;for(let l=0;l<r.length;l++){const d=r[l],u=new FileReader;u.onload=m=>{e.attachedFiles.push({name:d.name,type:d.type,data:m.target.result}),N(e)},u.readAsDataURL(d)}}),a.click()}),c.sendBtn.addEventListener("click",async()=>{const a=c.messageInput.value.trim();if(!a&&e.attachedFiles.length===0)return;if(e.editingMessageId!==null){const l=await e.chatAPI.updateMessage(e.editingMessageId,a,e.attachedFiles);e.chatView.editMessage(l),e.editingMessageId=null,c.cancelEditBtn.classList.add("hidden"),c.sendBtn.textContent="â–¶ï¸",c.messageInput.value="",e.attachedFiles=[],N(e);return}const s={sender:"User",content:a,files:e.attachedFiles},r=await e.chatAPI.addMessage(s);if(e.chatView.appendMessage(r),c.messageInput.value="",e.attachedFiles=[],N(e),c.sendBtn.disabled=!0,e.chatAPI.currentWorkflowId){const l="temp-"+Date.now();e.chatView.appendMessage({sender:"Assistant",content:"Starting workflow...",id:l},!0);try{const u=(await window.db.getWorkflows()).find(g=>g.id===e.chatAPI.currentWorkflowId);if(!u)throw new Error("Selected workflow not found.");const m=new U(e.chatAPI),v=g=>Y(l,g),C=await m.execute(u.script,a,v);e.chatView.removeMessage(l);const p=await e.chatAPI.addMessage({sender:"Assistant",content:C});e.chatView.appendMessage(p)}catch(d){e.chatView.removeMessage(l);const u={sender:"Error",content:d.message,id:Date.now()};e.chatView.appendMessage(u)}finally{c.sendBtn.disabled=!1}}else{const l={sender:"Assistant",content:"...",id:-1};e.chatView.appendMessage(l);try{const d=await e.chatAPI.sendMessage(await e.chatAPI.getMessages());e.chatView.removeMessage(-1),d&&e.chatView.appendMessage(d)}catch(d){e.chatView.removeMessage(-1);const u={sender:"Error",content:`An error occurred: ${d.message}`,id:Date.now()};e.chatView.appendMessage(u)}finally{c.sendBtn.disabled=!1,P(e.chatAPI)}}}),c.cancelEditBtn.addEventListener("click",()=>{c.messageInput.value="",e.attachedFiles=[],e.editingMessageId=null,N(e),c.cancelEditBtn.classList.add("hidden"),c.sendBtn.textContent="â–¶ï¸"}),c.messageInput.addEventListener("keydown",a=>{a.ctrlKey&&a.key==="Enter"&&(a.preventDefault(),c.sendBtn.click())});let t=!1;const o=a=>{t=!0,document.body.style.userSelect="none",document.body.style.cursor="row-resize"},n=a=>{if(t){const s=a.clientY||a.touches&&a.touches[0].clientY;if(s===void 0)return;let r=window.innerHeight-s;const l=e.initialFooterHeight+c.attachedFilesContainer.offsetHeight,d=500;r<l&&(r=l),r>d&&(r=d),c.footer.style.height=`${r}px`}},i=()=>{t=!1,document.body.style.userSelect="",document.body.style.cursor=""};c.resizeHandle.addEventListener("mousedown",o),document.addEventListener("mousemove",n),document.addEventListener("mouseup",i),c.resizeHandle.addEventListener("touchstart",o,{passive:!0}),document.addEventListener("touchmove",n),document.addEventListener("touchend",i),c.clearChatBtn.addEventListener("click",async()=>{confirm("Are you sure you want to clear the chat?")&&(await e.chatAPI.clearMessages(),e.chatView.clear(),P(e.chatAPI))}),c.exportSettingsBtn.addEventListener("click",()=>{const a=e.chatAPI.getModels(),s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(a,null,2)),r=document.createElement("a");r.setAttribute("href",s),r.setAttribute("download","gemini-chat-settings.json"),document.body.appendChild(r),r.click(),r.remove()}),c.importSettingsBtn.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.accept=".json",a.onchange=async s=>{const r=s.target.files[0],l=new FileReader;l.onload=async d=>{try{const u=d.target.result,m=JSON.parse(u);await e.chatAPI.saveModels(m),await D(e.chatAPI),await O(e.chatAPI),alert("Settings imported successfully!")}catch(u){alert("Error importing settings: "+u.message)}},l.readAsText(r)},a.click()})}document.addEventListener("DOMContentLoaded",async()=>{const e={attachedFiles:[],editingMessageId:null,selectedMessage:null,selectedConversationId:null,initialFooterHeight:c.footer.offsetHeight,compressionController:null,chatView:new window.ChatView(c.chatContainer),chatAPI:window.chatAPI};fe(e),await e.chatAPI.init(),e.chatAPI.getCurrentModel()||(c.sendBtn.disabled=!0),await O(e.chatAPI);const o=await e.chatAPI.getMessages();e.chatView.renderMessages(o),e.chatAPI.currentWorkflowId?c.tokenCountDisplay.textContent="Workflow":P(e.chatAPI),N(e)});
